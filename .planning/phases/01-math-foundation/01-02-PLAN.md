---
phase: 01-math-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - components/exams/KaTeXRenderer.tsx
  - components/exams/MathRenderer.tsx
  - components/exams/SegmentedMathField.tsx
  - app/globals.css
  - package.json
autonomous: true

must_haves:
  truths:
    - "Math displays identically in editor preview and MathRenderer"
    - "Math displays identically in student answer review"
    - "Rendering completes in under 100ms per expression"
    - "No visual differences between editor and display surfaces"
  artifacts:
    - path: "components/exams/KaTeXRenderer.tsx"
      provides: "KaTeX-based math rendering component"
      exports: ["KaTeXRenderer", "renderLatexToString"]
    - path: "components/exams/MathRenderer.tsx"
      provides: "Updated to use KaTeX instead of MathJax"
      exports: ["default"]
  key_links:
    - from: "components/exams/MathRenderer.tsx"
      to: "components/exams/KaTeXRenderer.tsx"
      via: "imports KaTeXRenderer for math segments"
      pattern: "import.*KaTeXRenderer"
    - from: "components/exams/SegmentedMathField.tsx"
      to: "components/exams/KaTeXRenderer.tsx"
      via: "uses KaTeXRenderer for preview chips"
      pattern: "KaTeXRenderer"
---

<objective>
Replace MathJax with KaTeX for consistent, fast math rendering across all display surfaces.

Purpose: Research identified KaTeX as the standard choice (10x faster than MathJax, consistent rendering). Current MathRenderer uses MathJax which causes rendering inconsistencies with MathLive editor. MATH-05 requires visual parity across editor, review, and PDF export.

Output: KaTeXRenderer component and updated MathRenderer using KaTeX. All math displays consistently regardless of where it appears.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/phases/01-math-foundation/01-01-SUMMARY.md

# Current implementation for reference
@components/exams/MathRenderer.tsx
@components/exams/SegmentedMathField.tsx
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install KaTeX and create KaTeXRenderer component</name>
  <files>package.json, components/exams/KaTeXRenderer.tsx</files>
  <action>
1. Install KaTeX package:
   ```bash
   npm install katex
   ```

2. Create KaTeXRenderer component at components/exams/KaTeXRenderer.tsx:

Props interface:
- latex: string - the LaTeX to render
- displayMode?: boolean - block (true) vs inline (false, default)
- className?: string - additional CSS classes
- errorColor?: string - color for error messages (default: '#cc0000')
- throwOnError?: boolean - whether to throw on invalid LaTeX (default: false)

Implementation:
- Use 'use client' directive (client component for DOM manipulation)
- Import katex and katex/dist/katex.min.css
- Use useRef for the container element
- Use useEffect to call katex.render() when latex changes
- Handle errors gracefully: show original LaTeX in error color if throwOnError is false
- Return a span (inline) or div (display) with ref attached

Export two items:
- KaTeXRenderer: React component for JSX usage
- renderLatexToString: (latex: string, displayMode?: boolean) => string
  - Uses katex.renderToString() for server-side or string output
  - This will be needed for PDF export in Phase 5

Configuration options to pass to KaTeX:
- displayMode: from prop
- throwOnError: from prop
- errorColor: from prop
- strict: false (allow minor LaTeX errors)
- trust: true (allow certain commands)
- output: 'html' (not 'mathml')
- macros: {} (can add common macros later)

Handle MathLive placeholder syntax:
- Before rendering, strip \\placeholder{...} and replace with empty box: \\square
- This ensures preview works even with templates

3. Add CSS import to globals.css:
   Add at top of file: @import 'katex/dist/katex.min.css';
   (Or handle via Next.js if CSS imports don't work in globals)

Test the component in isolation before integrating.
  </action>
  <verify>
KaTeX installed: `npm list katex` shows katex@0.16.x
Component file exists at components/exams/KaTeXRenderer.tsx
TypeScript compiles: `npx tsc --noEmit components/exams/KaTeXRenderer.tsx`
  </verify>
  <done>
KaTeXRenderer component created with both JSX component and renderToString function exported. KaTeX CSS imported in globals.css.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MathRenderer to use KaTeX</name>
  <files>components/exams/MathRenderer.tsx</files>
  <action>
Refactor MathRenderer to use KaTeX instead of MathJax:

1. Remove all MathJax-related code:
   - Remove MathJaxObject and MathJaxWindow types
   - Remove ensureMathJax() function
   - Remove MathJax script loading
   - Remove formatLatexForMathJax() function
   - Remove stripMathDelimiters() - replace with simpler version

2. Import KaTeXRenderer:
   ```tsx
   import { KaTeXRenderer } from './KaTeXRenderer'
   ```

3. Simplify the rendering logic:
   - For ContentSegment[] input: iterate segments, render math segments with KaTeXRenderer
   - For string input with $...$ delimiters: parse and render each math portion
   - Keep table and graph rendering logic unchanged

4. Update the segment rendering:
   - text segments: render as text nodes (unchanged)
   - math segments: render with <KaTeXRenderer latex={segment.latex} />
   - table/graph segments: keep existing logic

5. Simplify the component:
   - Remove refs for timeouts and rendering state
   - Remove async rendering logic
   - KaTeX is synchronous - much simpler code

6. Handle display mode:
   - Inline math (within text): displayMode={false}
   - Block math (standalone): displayMode={true} if segment is alone or has specific marker

7. Keep the existing props interface:
   - text: string | ContentSegment[]
   - className?: string
   - tableScale?: number | 'fit'

8. Preserve legacy HTML handling:
   - Keep legacyMathHtmlToLatex import and usage for old data

The goal is dramatic simplification: MathJax async loading/rendering replaced by synchronous KaTeX calls.
  </action>
  <verify>
Run `npm run dev`
Navigate to /test-math-editor
Type math in editor, verify it displays correctly below (if there's a preview)
Check browser console for errors
  </verify>
  <done>
MathRenderer uses KaTeX for all math rendering. No MathJax code remains. Rendering is synchronous and fast.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update SegmentedMathField preview to use KaTeX</name>
  <files>components/exams/SegmentedMathField.tsx</files>
  <action>
Update the math chip preview in SegmentedMathField to use KaTeX instead of MathJax:

1. Replace InlineMath component:
   The current InlineMath uses MathJax. Replace with KaTeXRenderer:

   ```tsx
   function InlineMath({ latex, id }: { latex: string; id: string }) {
     return (
       <KaTeXRenderer
         latex={latex || '\\square'}
         displayMode={false}
         className="math-chip-content"
       />
     )
   }
   ```

   Or simply remove InlineMath and use KaTeXRenderer directly where InlineMath was used.

2. Update imports:
   - Add: import { KaTeXRenderer } from './KaTeXRenderer'
   - Remove: MathJaxObject, MathJaxWindow types (if no longer needed elsewhere)

3. Keep InlineMathEditor unchanged:
   - The editor still uses MathLive for WYSIWYG editing
   - Only the preview chip display changes to KaTeX

4. Update math chip rendering:
   Find where math segments are rendered as chips (likely in the main render function).
   Ensure they use KaTeXRenderer instead of InlineMath.

5. Remove MathJax dependencies:
   - Remove any MathJax type definitions if no longer used
   - Remove any MathJax loading/initialization code
   - Keep the file working - don't break graph/table functionality

6. Test the visual parity:
   - Math in MathLive editor should look similar to KaTeX preview
   - Both use similar fonts (Latin Modern Math / KaTeX fonts)
   - No jarring differences when confirming edits

7. Handle placeholder display:
   - In edit mode (InlineMathEditor open): show MathLive
   - In view mode (chip): show KaTeX preview
   - For templates with placeholders: strip placeholders before KaTeX render
  </action>
  <verify>
Run `npm run dev`
Navigate to /test-math-editor
Create a math segment with fraction
Confirm the edit popup
Verify the chip preview shows correctly rendered fraction
Verify no MathJax script loads (check Network tab)
  </verify>
  <done>
SegmentedMathField uses KaTeX for math chip preview. Visual parity between edit mode (MathLive) and view mode (KaTeX). No MathJax code remains in the component.
  </done>
</task>

</tasks>

<verification>
1. Visual parity test:
   - Go to /test-math-editor
   - Create a math segment with: x^2 + \frac{1}{2}
   - Compare rendering in:
     a) MathLive editor (while editing)
     b) KaTeX chip preview (after confirming)
     c) MathRenderer output (if visible elsewhere)
   - All three should look identical or nearly identical

2. Performance test:
   - Create 10+ math segments
   - Page should remain responsive
   - No visible rendering delay

3. No MathJax:
   - Check Network tab: no MathJax CDN requests
   - Check page source: no MathJax scripts

4. Error handling:
   - Enter invalid LaTeX: \frac{incomplete
   - Should display gracefully (error message or original text), not crash

5. Existing functionality preserved:
   - Text editing works
   - Table editing works (if enabled)
   - Graph editing works (if enabled)
   - Math editing works (create, edit, delete)

6. All tests pass: `npm test`
7. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
1. Equation entered in MathLive displays identically in answer review (MATH-05)
2. Math renders in under 100ms per expression (KaTeX target: <100ms)
3. No MathJax code or CDN requests remain
4. Error handling for invalid LaTeX (graceful degradation)
5. All existing math editing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/01-math-foundation/01-02-SUMMARY.md`
</output>
