---
phase: 01-math-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/exams/MathToolbar.tsx
  - components/exams/MathEditor.tsx
  - components/exams/SegmentedMathField.tsx
  - lib/math/symbols.ts
autonomous: true

must_haves:
  truths:
    - "Student can insert fractions via button click without seeing LaTeX"
    - "Student can insert exponents and square roots via buttons"
    - "Student can insert Greek letters from a visible palette"
    - "Student can insert integrals/sums/limits with clickable placeholder positions"
    - "Math toolbar is always visible during editing (not a popup)"
  artifacts:
    - path: "components/exams/MathToolbar.tsx"
      provides: "Persistent toolbar with math symbol buttons"
      exports: ["MathToolbar"]
    - path: "lib/math/symbols.ts"
      provides: "Symbol definitions for all button categories"
      exports: ["mathSymbols", "symbolCategories"]
  key_links:
    - from: "components/exams/MathToolbar.tsx"
      to: "components/exams/SegmentedMathField.tsx"
      via: "onInsert callback passed as prop"
      pattern: "onInsert\\("
    - from: "components/exams/MathToolbar.tsx"
      to: "lib/math/symbols.ts"
      via: "imports symbol definitions"
      pattern: "import.*from.*lib/math/symbols"
---

<objective>
Create a persistent math toolbar with button-based symbol insertion for MathLive editor.

Purpose: Students need to input mathematical expressions using only buttons (no visible LaTeX). Current MathEditor is a popup picker - need a persistent toolbar that integrates with the editing experience.

Output: MathToolbar component with categorized symbol buttons that insert LaTeX into the active MathLive field.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md

# Existing math components for reference
@components/exams/MathEditor.tsx
@components/exams/SegmentedMathField.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create symbol definitions library</name>
  <files>lib/math/symbols.ts</files>
  <action>
Create a centralized symbol definitions file with the following structure:

1. Define symbol categories matching requirements:
   - basic: +, -, x, /, =, (, )
   - fractions: fraction template with placeholders
   - powers: exponent, subscript, square/cube root
   - greek: alpha, beta, gamma, delta, epsilon, theta, pi, sigma, omega (lowercase and uppercase)
   - calculus: integrals (definite/indefinite), sums, products, limits with placeholder positions
   - relations: less than, greater than, less/greater or equal, not equal, approximately
   - sets: subset, superset, union, intersection, element of, natural/integer/real numbers

2. Each symbol should have:
   - label: visual representation for button
   - latex: LaTeX code to insert (use MathLive placeholder syntax: #@ for current position, #0 for next position)
   - category: which group it belongs to
   - tooltip: description for accessibility

3. Export:
   - mathSymbols: Record of category -> symbol[]
   - symbolCategories: array of category metadata (name, icon, label for fr/en)
   - getSymbolsByCategory(category): helper function

Use MathLive's placeholder syntax for templates:
- Fraction: \\frac{#@}{#0} (cursor in numerator, tab to denominator)
- Integral: \\int_{#@}^{#0} (cursor in lower bound, tab to upper)
- Sum: \\sum_{#@}^{#0}
- Limit: \\lim_{#@ \\to #0}

Reference existing symbols from MathEditor.tsx but restructure for toolbar use.
  </action>
  <verify>
File exists at lib/math/symbols.ts and exports mathSymbols, symbolCategories.
TypeScript compiles without errors: `npx tsc --noEmit lib/math/symbols.ts`
  </verify>
  <done>
Symbol library contains all required categories (basic, fractions, powers, greek, calculus, relations, sets) with correct MathLive placeholder syntax.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MathToolbar component</name>
  <files>components/exams/MathToolbar.tsx</files>
  <action>
Create a persistent toolbar component for math symbol insertion:

1. Props interface:
   - onInsert: (latex: string) => void - callback to insert LaTeX into editor
   - disabled?: boolean
   - locale?: 'fr' | 'en'
   - size?: 'sm' | 'md' - toolbar button size
   - quickSymbols?: Symbol[] - optional override for quick-access symbols
   - showCategories?: boolean - whether to show category tabs (default true)

2. Layout design:
   - Horizontal toolbar with category tabs (icons) on top row
   - Symbol buttons grid below, showing active category's symbols
   - Quick-access row at top with most common symbols (fraction, sqrt, power, subscript, pi, integral)
   - Compact design that fits above the editor

3. UI implementation:
   - Use Tailwind for styling (match existing codebase patterns)
   - Category tabs: icon buttons with tooltips
   - Symbol buttons: display label, onClick calls onInsert(symbol.latex)
   - Hover states showing tooltip with symbol name
   - Active category highlighted
   - Quick-access buttons always visible

4. Category tabs use lucide-react icons:
   - basic: Calculator
   - fractions: Divide
   - powers: Superscript
   - greek: Type (or custom alpha icon)
   - calculus: Sigma
   - relations: Equal
   - sets: Layers

5. Greek palette should expand to show all Greek letters in a grid (similar to MathEditor's current implementation)

6. Import symbols from lib/math/symbols.ts

Do NOT modify SegmentedMathField.tsx in this task - integration is Task 3.
  </action>
  <verify>
Component exists and renders without errors.
Manual test: Import in test-math-editor/page.tsx, render toolbar, verify buttons display.
  </verify>
  <done>
MathToolbar renders category tabs and symbol grids, calls onInsert with correct LaTeX when buttons clicked.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate MathToolbar with SegmentedMathField</name>
  <files>components/exams/SegmentedMathField.tsx</files>
  <action>
Integrate MathToolbar into SegmentedMathField for persistent math input:

1. Add new props to SegmentedMathField:
   - showMathToolbar?: boolean (default true when showMathButton is true)
   - toolbarPosition?: 'top' | 'bottom' (default 'top')

2. Modify the component layout:
   - When showMathToolbar is true, render MathToolbar above the editor
   - Keep existing MathEditor popup as fallback/advanced option
   - Toolbar is always visible during editing (not a popup)

3. Create handleToolbarInsert function:
   - If currently editing a math segment (InlineMathEditor is open):
     - Use mathFieldRef.current.insert(latex) to insert at cursor
   - If not editing math:
     - Create new math segment with the inserted LaTeX
     - Focus the new math segment for further editing
   - Handle placeholder navigation (MathLive handles this automatically with insert())

4. Wire the toolbar:
   - Pass handleToolbarInsert to MathToolbar's onInsert prop
   - Pass disabled={disabled} to toolbar
   - Pass locale prop

5. Preserve existing behavior:
   - Calculator button in toolbar area opens full MathEditor popup (for advanced symbols)
   - Quick symbols from props still work
   - All existing math editing functionality unchanged

6. Test the flow:
   - User clicks fraction button -> new math segment created with fraction template
   - Cursor is in numerator placeholder
   - User types, presses Tab -> cursor moves to denominator
   - User clicks outside -> math segment saved

Keep the file changes minimal - only add toolbar integration, don't refactor existing code.
  </action>
  <verify>
Run the app: `npm run dev`
Navigate to /test-math-editor
Verify toolbar appears above editor
Click fraction button -> fraction template appears in editor
Click Greek alpha -> alpha appears in editor
  </verify>
  <done>
MathToolbar integrated with SegmentedMathField. Clicking toolbar buttons inserts math at cursor or creates new math segment. Placeholder navigation works (Tab between fraction numerator/denominator).
  </done>
</task>

</tasks>

<verification>
1. Run `npm run dev` and navigate to /test-math-editor
2. Verify MathToolbar is visible above the editor
3. Test each requirement:
   - MATH-01: Click buttons to insert symbols, no LaTeX visible to user
   - MATH-02: Click fraction button, see WYSIWYG fraction, Tab between positions
   - MATH-02: Click sqrt button, see square root symbol with placeholder
   - MATH-02: Click power button, cursor moves to exponent position
   - MATH-03: Click Greek tab, see palette, click alpha, alpha inserted
   - MATH-04: Click integral button, see integral with bound placeholders, Tab between positions
   - MATH-04: Click sum button, same behavior
   - MATH-04: Click limit button, same behavior
4. No TypeScript errors: `npx tsc --noEmit`
5. Existing tests pass: `npm test`
</verification>

<success_criteria>
1. Student can type a fraction by clicking the fraction button without seeing LaTeX syntax
2. Student can insert Greek letters from a visible palette
3. Student can create an integral with upper/lower bounds by clicking placeholder positions
4. Math toolbar loads instantly (no async load delay)
5. Toolbar buttons are responsive and provide visual feedback
</success_criteria>

<output>
After completion, create `.planning/phases/01-math-foundation/01-01-SUMMARY.md`
</output>
