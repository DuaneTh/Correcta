---
phase: 08-pdf-exam-import
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - components/exam-import/PDFImportUploader.tsx
  - app/dashboard/exams/new/page.tsx
  - package.json
autonomous: false

must_haves:
  truths:
    - "Teacher can drag-and-drop or click to select a PDF file for import"
    - "Teacher sees progress indicator during upload and AI analysis"
    - "Teacher is automatically redirected to exam editor when import completes"
    - "Teacher sees clear error messages if import fails"
    - "Import option is accessible from exam creation flow"
  artifacts:
    - path: "components/exam-import/PDFImportUploader.tsx"
      provides: "Drag-and-drop PDF upload with progress tracking and polling"
      min_lines: 80
    - path: "app/dashboard/exams/new/page.tsx"
      provides: "Exam creation page with PDF import option added"
  key_links:
    - from: "components/exam-import/PDFImportUploader.tsx"
      to: "/api/exam-import/upload"
      via: "fetch POST with FormData"
      pattern: "fetch.*api/exam-import/upload"
    - from: "components/exam-import/PDFImportUploader.tsx"
      to: "/api/exam-import/status"
      via: "polling fetch GET"
      pattern: "fetch.*api/exam-import/status"
    - from: "components/exam-import/PDFImportUploader.tsx"
      to: "next/navigation"
      via: "router.push to exam editor on completion"
      pattern: "router\\.push.*edit|builder"
---

<objective>
Create the PDF import UI: react-dropzone upload component with progress tracking, polling for job completion, and automatic redirect to exam editor. Integrate into exam creation flow.

Purpose: This is the teacher-facing feature that makes PDF import accessible. Teachers drag-and-drop a PDF and land in the exam editor with pre-filled questions, completing the full IMPORT-01 and IMPORT-05 requirements.

Output: A polished upload component using UI Kit components and react-dropzone, integrated into the existing exam creation page.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-pdf-exam-import/08-RESEARCH.md
@.planning/phases/08-pdf-exam-import/08-01-SUMMARY.md
@.planning/phases/08-pdf-exam-import/08-02-SUMMARY.md

# Pattern references
@app/dashboard/exams/new/page.tsx
@components/exam-editor/store.ts
@lib/csrfClient.ts
@lib/fetchJsonWithCsrf.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-dropzone and create PDFImportUploader component</name>
  <files>package.json, components/exam-import/PDFImportUploader.tsx</files>
  <action>
Install react-dropzone: `npm install react-dropzone`

Create `components/exam-import/PDFImportUploader.tsx` as a 'use client' component:

Props interface:
- `courseId: string` - the course to create the exam in
- `onCancel?: () => void` - optional callback to hide the uploader

State:
- `status`: 'idle' | 'uploading' | 'processing' | 'completed' | 'failed'
- `error`: string | null
- `progress`: string (human-readable progress message in French)
- `warnings`: string[] (extraction warnings to show on completion)

Implementation:
1. Use `useDropzone` from react-dropzone with:
   - accept: { 'application/pdf': ['.pdf'] }
   - maxFiles: 1
   - maxSize: 32 * 1024 * 1024
   - disabled: status !== 'idle'
   - onDropRejected: set error message for file-too-large or invalid-type
   - onDrop: trigger upload flow

2. Upload flow (async):
   a. Set status 'uploading', progress 'Televersement du PDF...'
   b. Create FormData with file and courseId
   c. POST to '/api/exam-import/upload' using `fetchJsonWithCsrf` or manual fetch with CSRF header from `getCsrfToken()` (check which pattern is used in the codebase -- use `fetchJsonWithCsrf` if it exists, otherwise use getCsrfToken from lib/csrfClient.ts and set X-CSRF-Token header). NOTE: since this is FormData (not JSON), you may need to use regular fetch with the CSRF header manually.
   d. On success, get jobId from response
   e. Set status 'processing', progress 'Analyse IA en cours... Cela peut prendre 10-30 secondes'
   f. Start polling

3. Polling:
   - Poll GET /api/exam-import/status/{jobId} every 2 seconds
   - On 'completed': set status 'completed', store examId, after 500ms redirect to `/dashboard/exams/${examId}/builder`
   - On 'failed': set status 'failed', set error from response
   - On 'processing': continue polling
   - Use setTimeout for polling, clear on unmount via useEffect cleanup

4. UI using UI Kit components (Surface, Stack, Text, Button, Badge from @/components/ui/*):
   - Idle state: Surface with dashed border, icon (upload cloud or document icon via emoji-free SVG or text), "Importer un examen existant" heading, "Glissez-deposez un PDF ou cliquez pour selectionner" subtitle, "Maximum 32 Mo" hint
   - Drag active state: blue border highlight, "Deposez le fichier PDF ici"
   - Uploading state: spinner/loading indicator, progress message
   - Processing state: spinner, "Analyse IA en cours..." with note about 10-30s wait
   - Completed state: success message, "Redirection vers l'editeur..."
   - Failed state: error message in red Surface, retry button that resets to idle
   - If warnings exist from extraction, show them as amber Badge items

5. Styling: Use Tailwind classes. Dropzone area should be visually distinct (dashed border, hover state, drag-active highlight). Match existing UI patterns.

Use `useRouter` from 'next/navigation' for redirect.
  </action>
  <verify>
`npm run build` passes (or `npx tsc --noEmit`). Component file exists. react-dropzone is in package.json dependencies.
  </verify>
  <done>
PDFImportUploader component renders drag-and-drop zone, handles upload with CSRF, polls for status, shows progress states in French, redirects to editor on completion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate PDF import into exam creation flow</name>
  <files>app/dashboard/exams/new/page.tsx</files>
  <action>
Modify `app/dashboard/exams/new/page.tsx` to add a PDF import option:

Current page shows ExamEditor for creating a new exam from scratch. Add an alternative path:

1. Create a client wrapper component (either inline or extract) that shows two options:
   - "Creer un examen" (existing flow) - shows ExamEditor
   - "Importer depuis un PDF" - shows PDFImportUploader

2. Implementation approach: Create a new client component `NewExamPageClient` that receives the courses prop. It has state `mode: 'choose' | 'create' | 'import'`:
   - 'choose': shows two cards/buttons side by side - "Creer de zero" and "Importer un PDF existant"
   - 'create': renders existing ExamEditor with courses prop
   - 'import': shows a course selector dropdown (since we need courseId for the import) then PDFImportUploader with selected courseId

3. The server component page.tsx stays mostly the same but renders NewExamPageClient instead of ExamEditor directly.

4. For the course selector in import mode: simple select dropdown with courses, once selected show PDFImportUploader. Include a "Retour" button to go back to mode chooser.

5. Style the choice cards using Surface from UI Kit. Each card: icon/illustration area, title, subtitle explaining the option. Hover effect.

Keep it simple. The key UX is: teacher arrives at "new exam" page, sees two clear options, picks import, selects course, uploads PDF, gets redirected to editor.
  </action>
  <verify>
`npx tsc --noEmit` passes. Navigate to /dashboard/exams/new in dev and verify the page renders without errors (two option cards visible).
  </verify>
  <done>
Exam creation page shows choice between "create from scratch" and "import from PDF". Import flow: select course -> upload PDF -> progress -> redirect to editor. Existing "create from scratch" flow preserved unchanged.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete PDF exam import feature: upload UI with drag-and-drop, AI analysis via GPT-4o, automatic exam creation in database, redirect to exam editor with pre-filled questions.</what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Start the PDF import worker: `npx tsx scripts/pdf-import-worker.ts`
3. Navigate to /dashboard/exams/new
4. Verify two options appear: "Create from scratch" and "Import from PDF"
5. Click "Import from PDF"
6. Select a course from the dropdown
7. Upload a test PDF exam document (drag-and-drop or click)
8. Verify progress indicator shows during upload and AI analysis
9. Wait for redirect to exam editor (10-30 seconds)
10. Verify questions are pre-filled in the editor
11. Verify you can modify, reorder, and delete imported questions
12. Test error cases: upload a non-PDF file, upload without selecting course
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. react-dropzone in package.json dependencies
3. PDFImportUploader renders dropzone, handles upload, polls, redirects
4. New exam page shows import option alongside create-from-scratch
5. Full flow works: upload PDF -> AI analysis -> exam created -> editor opens with questions
</verification>

<success_criteria>
- IMPORT-01: PDF upload in exam creation flow works (drag-and-drop + file picker)
- IMPORT-05: Teacher lands in standard exam editor with pre-filled questions
- Teacher can modify all imported questions freely (full editor functionality preserved)
- Progress indicator visible during 10-30s AI analysis
- Error states handled gracefully (non-PDF, too large, AI failure)
- UI text in French matching application language
</success_criteria>

<output>
After completion, create `.planning/phases/08-pdf-exam-import/08-03-SUMMARY.md`
</output>
