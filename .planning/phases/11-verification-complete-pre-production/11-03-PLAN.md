---
phase: 11-verification-complete-pre-production
plan: 03
type: execute
wave: 2
depends_on: ["01", "04", "05"]
files_modified:
  - app/error.tsx
  - app/not-found.tsx
  - app/student/error.tsx
  - app/teacher/error.tsx
  - app/admin/error.tsx
  - app/student/attempts/[attemptId]/error.tsx
  - app/teacher/exams/[examId]/edit/error.tsx
autonomous: true

must_haves:
  truths:
    - "Any unhandled runtime error shows a user-friendly error page, not a white screen"
    - "Invalid URLs show a styled 404 page with navigation back to home"
    - "API errors return appropriate HTTP status codes with consistent error response format"
    - "Empty data states (no courses, no exams, no students) show EmptyState component"
    - "Loading states are present for data-fetching pages"
  artifacts:
    - path: "app/error.tsx"
      provides: "Global error boundary"
      exports: ["default"]
    - path: "app/not-found.tsx"
      provides: "Custom 404 page"
      exports: ["default"]
    - path: "app/student/error.tsx"
      provides: "Student section error boundary"
      exports: ["default"]
    - path: "app/teacher/error.tsx"
      provides: "Teacher section error boundary"
      exports: ["default"]
  key_links:
    - from: "app/error.tsx"
      to: "components/ui/Button.tsx"
      via: "Reset and home navigation buttons"
      pattern: "Button"
---

<objective>
Add missing Next.js error boundaries, loading states, and 404 pages — then audit all pages for proper empty state handling and edge case resilience.

Purpose: Ensure the application never shows a white screen, cryptic error, or missing content indicator to users.
Output: Error boundaries at key route segments, custom 404 page, loading states for slow pages, and EmptyState components for all data-dependent views.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@components/ui/Button.tsx
@components/ui/Card.tsx
@components/ui/EmptyState.tsx
@components/ui/Text.tsx
@components/ui/Layout.tsx
@lib/i18n/dictionaries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Next.js error boundaries and custom 404 page</name>
  <files>
    app/error.tsx
    app/not-found.tsx
    app/student/error.tsx
    app/teacher/error.tsx
    app/admin/error.tsx
    app/student/attempts/[attemptId]/error.tsx
    app/teacher/exams/[examId]/edit/error.tsx
  </files>
  <action>
Create Next.js error boundary and not-found files using UI Kit components and i18n dictionary.

**1. Global Error Boundary: `app/error.tsx`**
- Must be a Client Component (`'use client'`)
- Props: `{ error: Error & { digest?: string }; reset: () => void }`
- Display: Centered card with error icon, user-friendly message, and two buttons:
  - "Try Again" button (calls `reset()`)
  - "Go Home" button (navigates to `/`)
- Use UI Kit: `Button`, `Card`, `Text` components
- Style: Clean, centered, minimal — not frightening to students mid-exam
- Message should be bilingual: Read locale from cookie or default to French
  - FR: "Une erreur est survenue" / "Veuillez réessayer ou revenir à l'accueil"
  - EN: "An error occurred" / "Please try again or go back to the home page"

**2. Custom 404 Page: `app/not-found.tsx`**
- Server Component (can read cookies for locale)
- Display: Centered card with "Page non trouvée" / "Page not found"
- Include "Go Home" button
- Use UI Kit components

**3. Section Error Boundaries:**
Create error.tsx for each role section (student, teacher, admin):
- `app/student/error.tsx` — same pattern, "Go to courses" button links to `/student/courses`
- `app/teacher/error.tsx` — "Go to courses" button links to `/teacher/courses`
- `app/admin/error.tsx` — "Go to dashboard" button links to admin dashboard

**4. Critical Route Error Boundaries:**
- `app/student/attempts/[attemptId]/error.tsx` — CRITICAL: Exam taking errors must provide a way to retry or go back to exam list. Show reassuring message that answers are saved (autosave).
  - FR: "Vos réponses ont été sauvegardées automatiquement. Veuillez réessayer."
  - EN: "Your answers have been saved automatically. Please try again."
- `app/teacher/exams/[examId]/edit/error.tsx` — Exam editor errors should link back to exam list.

All error boundaries must:
- Use `'use client'` directive
- Import from `@/components/ui/`
- Log the error to console.error for debugging
- NOT display the raw error message to users (security)
- Provide clear recovery actions
  </action>
  <verify>
Verify all error.tsx files exist. Verify each exports a default function with correct props. Verify not-found.tsx exists. Run `npx tsc --noEmit`.
  </verify>
  <done>Global error boundary, custom 404, section-level error boundaries, and critical route error boundaries all created. Each uses UI Kit and provides bilingual recovery actions.</done>
</task>

<task type="auto">
  <name>Task 2: Audit empty states and add loading indicators</name>
  <files>
    app/student/**/*.tsx
    app/teacher/**/*.tsx
    app/admin/**/*.tsx
  </files>
  <action>
**Empty State Audit:**
Check every page that displays a list of data for proper empty state handling:

Pages to audit (each should handle zero-data case):
1. `app/student/courses/StudentCoursesClient.tsx` — No enrolled courses
2. `app/student/exams/StudentExamsClient.tsx` — No available exams
3. `app/teacher/courses/TeacherCoursesClient.tsx` — No courses assigned
4. `app/teacher/exams/page.tsx` — No exams created
5. `app/teacher/corrections/page.tsx` — No corrections pending
6. `app/admin/school/users/SchoolUsersClient.tsx` — No users
7. `app/admin/school/classes/SchoolClassesClient.tsx` — No classes
8. `app/admin/school/enrollments/SchoolEnrollmentsClient.tsx` — No enrollments
9. `app/admin/InstitutionsClient.tsx` — No institutions (platform admin)

For each page:
- If data array is empty, verify `<EmptyState>` component is rendered with:
  - Appropriate title from i18n dictionary
  - Optional action button (e.g., "Create first exam")
- If using a custom empty div instead of EmptyState, replace with `<EmptyState>`
- If NO empty state handling exists at all, add it

**Loading State Audit:**
Check pages that fetch data for loading indicators:
- Client components using `useState` for data: Should show a loading spinner or skeleton while fetching
- Server components with `await` calls: Consider adding `loading.tsx` for heavy pages

Add `loading.tsx` for the heaviest pages if not already present:
- `app/student/loading.tsx` — Simple centered spinner
- `app/teacher/loading.tsx` — Simple centered spinner
- `app/admin/school/loading.tsx` — Simple centered spinner

Loading.tsx pattern:
```tsx
export default function Loading() {
  return (
    <div className="flex items-center justify-center min-h-[400px]">
      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-900" />
    </div>
  )
}
```

**Edge Case: Archived Resources**
Check that pages accessing resources by ID handle the case where the resource is archived:
- `app/teacher/courses/[courseId]/page.tsx` — What if courseId is archived?
- `app/student/attempts/[attemptId]/page.tsx` — What if attempt's exam is archived?
- These should show appropriate message or redirect, not crash

For each issue found, implement the fix.
  </action>
  <verify>
Grep for EmptyState usage across page components — should be present in all list views. Verify loading.tsx files exist in key route segments. Run `npx tsc --noEmit`.
  </verify>
  <done>All list views show EmptyState for zero-data. Loading states present for key route segments. Archived resource access handled gracefully. TypeScript compiles.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `app/error.tsx` exists and is a client component with reset/home buttons
3. `app/not-found.tsx` exists with bilingual 404 message
4. Section-level error boundaries exist for student, teacher, admin
5. Critical route error boundaries exist for exam taking and exam editor
6. All list-view pages show EmptyState when data is empty
7. Loading indicators present for key route segments
</verification>

<success_criteria>
- Runtime errors show user-friendly error page with recovery actions
- Invalid URLs show styled 404 page
- All list views handle empty data with EmptyState component
- Key route segments have loading.tsx files
- Archived resource access handled gracefully (not crash)
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/11-verification-complete-pre-production/11-03-SUMMARY.md`
</output>
