---
phase: 11-verification-complete-pre-production
plan: 02
type: execute
wave: 2
depends_on: [11-01, 11-04, 11-05]
files_modified:
  - app/student/**/*.tsx
  - app/teacher/**/*.tsx
  - app/admin/**/*.tsx
  - app/api/**/route.ts
autonomous: true

must_haves:
  truths:
    - "Student can browse courses, start exam, answer questions, submit, and view corrected results"
    - "Teacher can create exam with questions, publish, grade via AI, review, release results, and export"
    - "School admin can create courses, manage users, import CSV, manage sections and enrollments"
    - "Platform admin can create institutions, view dashboard, configure AI settings"
    - "Each role can ONLY access their own routes — cross-role access redirects or returns 403"
  artifacts:
    - path: "app/student/courses/page.tsx"
      provides: "Student course listing"
    - path: "app/teacher/courses/page.tsx"
      provides: "Teacher course listing"
    - path: "app/admin/school/page.tsx"
      provides: "School admin dashboard"
    - path: "app/admin/platform/page.tsx"
      provides: "Platform admin dashboard"
  key_links:
    - from: "app/student/courses/page.tsx"
      to: "app/api/attempts/route.ts"
      via: "Exam taking creates attempt"
      pattern: "api/attempts"
    - from: "app/teacher/exams/[examId]/edit/page.tsx"
      to: "lib/actions/exam-editor.ts"
      via: "Server actions for exam mutations"
      pattern: "exam-editor"
---

<objective>
Verify all end-to-end user flows work correctly for each role by auditing page components, API routes, and data flow — fixing any broken links, missing data fetches, incorrect redirects, or incomplete flows.

Purpose: Ensure every user role can complete their primary workflows without errors.
Output: All role-based flows verified and any broken paths fixed.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/api-auth.ts
@lib/attemptPermissions.ts
@lib/exam-permissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify student and teacher end-to-end flows</name>
  <files>
    app/student/**/*.tsx
    app/teacher/**/*.tsx
    app/api/attempts/**/route.ts
    app/api/exams/**/route.ts
    app/api/grades/**/route.ts
  </files>
  <action>
**Student Flow Audit:**
Trace the complete student flow through the codebase:

1. **Login → Courses** (`app/student/courses/page.tsx`, `StudentCoursesClient.tsx`)
   - Verify: Page checks session, fetches courses scoped to student's enrollments
   - Verify: Empty state shown when no courses
   - Verify: Link/navigation to individual course exams

2. **Courses → Exam List** (`app/student/exams/page.tsx`, `StudentExamsClient.tsx`)
   - Verify: Exams filtered by published status and student's enrolled courses
   - Verify: Start button appears only for available (not submitted) exams
   - Verify: Time-limited exams show countdown info

3. **Exam Taking** (`app/student/exams/[examId]/take/page.tsx`, `ExamStartPage.tsx`, `app/student/attempts/[attemptId]/ExamRoomClient.tsx`)
   - Verify: Creates attempt via API on start
   - Verify: Questions render correctly (text, MCQ, math, images)
   - Verify: Answer autosave works (2-second debounce)
   - Verify: Submit handler sends all answers and marks attempt as submitted
   - Verify: Timer auto-submit works for timed exams

4. **Results** (`app/student/attempts/[attemptId]/results/page.tsx`, `ResultsView.tsx`)
   - Verify: Only shows results after grades are published
   - Verify: Displays score, feedback, AI badges for each question
   - Verify: Math content renders in results view

**Teacher Flow Audit:**
Trace the complete teacher flow:

1. **Courses** (`app/teacher/courses/page.tsx`, `TeacherCoursesClient.tsx`)
   - Verify: Shows courses where teacher is assigned
   - Verify: Create exam button navigates correctly

2. **Exam Creation** (`app/teacher/exams/new/page.tsx`, `NewExamFormClient.tsx`)
   - Verify: Form creates exam and redirects to editor

3. **Exam Editor** (`app/teacher/exams/[examId]/edit/page.tsx`)
   - Verify: Loads exam data including questions and segments
   - Verify: Can add/edit/delete questions
   - Verify: Question types (TEXT, MCQ) work
   - Verify: Math toolbar integration functional
   - Verify: Image upload in questions works
   - Verify: Publish/unpublish toggle works

4. **Grading** (trace from corrections page through grading flow)
   - Verify: "Grade All" button triggers AI grading job
   - Verify: Progress tracking during batch grading
   - Verify: Individual grade edit modal works
   - Verify: Re-grade button works
   - Verify: Publication flow for releasing grades

5. **Export** (CSV and PDF)
   - Verify: CSV export fetches correct data and triggers download
   - Verify: PDF export enqueues job and polls for completion

For each broken link, missing data fetch, or incorrect redirect found: Fix it.
  </action>
  <verify>
Read each page in the flow and verify it imports from correct API routes/actions, handles loading/error states, and navigates correctly. Run `npx tsc --noEmit`.
  </verify>
  <done>Student flow (courses → exams → take → results) verified with no broken links. Teacher flow (courses → create → edit → grade → export) verified with no broken links. All API calls match existing routes.</done>
</task>

<task type="auto">
  <name>Task 2: Verify admin flows and cross-role access protection</name>
  <files>
    app/admin/**/*.tsx
    app/api/admin/**/route.ts
    app/api/institutions/**/route.ts
  </files>
  <action>
**School Admin Flow Audit:**
1. **Dashboard** (`app/admin/school/dashboard/page.tsx`, `SchoolDashboardClient.tsx`)
   - Verify: Shows institution-scoped statistics
   - Verify: Role check at page level (SCHOOL_ADMIN or PLATFORM_ADMIN)

2. **User Management** (`app/admin/school/users/page.tsx`, `SchoolUsersClient.tsx`)
   - Verify: Lists users in same institution
   - Verify: Create user form works
   - Verify: CSV import functional
   - Verify: Role promotion works
   - Verify: Archive user works

3. **Course Management** (`app/admin/school/classes/page.tsx`, `SchoolClassesClient.tsx`)
   - Verify: Create/edit/archive courses
   - Verify: Section/subgroup management
   - Verify: Enrollment assignment

4. **Settings** (`app/admin/school/settings/page.tsx`, `SchoolSettingsClient.tsx`)
   - Verify: Institution settings accessible and saveable

**Platform Admin Flow Audit:**
1. **Dashboard** (`app/admin/platform/dashboard/page.tsx`, `DashboardClient.tsx`)
   - Verify: Cross-institution statistics
   - Verify: Role check (PLATFORM_ADMIN only)

2. **Institution Management** (`app/admin/page.tsx`, `InstitutionsClient.tsx`)
   - Verify: Create/edit institutions
   - Verify: SSO/OIDC configuration

3. **AI Settings** (`app/admin/platform/ai/page.tsx`, `AIConfigClient.tsx`)
   - Verify: OpenAI configuration accessible

4. **System Settings** (`app/admin/platform/system/page.tsx`, `SystemSettingsClient.tsx`)
   - Verify: Platform-level configuration

**Cross-Role Access Protection Audit:**
For EVERY page-level component in `app/student/`, `app/teacher/`, `app/admin/`:
1. Read the page.tsx (server component)
2. Verify it checks session authentication
3. Verify it checks role authorization
4. Verify unauthorized access results in redirect (not just "Access denied" text)

Specifically test (by reading code):
- Student pages: Must reject TEACHER, SCHOOL_ADMIN, PLATFORM_ADMIN
- Teacher pages: Must allow TEACHER + admins, reject STUDENT
- School admin pages: Must reject TEACHER and STUDENT
- Platform admin pages: Must reject everyone except PLATFORM_ADMIN

For any page missing role checks or using weak protection ("Access denied" div instead of redirect):
- Add proper `redirect('/login')` for unauthenticated
- Add proper `redirect('/unauthorized')` or role-appropriate redirect for wrong role
  </action>
  <verify>
Grep all page.tsx in app/student/, app/teacher/, app/admin/ for session/role checks. Verify each has redirect for unauthorized. Run `npx tsc --noEmit`.
  </verify>
  <done>All admin flows verified. Cross-role access protection on every page. Unauthorized access triggers redirect, not "Access denied" text. TypeScript compiles.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Every page.tsx in role-specific directories checks authentication and role
3. Student flow traces from courses through results with no dead links
4. Teacher flow traces from courses through export with no dead links
5. Admin flows complete and institution-scoped
</verification>

<success_criteria>
- All student pages check STUDENT role and redirect unauthorized users
- All teacher pages check TEACHER+ role and redirect unauthorized users
- All admin pages check appropriate admin role and redirect unauthorized users
- No broken navigation links between pages in any flow
- All API calls from pages reference existing API routes
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/11-verification-complete-pre-production/11-02-SUMMARY.md`
</output>
