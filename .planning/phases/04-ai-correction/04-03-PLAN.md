---
phase: 04-ai-correction
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - components/grading/GradeEditModal.tsx
  - components/grading/ReGradeButton.tsx
  - app/dashboard/exams/[examId]/grading/[attemptId]/GradingView.tsx
  - app/api/grades/route.ts
autonomous: true

must_haves:
  truths:
    - "Teacher can open modal to edit AI-assigned grade and feedback"
    - "Editing marks grade as human-override (isOverridden: true)"
    - "Teacher can re-trigger AI grading on a single answer"
    - "Re-grading respects human overrides (asks for confirmation)"
  artifacts:
    - path: "components/grading/GradeEditModal.tsx"
      provides: "Modal for editing grade score and feedback"
      exports: ["GradeEditModal"]
    - path: "components/grading/ReGradeButton.tsx"
      provides: "Button to re-trigger AI grading on single answer"
      exports: ["ReGradeButton"]
  key_links:
    - from: "app/dashboard/exams/[examId]/grading/[attemptId]/GradingView.tsx"
      to: "components/grading/GradeEditModal.tsx"
      via: "import"
      pattern: "import.*GradeEditModal"
    - from: "components/grading/GradeEditModal.tsx"
      to: "/api/grades"
      via: "fetch POST"
      pattern: "fetch.*api/grades"
---

<objective>
Create teacher review interface for validating and modifying AI grades before publication.

Purpose: Teachers need to review AI grades and have the ability to modify scores/feedback. This fulfills CORR-03 (optional teacher review) and CORR-04 (review interface to validate/modify).

Output:
- Edit modal for modifying grade and feedback
- Re-grade button for single answers
- Updated GradingView with new review capabilities
- Override tracking (isOverridden flag)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-correction/04-CONTEXT.md
@.planning/phases/04-ai-correction/04-RESEARCH.md
@.planning/phases/04-ai-correction/04-01-SUMMARY.md

Key existing files:
@app/dashboard/exams/[examId]/grading/[attemptId]/GradingView.tsx
@app/api/grades/route.ts
@app/api/attempts/[id]/grading/enqueue-ai/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Grade edit modal component</name>
  <files>
    components/grading/GradeEditModal.tsx
  </files>
  <action>
Create `components/grading/GradeEditModal.tsx`:

Props:
```typescript
interface GradeEditModalProps {
  isOpen: boolean
  onClose: () => void
  onSave: (score: number, feedback: string) => void
  questionContent: string  // For context display
  studentAnswer: string    // For context display
  maxPoints: number
  currentScore: number
  currentFeedback: string
  aiRationale?: string     // Show AI reasoning if available
  isAiGrade: boolean       // Show badge if AI-graded
}
```

UI Structure:
1. Modal header: "Modifier la note" with close button
2. Context section (read-only, collapsible):
   - Question content (with MathRenderer)
   - Student answer (with MathRenderer)
   - AI rationale (if available, in muted box with "Raisonnement IA" label)
3. Edit section:
   - Score input: number, 0 to maxPoints, step 0.5
   - Feedback textarea: 4 rows, placeholder "Commentaire pour l'étudiant..."
   - Info text: "Ce commentaire sera visible par l'étudiant après publication"
4. Footer:
   - "Annuler" button (secondary)
   - "Enregistrer" button (primary)
5. If isAiGrade, show badge: "Note générée par IA - sera marquée comme modifiée par le professeur"

Styling:
- Modal: centered, max-w-2xl, backdrop blur
- Close on escape, close on backdrop click
- Focus trap for accessibility
  </action>
  <verify>
`npm run build` passes.
Component renders without errors (can test with Storybook or direct import).
  </verify>
  <done>
Grade edit modal component ready with score/feedback editing, AI rationale display, and proper UX.
  </done>
</task>

<task type="auto">
  <name>Task 2: Re-grade button and API integration</name>
  <files>
    components/grading/ReGradeButton.tsx
    app/api/grades/route.ts
  </files>
  <action>
Create `components/grading/ReGradeButton.tsx`:

Props:
```typescript
interface ReGradeButtonProps {
  attemptId: string
  answerId: string
  hasHumanOverride: boolean  // If true, show confirmation
  onSuccess: () => void
}
```

Behavior:
1. Button label: "Recorriger (IA)"
2. On click:
   - If hasHumanOverride: show confirmation dialog
     "Cette réponse a été modifiée manuellement. Voulez-vous vraiment relancer la correction IA? La note actuelle sera remplacée."
   - If confirmed or no override: POST to /api/attempts/{attemptId}/grading/enqueue-ai with body: { answerId }
3. Show loading state during request
4. On success: call onSuccess, show toast "Correction IA relancée"
5. On error: show error toast

Update existing `/api/attempts/[id]/grading/enqueue-ai/route.ts` to accept optional `answerId` in body:
- If answerId provided: enqueue only that answer (even if human-graded, for re-grade)
- If no answerId: current behavior (all non-human-graded answers)
- Add flag to job data: { forceRegrade: true } when single answer re-grade

Update `app/api/grades/route.ts` POST handler:
- Add logic to set isOverridden: true when teacher saves grade
- Check if grade previously had gradedByUserId: null (was AI grade)
- If so, set isOverridden: true and gradedByUserId: current teacher ID
- Return updated grade with isOverridden status
  </action>
  <verify>
Manual test:
1. Grade an answer with AI
2. Click "Recorriger (IA)" - should re-grade
3. Edit grade manually
4. Click "Recorriger (IA)" - should show confirmation
5. Confirm - should re-grade and replace manual edit
  </verify>
  <done>
Re-grade functionality works for single answers. Override tracking correct. Confirmation for human-edited grades.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate edit modal and re-grade into GradingView</name>
  <files>
    app/dashboard/exams/[examId]/grading/[attemptId]/GradingView.tsx
  </files>
  <action>
Update `app/dashboard/exams/[examId]/grading/[attemptId]/GradingView.tsx`:

1. Import new components:
   - GradeEditModal
   - ReGradeButton

2. Add state for edit modal:
   ```typescript
   const [editingQuestion, setEditingQuestion] = useState<string | null>(null)
   ```

3. For each question card, update the grade display section:
   - Show AI badge if grade exists and gradedByUserId === null
   - Show "Modifié" badge if isOverridden === true
   - Add "Modifier" button that opens GradeEditModal
   - Add ReGradeButton below grade input

4. Wire up GradeEditModal:
   - Pass current score, feedback, question content, student answer
   - Fetch aiRationale from grade data (add to API response if not present)
   - onSave: call existing saveGrade function, close modal, refresh data
   - onClose: setEditingQuestion(null)

5. Update grade display to show feedback with MathRenderer:
   - Currently shows raw text in textarea
   - Add read-only view with MathRenderer when not editing
   - "Modifier" button switches to edit mode (modal)

6. Update data fetching to include aiRationale and isOverridden:
   - Modify /api/attempts/{id}/grading to return these fields

7. Visual indicators:
   - AI-graded: blue badge "IA"
   - Human-edited: orange badge "Modifié par prof"
   - Show score with color: green if >= 70% of max, yellow if 40-70%, red if < 40%
  </action>
  <verify>
Manual test:
1. Open grading view for an attempt
2. See AI badge on AI-graded questions
3. Click "Modifier" - modal opens with pre-filled data
4. Edit score and feedback, save
5. Badge changes to "Modifié par prof"
6. Click "Recorriger (IA)" - confirmation appears (because modified)
7. Confirm - grade reverts to AI, badge changes back to "IA"
  </verify>
  <done>
GradingView fully integrated with edit modal and re-grade functionality. Visual indicators show AI vs human grades.
  </done>
</task>

</tasks>

<verification>
1. Edit modal:
   - Opens with correct data pre-filled
   - Shows AI rationale when available
   - Saves score and feedback correctly
   - Sets isOverridden flag on save

2. Re-grade:
   - Works for AI-graded answers (no confirmation)
   - Shows confirmation for human-edited answers
   - Enqueues single job to queue
   - Grade updates after worker processes

3. Visual indicators:
   - AI badge shows on AI-graded questions
   - "Modifié" badge shows after teacher edit
   - Feedback renders with MathRenderer (LaTeX works)

4. Data consistency:
   - isOverridden persisted to database
   - gradedByUserId set correctly on manual save
   - Re-grade clears isOverridden and gradedByUserId
</verification>

<success_criteria>
- Teacher can modify AI-assigned grade and feedback before publishing (CORR-04)
- Modal shows AI rationale to help teacher understand AI decision
- Re-grade button available for single answers
- Confirmation when re-grading human-edited answers
- Visual distinction between AI grades and human-modified grades
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-correction/04-03-SUMMARY.md`
</output>
