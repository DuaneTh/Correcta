---
phase: 04-ai-correction
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - app/dashboard/exams/[examId]/grading/GradingDashboard.tsx
  - app/api/exams/[examId]/release-results/route.ts
  - app/student/attempts/[attemptId]/results/ResultsView.tsx
  - app/api/attempts/[attemptId]/results/route.ts
autonomous: true

must_haves:
  truths:
    - "Teacher can choose to publish grades immediately or review first"
    - "Teacher can publish grades for entire class at once"
    - "Students can view their grades and AI-generated feedback after publication"
    - "Math expressions in feedback render correctly for students"
  artifacts:
    - path: "app/dashboard/exams/[examId]/grading/GradingDashboard.tsx"
      provides: "Publish options (direct vs after review)"
      contains: "Publier"
    - path: "app/student/attempts/[attemptId]/results/ResultsView.tsx"
      provides: "Student view with AI feedback and math rendering"
      contains: "MathRenderer"
  key_links:
    - from: "app/dashboard/exams/[examId]/grading/GradingDashboard.tsx"
      to: "/api/exams/[examId]/release-results"
      via: "fetch POST"
      pattern: "fetch.*release-results"
    - from: "app/student/attempts/[attemptId]/results/ResultsView.tsx"
      to: "/api/attempts/[attemptId]/results"
      via: "fetch GET"
      pattern: "fetch.*results"
---

<objective>
Refine publication flow with optional immediate publish after grading, and enhance student results view to properly display AI feedback with math rendering.

Purpose: Teachers should be able to publish grades directly after AI grading or review first. Students need to see their AI-generated feedback clearly, including any LaTeX math expressions.

Output:
- Publish options in grading dashboard (immediate vs after review)
- Enhanced student results view with proper feedback display
- Math rendering in feedback using MathRenderer
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-correction/04-CONTEXT.md
@.planning/phases/04-ai-correction/04-RESEARCH.md
@.planning/phases/04-ai-correction/04-02-SUMMARY.md
@.planning/phases/04-ai-correction/04-03-SUMMARY.md

Key existing files:
@app/dashboard/exams/[examId]/grading/GradingDashboard.tsx
@app/api/exams/[examId]/release-results/route.ts
@app/student/attempts/[attemptId]/results/ResultsView.tsx
@app/api/attempts/[attemptId]/results/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Publication flow with optional immediate publish</name>
  <files>
    app/dashboard/exams/[examId]/grading/GradingDashboard.tsx
    components/grading/GradingProgressModal.tsx
  </files>
  <action>
Update `app/dashboard/exams/[examId]/grading/GradingDashboard.tsx`:

1. Add state for publication options:
   ```typescript
   const [showPublishConfirm, setShowPublishConfirm] = useState(false)
   ```

2. Enhance "Rendre les copies" button:
   - Show dropdown with two options:
     a. "Rendre les copies" - current behavior (publishes all graded)
     b. Grayed out if not all attempts are GRADED, with tooltip "Toutes les copies doivent être corrigées"
   - Add checkbox in dropdown: "Notifier les étudiants par email" (future feature, disabled for now)

3. Add confirmation modal before publishing:
   - "Êtes-vous sûr de vouloir publier les notes?"
   - "Les étudiants pourront voir leurs notes et les commentaires"
   - Show count: "X copies seront publiées"
   - Buttons: "Annuler", "Publier"

4. Update existing handleReleaseResults:
   - Add loading state during publish
   - Show success toast on completion
   - Refresh attempts list after publish

Update `components/grading/GradingProgressModal.tsx`:

5. After grading completes, show publish option:
   - Add checkbox: "Publier les notes immédiatement après correction"
   - If checked, call release-results API automatically after grading completes
   - If unchecked, just close modal and show "Correction terminée" toast
   - Default: unchecked (review first is safer)
  </action>
  <verify>
Manual test:
1. Complete batch grading
2. Progress modal shows publish checkbox
3. If checked: grades published automatically
4. If unchecked: modal closes, grades not published
5. Can publish later from dashboard with "Rendre les copies"
6. Confirmation modal appears before publishing
  </verify>
  <done>
Publication flow supports immediate publish or review-first. Teacher has clear control over when students see grades.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance student results view for AI feedback</name>
  <files>
    app/student/attempts/[attemptId]/results/ResultsView.tsx
    app/api/attempts/[attemptId]/results/route.ts
  </files>
  <action>
Update `app/api/attempts/[attemptId]/results/route.ts`:

1. Enhance grade data in response:
   - Include isAiGrade: boolean (gradedByUserId === null && !isOverridden)
   - Include full feedback (already present)
   - Ensure feedback with $...$ delimiters is returned as-is (don't escape)

Update `app/student/attempts/[attemptId]/results/ResultsView.tsx`:

2. Enhance feedback display:
   - Use MathRenderer for feedback (already imported, verify it's used)
   - Ensure LaTeX in feedback renders correctly: $x^2$ should show rendered math
   - Style feedback section:
     - Green left border for score >= 70%
     - Yellow for 40-70%
     - Red for < 40%

3. Add visual indicator for AI feedback:
   - Small badge: "Correction automatique" with robot/AI icon
   - Show below score, above feedback
   - Muted styling (not prominent, just informational)

4. Improve empty feedback handling:
   - If feedback is empty but score > 0: "Bonne réponse!"
   - If feedback is empty and score = 0: "Réponse incorrecte"
   - If feedback is empty and partial: "Réponse partiellement correcte"

5. Add feedback section header:
   - "Commentaire du correcteur" label
   - Clear visual separation from student answer

6. Responsive design:
   - On mobile: stack score and feedback vertically
   - On desktop: score on right, feedback below
  </action>
  <verify>
Manual test:
1. Student opens results page
2. Sees score with color coding
3. Sees "Correction automatique" badge for AI-graded
4. Feedback renders with MathRenderer (test with $x^2$ in feedback)
5. Empty feedback shows appropriate default message
  </verify>
  <done>
Student results view displays AI feedback clearly with math rendering. LaTeX round-trip works (CORR-05).
  </done>
</task>

<task type="auto">
  <name>Task 3: Grading status indicators and dashboard polish</name>
  <files>
    app/dashboard/exams/[examId]/grading/GradingDashboard.tsx
  </files>
  <action>
Update `app/dashboard/exams/[examId]/grading/GradingDashboard.tsx`:

1. Add grading statistics summary at top:
   - "X copies corrigées sur Y"
   - "Z modifications manuelles" (count of isOverridden grades)
   - "Score moyen: X/Y (Z%)"
   - Display in stat cards row

2. Add status indicators per attempt:
   - Current: status badges (Corrigée, En cours, Non corrigée)
   - Add: small indicator if any grades were human-modified
   - Tooltip: "X questions modifiées par le professeur"

3. Add bulk action dropdown:
   - "Actions" dropdown next to Grade All button
   - Option: "Exporter les notes" (placeholder for Phase 5)
   - Option: "Télécharger rapport" (placeholder for Phase 5)
   - Both disabled with "Disponible bientôt" tooltip

4. Add filtering:
   - Dropdown filter: "Toutes les copies", "Non corrigées", "Corrigées", "Modifiées"
   - Filter attempts list based on selection

5. Add grading progress indicator when not all graded:
   - Progress bar at top showing percentage complete
   - "X/Y copies corrigées" text
   - Hide when all GRADED

6. Polish existing table:
   - Add hover row highlighting
   - Add alternating row colors
   - Sticky header on scroll
  </action>
  <verify>
Manual test:
1. Dashboard shows statistics summary
2. Filter dropdown works
3. Progress bar shows for incomplete grading
4. Hover effects work on table rows
5. Action dropdown present (options disabled)
  </verify>
  <done>
Grading dashboard is polished with statistics, filtering, and clear progress indication.
  </done>
</task>

</tasks>

<verification>
1. Publication flow (CORR-03):
   - Can publish immediately after grading (checkbox in progress modal)
   - Can review first, then publish later
   - Confirmation modal before publishing
   - Success message after publish

2. Student view:
   - Results page shows AI feedback with MathRenderer
   - LaTeX in feedback renders correctly
   - Visual indicator for AI-generated grades
   - Color-coded scores
   - Appropriate defaults for empty feedback

3. Dashboard polish:
   - Statistics summary accurate
   - Filtering works
   - Progress indicator shows correctly
   - Action dropdown present

4. End-to-end flow:
   - Teacher clicks Grade All
   - Grading completes
   - Teacher reviews grades (optional)
   - Teacher publishes grades
   - Student sees results with feedback
</verification>

<success_criteria>
- Teacher can choose to publish grades immediately or review first (CORR-03)
- Teacher can modify AI-assigned grade and feedback before publishing (CORR-04)
- Math expressions in student answers appear correctly in AI feedback (CORR-05)
- Students can view grades and AI-generated feedback after publication
- Dashboard provides clear visibility into grading status
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-correction/04-04-SUMMARY.md`
</output>
