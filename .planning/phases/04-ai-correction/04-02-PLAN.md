---
phase: 04-ai-correction
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/api/exams/[examId]/grade-all/route.ts
  - app/api/exams/[examId]/grading-progress/route.ts
  - app/dashboard/exams/[examId]/grading/GradingDashboard.tsx
  - components/grading/GradeAllButton.tsx
  - components/grading/GradingProgressModal.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher can click Grade All and see grading jobs enqueued"
    - "Progress indicator shows completed/total during grading"
    - "Teacher can cancel grading (keeps already graded answers)"
    - "Failed jobs are retried 2-3 times, then skipped"
  artifacts:
    - path: "app/api/exams/[examId]/grade-all/route.ts"
      provides: "Batch grading endpoint"
      exports: ["POST"]
    - path: "app/api/exams/[examId]/grading-progress/route.ts"
      provides: "Progress polling endpoint"
      exports: ["GET"]
    - path: "components/grading/GradeAllButton.tsx"
      provides: "Grade All button with rubric pre-generation"
      exports: ["GradeAllButton"]
    - path: "components/grading/GradingProgressModal.tsx"
      provides: "Progress modal with cancel support"
      exports: ["GradingProgressModal"]
  key_links:
    - from: "app/dashboard/exams/[examId]/grading/GradingDashboard.tsx"
      to: "components/grading/GradeAllButton.tsx"
      via: "import"
      pattern: "import.*GradeAllButton"
    - from: "components/grading/GradeAllButton.tsx"
      to: "/api/exams/[examId]/grade-all"
      via: "fetch"
      pattern: "fetch.*grade-all"
---

<objective>
Implement "Grade All" batch grading with progress tracking, cancellation, and retry handling.

Purpose: Teachers need to grade entire exam submissions at once with visibility into progress. This replaces the per-attempt "Correction automatique (IA)" button with a batch workflow.

Output:
- "Grade All" button in grading dashboard
- Progress modal showing grading status
- API endpoints for batch grading and progress
- Cancel functionality
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-correction/04-CONTEXT.md
@.planning/phases/04-ai-correction/04-RESEARCH.md
@.planning/phases/04-ai-correction/04-01-SUMMARY.md

Key existing files:
@app/dashboard/exams/[examId]/grading/GradingDashboard.tsx
@app/api/attempts/[id]/grading/enqueue-ai/route.ts
@lib/queue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Grade All API endpoint with batch job enqueueing</name>
  <files>
    app/api/exams/[examId]/grade-all/route.ts
    app/api/exams/[examId]/grading-progress/route.ts
  </files>
  <action>
Create `app/api/exams/[examId]/grade-all/route.ts`:

POST handler:
1. Auth check: Teacher only, CSRF required
2. Verify teacher has access to exam (same institution check)
3. Fetch all submitted attempts for the exam with their answers
4. Filter out answers that already have human grades (gradedByUserId !== null || isOverridden)
5. For each question in the exam:
   - Check if question.generatedRubric exists
   - If not, auto-generate rubric using generateRubric() from 04-01
   - Store in question.generatedRubric
6. Enqueue all answer grading jobs using aiGradingQueue.addBulk():
   - Job name: 'grade-answer'
   - Job data: { attemptId, answerId, questionId }
7. Store batch metadata in Redis (or DB) for progress tracking:
   - Key: `grading-batch:${examId}`
   - Value: { totalJobs, enqueuedAt, status: 'IN_PROGRESS' }
8. Return: { batchId: examId, totalJobs, enqueuedCount }

Create `app/api/exams/[examId]/grading-progress/route.ts`:

GET handler:
1. Auth check: Teacher only
2. Query database for attempts with answers and grades:
   - Count total answers for submitted attempts
   - Count graded answers (where grade exists)
3. Calculate progress: { completed, total, percentage }
4. Check attempt statuses:
   - All GRADED = status: 'COMPLETED'
   - Any GRADING_IN_PROGRESS = status: 'IN_PROGRESS'
   - All SUBMITTED (no grades) = status: 'NOT_STARTED'
5. Return: { completed, total, percentage, status, canCancel: status === 'IN_PROGRESS' }

DELETE handler (for cancellation):
1. Auth check: Teacher only, CSRF required
2. Drain remaining jobs from queue for this exam (use job data filter)
3. Update batch status to 'CANCELLED'
4. Return: { cancelled: true, alreadyGraded: count }
  </action>
  <verify>
`npm run build` passes.
Test endpoints:
- POST /api/exams/{examId}/grade-all enqueues jobs (check Redis queue length)
- GET /api/exams/{examId}/grading-progress returns progress
- DELETE /api/exams/{examId}/grading-progress cancels remaining jobs
  </verify>
  <done>
Batch grading API works: enqueues jobs for all answers, tracks progress, supports cancellation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Grade All button and progress modal UI</name>
  <files>
    components/grading/GradeAllButton.tsx
    components/grading/GradingProgressModal.tsx
    app/dashboard/exams/[examId]/grading/GradingDashboard.tsx
  </files>
  <action>
Create `components/grading/GradeAllButton.tsx`:
- Props: { examId: string, onComplete?: () => void }
- State: loading, showProgress
- On click:
  1. POST to /api/exams/{examId}/grade-all
  2. On success, open GradingProgressModal
  3. On error, show toast/alert
- Styling: Primary button, "Corriger toutes les copies" label
- Disabled while loading

Create `components/grading/GradingProgressModal.tsx`:
- Props: { examId: string, isOpen: boolean, onClose: () => void, onComplete: () => void }
- Uses polling (every 2 seconds) to GET /api/exams/{examId}/grading-progress
- Displays:
  - Progress bar (percentage)
  - Text: "{completed} / {total} copies corrigées"
  - Status indicator (spinner while IN_PROGRESS, checkmark when COMPLETED)
  - Cancel button (calls DELETE, then closes modal)
- Auto-closes when status === 'COMPLETED', calls onComplete
- Modal styling: Centered, backdrop blur, close on escape

Update `app/dashboard/exams/[examId]/grading/GradingDashboard.tsx`:
1. Import GradeAllButton
2. Add GradeAllButton next to existing "Rendre les copies" button
3. On complete: refresh attempts list (call fetchAttempts)
4. Remove or hide the per-attempt AI grading button (keep in GradingView for re-grading single copy)
  </action>
  <verify>
`npm run build` passes.
Manual test:
1. Open grading dashboard for an exam with submitted attempts
2. Click "Corriger toutes les copies"
3. Progress modal appears with progress bar
4. Progress updates as jobs complete
5. Modal closes when complete
6. Attempts list shows GRADED status
  </verify>
  <done>
Grade All workflow fully functional: button triggers batch grading, modal shows progress, list refreshes on completion.
  </done>
</task>

<task type="auto">
  <name>Task 3: Rubric review step before grading</name>
  <files>
    components/grading/RubricReviewModal.tsx
    components/grading/GradeAllButton.tsx
  </files>
  <action>
Create `components/grading/RubricReviewModal.tsx`:
- Props: { examId: string, isOpen: boolean, onClose: () => void, onConfirm: () => void }
- On open, fetch all questions for the exam with their generatedRubric
- For questions without rubric, show "Sera généré automatiquement"
- For questions with rubric, show editable summary:
  - Question content (truncated)
  - Criteria list with points
  - "Modifier" button opens inline edit
- Edit mode:
  - Textarea for rubric JSON or structured form
  - Save button: PUT /api/questions/{id}/rubric
- Footer:
  - "Annuler" button closes modal
  - "Lancer la correction" button calls onConfirm
- Styling: Full-screen modal on mobile, large modal on desktop

Update `components/grading/GradeAllButton.tsx`:
1. Before calling grade-all, open RubricReviewModal
2. Flow: Click button -> RubricReviewModal -> Confirm -> POST grade-all -> GradingProgressModal
3. If teacher closes RubricReviewModal without confirming, do nothing

Note per CONTEXT.md: "Teacher can optionally edit the generated rubric before launching corrections"
This step allows review but doesn't force edit (can just click confirm).
  </action>
  <verify>
Manual test:
1. Click "Corriger toutes les copies"
2. Rubric review modal appears showing questions
3. Can edit a rubric and save
4. Click "Lancer la correction"
5. Progress modal appears
  </verify>
  <done>
Teacher can review and edit rubrics before batch grading starts. Same rubric applied to all students (equity).
  </done>
</task>

</tasks>

<verification>
1. Grade All workflow:
   - Click "Corriger toutes les copies" in grading dashboard
   - Rubric review modal shows questions with rubrics
   - Can edit rubrics (optional)
   - Click "Lancer la correction"
   - Progress modal shows grading progress
   - Progress updates as jobs complete
   - Modal closes when done

2. Progress tracking:
   - GET /api/exams/{examId}/grading-progress returns accurate counts
   - Progress bar matches actual graded vs total

3. Cancellation:
   - Click "Annuler" during grading
   - Already graded answers are kept
   - Queue is drained for remaining jobs

4. Retry handling:
   - If GPT-4 call fails, job is retried (check worker logs)
   - After 3 retries, job fails and is skipped
   - Grading continues for other answers
</verification>

<success_criteria>
- Teacher clicks "Grade All" and sees progress indicator for 50 student submissions
- Rubric review step allows optional editing before grading starts
- Progress shows real-time updates
- Cancellation works and keeps already graded answers
- Failed jobs retry 2-3 times then skip
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-correction/04-02-SUMMARY.md`
</output>
