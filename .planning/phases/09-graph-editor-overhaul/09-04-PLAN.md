---
phase: 09-graph-editor-overhaul
plan: 04
type: execute
wave: 4
depends_on: ["09-03"]
files_modified:
  - components/exams/SegmentedMathField.tsx
  - components/exams/graph-editor/GraphEditorPopup.tsx
autonomous: false

must_haves:
  truths:
    - "Graph button in exam editor shows dropdown with 'Simple' and 'Avance' mode choices"
    - "Selecting a mode opens the graph editor popup with that mode pre-selected"
    - "Existing graphs can be clicked to edit them using the new dual-mode editor"
    - "New graphs created via Simple mode integrate as content segments in exam questions"
    - "All existing graph data is preserved and renders correctly after integration"
  artifacts:
    - path: "components/exams/graph-editor/GraphEditorPopup.tsx"
      provides: "Popup wrapper around GraphEditorWrapper with positioning and click-outside"
      exports: ["GraphEditorPopup"]
    - path: "components/exams/SegmentedMathField.tsx"
      provides: "Updated with new graph button dropdown and GraphEditorPopup integration"
      contains: "GraphEditorPopup"
  key_links:
    - from: "components/exams/SegmentedMathField.tsx"
      to: "components/exams/graph-editor/GraphEditorPopup.tsx"
      via: "Replaces InlineGraphEditor with GraphEditorPopup"
      pattern: "import.*GraphEditorPopup.*from.*graph-editor"
    - from: "components/exams/graph-editor/GraphEditorPopup.tsx"
      to: "components/exams/graph-editor/GraphEditorWrapper.tsx"
      via: "Wraps GraphEditorWrapper with popup positioning"
      pattern: "import.*GraphEditorWrapper.*from.*GraphEditorWrapper"
---

<objective>
Integrate the new dual-mode graph editor into the exam builder by replacing the Graph button with a dropdown menu and swapping InlineGraphEditor with the new GraphEditorPopup.

Purpose: This is the final integration step. Teachers will see the new graph button dropdown and use the dual-mode editor for creating and editing graphs within their exam questions.

Output: Fully integrated graph editor in the exam builder with dropdown mode selection.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-graph-editor-overhaul/09-01-SUMMARY.md
@.planning/phases/09-graph-editor-overhaul/09-02-SUMMARY.md
@.planning/phases/09-graph-editor-overhaul/09-03-SUMMARY.md
@types/exams.ts
@components/exams/SegmentedMathField.tsx
@components/exams/graph-editor/GraphEditorWrapper.tsx
@components/exams/graph-editor/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: GraphEditorPopup and SegmentedMathField integration</name>
  <files>
    components/exams/graph-editor/GraphEditorPopup.tsx
    components/exams/SegmentedMathField.tsx
  </files>
  <action>
    1. Create `components/exams/graph-editor/GraphEditorPopup.tsx`:
       - This is the popup wrapper that replaces the old InlineGraphEditor
       - 'use client' directive
       - Props: same as old InlineGraphEditor: `{ value: GraphPayload; onChangeDraft: (payload: GraphPayload) => void; onConfirm: () => void; onCancel: () => void; onDelete: () => void; anchorRef: React.RefObject<HTMLDivElement | null>; locale?: string; initialMode?: EditorMode }`
       - Copy the popup positioning logic from the current InlineGraphEditor (useLayoutEffect for position calculation, ResizeObserver, scroll/resize listeners)
       - Copy the click-outside handler (mousedown listener that calls onConfirm)
       - Render GraphEditorWrapper inside the positioned popup div
       - Pass value, onChange=onChangeDraft, onConfirm, onCancel, onDelete, locale, and initialMode to GraphEditorWrapper
       - Use same CSS classes as current popup: `fixed z-50 bg-white rounded-lg shadow-xl border border-gray-200`
       - Width: `w-[56rem]` (wider than current 44rem to accommodate palette in simple mode)
       - Max-height: `max-h-[85vh]` with overflow handling

    2. Update SegmentedMathField.tsx -- Replace Graph Button with Dropdown:
       - Find the current graph button (around line 6326, the amber-styled button that calls insertGraph)
       - Replace it with a dropdown button pattern:
         - Main button: same amber style, shows "Graphique" / "Graph" with LineChart icon
         - On click: show a small dropdown menu below the button with two options:
           a. "Mode simple" / "Simple mode" -- with a brief description "Glisser-deposer des formes" / "Drag-and-drop shapes"
           b. "Mode avance" / "Advanced mode" -- with description "Editeur de formulaires" / "Form-based editor"
         - Use a simple state (`graphDropdownOpen: boolean`) and a ref for click-outside dismissal
         - Dropdown styled: `absolute z-40 bg-white rounded-lg shadow-lg border border-gray-200 py-1 min-w-[200px]`
         - Each option: `px-3 py-2 hover:bg-gray-50 cursor-pointer`, with option label in font-medium and description in text-xs text-gray-500
       - When user selects a mode:
         a. Close dropdown
         b. Call existing insertGraph function (which creates the graph element in the editor)
         c. Set a new state: `graphEditorInitialMode: EditorMode` to the selected mode
         d. The GraphEditorPopup will receive this initialMode

    3. Update SegmentedMathField.tsx -- Replace InlineGraphEditor with GraphEditorPopup:
       - Replace the `<InlineGraphEditor ... />` usage (around line 6448) with `<GraphEditorPopup ... />`
       - Add `initialMode={graphEditorInitialMode}` prop
       - Import GraphEditorPopup from `@/components/exams/graph-editor/GraphEditorPopup`
       - Keep all existing draft graph state management (draftGraphById, editingGraphId, etc.) -- the popup interface is the same
       - The old InlineGraphEditor function can be removed from SegmentedMathField.tsx (lines ~1332-2350) to reduce file size
       - Also remove the `GraphPayload` type definition from SegmentedMathField.tsx if it was defined inline there -- use the one from graph-editor/types.ts instead
       - Also remove the `normalizeGraphPayload` and `createDefaultGraphPayload` if they were defined in SegmentedMathField.tsx -- use imports from lib/content.ts and graph-editor/types.ts

    4. When editing an existing graph (clicking on a graph element in the editor):
       - The existing click handler already sets editingGraphId and shows the editor popup
       - Default to 'simple' mode when editing existing graphs
       - The GraphEditorPopup will show the current graph data in whichever mode the user chooses

    IMPORTANT:
    - Keep the SegmentedMathToolbar's showGraphButton prop and all student-side graph tool config unchanged
    - The student exam-taking side may also use graph editing -- ensure it works there too
    - Test that the graph button dropdown closes when clicking outside
    - Preserve all existing keyboard shortcuts and focus management around graph editing
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Graph button in the toolbar shows a dropdown menu on click
    - Selecting "Simple" opens the graph editor popup in simple mode with palette + canvas
    - Selecting "Advanced" opens the graph editor popup in advanced mode with form editor
    - Editing an existing graph opens the new popup with graph data loaded
    - Confirming (check button or click-outside) saves the graph as a content segment
    - Canceling reverts to original graph data
    - The old InlineGraphEditor code is removed from SegmentedMathField.tsx
  </verify>
  <done>
    Graph button shows dropdown with Simple/Advanced mode options. New dual-mode editor popup replaces old form-only editor. All existing graph functionality preserved.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete dual-mode graph editor integrated into the exam builder:
    1. Graph button in toolbar shows dropdown with "Mode simple" and "Mode avance" options
    2. Simple mode: shape palette (12 predefined shapes) + interactive canvas with drag-and-drop + properties panel
    3. Advanced mode: form-based editor (same as before but extracted into clean component)
    4. Mode switcher in editor header to toggle between modes
    5. All graph types supported: points, lines, curves, functions, areas, texts
  </what-built>
  <how-to-verify>
    1. Open the exam editor at /teacher/courses/[courseId]/exams/[examId]
    2. Click in a question content field to focus it
    3. Click the "Graphique" button in the toolbar -- verify a dropdown appears with "Mode simple" and "Mode avance"
    4. Select "Mode simple":
       a. Verify palette shows on left with categorized shapes (Fonctions, Lignes, Points, Geometrique)
       b. Click "Parabole" in the palette -- verify a parabola appears on the canvas
       c. Click "Point" -- verify a point appears, try dragging it to a new position
       d. Click on the parabola -- verify properties appear below canvas (expression, color, domain)
       e. Press Delete with a point selected -- verify it's removed
    5. Click "Avance" in the mode toggle:
       a. Verify the form-based editor appears with all the same elements you added
       b. Modify a point's coordinates via the form
       c. Switch back to "Simple" -- verify the change is reflected on canvas
    6. Click the confirm button (green check) -- verify graph is saved as a content segment
    7. Click on the saved graph in the editor -- verify it opens for editing in the popup
    8. Test creating a new graph with "Mode avance" from the dropdown -- verify the form editor opens
    9. Verify that the graph renders correctly in the question preview (MathRenderer)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Graph button dropdown works with two mode options
- Simple mode: palette, canvas with draggable elements, properties panel all functional
- Advanced mode: form editor works identically to previous version
- Mode switching preserves data
- Graphs save as content segments and render in preview
- Old InlineGraphEditor removed, reducing SegmentedMathField.tsx by ~1000 lines
</verification>

<success_criteria>
- Teacher can create a parabola by selecting from predefined shapes and adjusting on canvas
- Teacher can type f(x) = sin(x) in advanced mode and see it rendered
- Graph button shows dropdown with Simple/Advanced mode choices
- Graphs integrate seamlessly as content segments in exam questions
- No regression in existing graph functionality
</success_criteria>

<output>
After completion, create `.planning/phases/09-graph-editor-overhaul/09-04-SUMMARY.md`
</output>
