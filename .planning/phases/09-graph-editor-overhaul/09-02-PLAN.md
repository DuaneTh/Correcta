---
phase: 09-graph-editor-overhaul
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - components/exams/graph-editor/canvas/GraphCanvas.tsx
  - components/exams/graph-editor/canvas/CanvasGrid.tsx
  - components/exams/graph-editor/canvas/CanvasAxes.tsx
  - components/exams/graph-editor/canvas/shapes/EditablePoint.tsx
  - components/exams/graph-editor/canvas/shapes/EditableLine.tsx
  - components/exams/graph-editor/canvas/shapes/EditableCurve.tsx
  - components/exams/graph-editor/canvas/shapes/EditableFunction.tsx
  - components/exams/graph-editor/canvas/shapes/EditableText.tsx
  - components/exams/graph-editor/canvas/shapes/EditableArea.tsx
  - components/exams/graph-editor/canvas/shapes/index.ts
autonomous: true

must_haves:
  truths:
    - "Canvas renders grid, axes, and axis labels matching current SVG renderer appearance"
    - "Points can be dragged to new positions and their graph coordinates update correctly"
    - "Lines can be dragged by endpoints to new positions"
    - "Function curves render correctly using existing sampleFunction from graph-utils"
    - "All shape types from GraphSegment are rendered on canvas (points, lines, curves, functions, areas, texts)"
    - "Dragging snaps to grid when grid is enabled"
  artifacts:
    - path: "components/exams/graph-editor/canvas/GraphCanvas.tsx"
      provides: "Main react-konva Stage with Layer, renders all graph elements"
      exports: ["GraphCanvas"]
    - path: "components/exams/graph-editor/canvas/shapes/EditablePoint.tsx"
      provides: "Draggable point on Konva canvas"
      exports: ["EditablePoint"]
    - path: "components/exams/graph-editor/canvas/shapes/EditableFunction.tsx"
      provides: "Function curve rendered as Konva Path"
      exports: ["EditableFunction"]
  key_links:
    - from: "components/exams/graph-editor/canvas/GraphCanvas.tsx"
      to: "components/exams/graph-editor/coordinate-utils.ts"
      via: "graphToPixel/pixelToGraph for all shape rendering"
      pattern: "import.*graphToPixel.*from.*coordinate-utils"
    - from: "components/exams/graph-editor/canvas/shapes/EditableFunction.tsx"
      to: "components/exams/graph-utils.ts"
      via: "sampleFunction for curve sampling"
      pattern: "import.*sampleFunction.*from.*graph-utils"
    - from: "components/exams/graph-editor/canvas/GraphCanvas.tsx"
      to: "types/exams.ts"
      via: "GraphSegment element types"
      pattern: "import.*GraphPoint.*from"
---

<objective>
Build the react-konva interactive canvas that renders all graph element types with drag-and-drop manipulation. This is the core visual editor for Simple mode.

Purpose: Enables PowerPoint-style direct manipulation of graph elements -- drag points, move line endpoints, see function curves -- all on an interactive canvas that syncs back to the GraphSegment data model.

Output: GraphCanvas component and all editable shape components ready for Simple mode integration.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-graph-editor-overhaul/09-RESEARCH.md
@.planning/phases/09-graph-editor-overhaul/09-01-SUMMARY.md
@types/exams.ts
@components/exams/graph-utils.ts
@components/exams/graph-editor/types.ts
@components/exams/graph-editor/coordinate-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Canvas infrastructure (Stage, grid, axes)</name>
  <files>
    components/exams/graph-editor/canvas/GraphCanvas.tsx
    components/exams/graph-editor/canvas/CanvasGrid.tsx
    components/exams/graph-editor/canvas/CanvasAxes.tsx
  </files>
  <action>
    1. Create `components/exams/graph-editor/canvas/CanvasGrid.tsx`:
       - Renders grid lines on Konva Layer using `Line` components
       - Props: `{ axes: GraphAxes; width: number; height: number }`
       - Use graphToPixel from coordinate-utils for grid line positions
       - Grid step from axes.gridStep (default 1)
       - Grid lines: light gray (#e5e7eb), strokeWidth 0.5
       - Only render when axes.showGrid is true
       - Wrap with React.memo for performance

    2. Create `components/exams/graph-editor/canvas/CanvasAxes.tsx`:
       - Renders X and Y axis lines (thicker, dark) using Konva `Line`
       - Renders tick marks at each grid step
       - Renders axis labels (axes.xLabel, axes.yLabel) using Konva `Text`
       - Renders tick number labels at each step using Konva `Text` (font size 10, gray)
       - X axis: horizontal line at y=0 (or bottom if 0 not in range)
       - Y axis: vertical line at x=0 (or left if 0 not in range)
       - Axis lines: #374151, strokeWidth 1.5
       - Arrow heads at positive ends of axes
       - Wrap with React.memo

    3. Create `components/exams/graph-editor/canvas/GraphCanvas.tsx`:
       - Main component, props: `{ graph: GraphPayload; width: number; height: number; onUpdate: (graph: GraphPayload) => void; selectedId?: string | null; onSelect?: (id: string | null) => void }`
       - Uses react-konva `Stage` and `Layer`
       - Renders in order (back to front): background Rect, CanvasGrid, CanvasAxes, areas, function curves, lines, curves, points, texts
       - Stage has white background (or graph.background)
       - Each shape component gets onUpdate callback that patches the relevant array in graph
       - Click on Stage background deselects (onSelect(null))
       - Stage dimensions from graph.width/height or defaults (480x280)
       - Use `'use client'` directive (react-konva requires client-side rendering)

    IMPORTANT: react-konva components MUST be imported dynamically or the file must have 'use client'. Since Konva uses canvas API which is browser-only, ensure proper client-side handling. All shape components also need 'use client'.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - GraphCanvas exports a component accepting graph data and rendering a Konva Stage
    - CanvasGrid renders grid lines based on axes config
    - CanvasAxes renders axis lines with labels and tick marks
  </verify>
  <done>
    Canvas infrastructure renders grid, axes, labels, and provides the Stage/Layer structure for all shape components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Editable shape components for all graph element types</name>
  <files>
    components/exams/graph-editor/canvas/shapes/EditablePoint.tsx
    components/exams/graph-editor/canvas/shapes/EditableLine.tsx
    components/exams/graph-editor/canvas/shapes/EditableCurve.tsx
    components/exams/graph-editor/canvas/shapes/EditableFunction.tsx
    components/exams/graph-editor/canvas/shapes/EditableText.tsx
    components/exams/graph-editor/canvas/shapes/EditableArea.tsx
    components/exams/graph-editor/canvas/shapes/index.ts
  </files>
  <action>
    All shape components share this pattern:
    - Accept the element data + axes + canvas dimensions + onUpdate callback + isSelected boolean
    - Render Konva primitives (Circle, Line, Path, Text, etc.)
    - Use graphToPixel for rendering, pixelToGraph for drag results
    - `draggable` prop on interactive elements
    - `onDragEnd` converts pixel position back to graph coords and calls onUpdate
    - When grid is enabled (axes.showGrid), snap drag results to grid using snapToGrid
    - Selected elements show a subtle highlight (thicker stroke or glow)
    - All wrapped with React.memo
    - All have 'use client' directive

    1. **EditablePoint.tsx**:
       - Renders Konva `Circle` at graphToPixel(point.x, point.y)
       - Filled or hollow based on point.filled
       - Color from point.color, size from point.size (default 4, render as radius)
       - Draggable. onDragEnd updates point.x and point.y via pixelToGraph
       - If point has label and showLabel, render Konva `Text` near the point (offset by labelPos or default +8,+8)
       - onClick calls onSelect with point.id

    2. **EditableLine.tsx**:
       - Renders Konva `Line` between start and end anchors
       - For 'coord' anchors: resolve directly via graphToPixel
       - For 'point' anchors: resolve by finding the referenced point's coordinates from the graph data (pass points array as prop)
       - Line kind: 'segment' renders just between points, 'line' extends to canvas edges, 'ray' extends from start through end
       - Style: color, width, dashed (use Konva dash prop: [8, 4])
       - Two endpoint circles (small, radius 5) that are draggable for 'coord' type anchors
       - onDragEnd on endpoints updates start/end anchor coordinates

    3. **EditableCurve.tsx**:
       - Renders quadratic bezier using Konva `Path` or `Line` with tension
       - Start and end from anchors (resolve same as EditableLine)
       - Curvature determines the control point offset perpendicular to the start-end line
       - Two draggable endpoint circles for 'coord' anchors
       - A draggable control point circle (shown when selected) that adjusts curvature
       - Style: color, width, dashed

    4. **EditableFunction.tsx**:
       - Import `sampleFunction` from graph-utils.ts (this function already samples a GraphFunction into points)
       - If sampleFunction is not exported, create a local sampling function that evaluates the expression at N points across the domain
       - Existing graph-utils.ts has `evaluateExpression` and `convertLatexToExpression` -- check if they're exported. If not, use the approach: sample 200 points, convert each to pixel coords, render as Konva `Line` with points array
       - Domain handles: two small circles at domain min/max that can be dragged horizontally to change domain
       - The curve itself is NOT draggable (function is defined by expression, not position)
       - Style: color, width, dashed
       - If expression evaluation fails, render nothing (don't crash)

    5. **EditableText.tsx**:
       - Renders Konva `Text` at graphToPixel(text.x, text.y)
       - text.text content, fontSize 14 (default)
       - Draggable, onDragEnd updates text.x and text.y
       - If text.isMath, render as regular text for now (KaTeX on canvas is complex -- show the raw expression, this is editable in advanced mode)

    6. **EditableArea.tsx**:
       - For 'polygon' mode: render Konva `Line` (closed=true, fill) connecting all anchor points
       - For 'under-function' mode: sample function points, add bottom edge at y=yMin, fill
       - For 'between-functions' mode: sample both functions, create filled region
       - Fill color and opacity from area.fill
       - Polygon points draggable (for 'coord' anchors)

    7. **index.ts**: Re-export all shape components

    CRITICAL: Check if sampleFunction, evaluateExpression, and convertLatexToExpression are exported from graph-utils.ts. If they are not exported (only used internally), you need to add `export` to those functions in graph-utils.ts. The minimum needed exports are the expression evaluation pipeline so EditableFunction can sample points.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All 6 shape components export default or named React components
    - EditablePoint accepts GraphPoint props and renders a Konva Circle
    - EditableFunction renders a function curve as a Konva Line/Path
    - index.ts re-exports all shape components
  </verify>
  <done>
    All 6 graph element types have interactive Konva shape components. Points and text are draggable. Line/curve endpoints are draggable. Functions have domain handles. Areas render filled regions.
  </done>
</task>

</tasks>

<verification>
- GraphCanvas renders a Konva Stage with grid, axes, and all element types
- Dragging a point updates its graph coordinates correctly (Y-axis inversion handled)
- Function curves render using the same evaluation logic as graph-utils.ts
- All components use React.memo for performance
- TypeScript compiles clean
</verification>

<success_criteria>
- Complete interactive canvas ready for Simple mode integration
- All GraphSegment element types (points, lines, curves, functions, areas, texts) rendered and interactive
- Coordinate conversion between graph space and pixel space works correctly
- Canvas appearance reasonably matches the existing SVG renderer (grid, axes, colors)
</success_criteria>

<output>
After completion, create `.planning/phases/09-graph-editor-overhaul/09-02-SUMMARY.md`
</output>
