---
phase: 09-graph-editor-overhaul
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified:
  - components/exams/graph-editor/SimpleGraphEditor.tsx
  - components/exams/graph-editor/ShapePalette.tsx
  - components/exams/graph-editor/GraphEditorWrapper.tsx
autonomous: true

must_haves:
  truths:
    - "Simple mode shows shape palette on the left and interactive canvas on the right"
    - "Clicking a shape in the palette adds it to the canvas and the new shape renders visually on the GraphCanvas"
    - "Shapes on the canvas are draggable once placed -- this is the PowerPoint-like experience (click shape in toolbar, then drag/position on canvas)"
    - "Elements on canvas can be selected (click) and deleted (Delete key or button)"
    - "Mode switcher toggles between Simple and Advanced views"
    - "Both modes operate on the same GraphPayload -- switching modes preserves all data"
  artifacts:
    - path: "components/exams/graph-editor/SimpleGraphEditor.tsx"
      provides: "Simple mode: shape palette + interactive canvas + properties panel"
      exports: ["SimpleGraphEditor"]
    - path: "components/exams/graph-editor/ShapePalette.tsx"
      provides: "Categorized shape palette with clickable items"
      exports: ["ShapePalette"]
    - path: "components/exams/graph-editor/GraphEditorWrapper.tsx"
      provides: "Dual-mode wrapper with mode switcher, coordinates both editors"
      exports: ["GraphEditorWrapper"]
  key_links:
    - from: "components/exams/graph-editor/GraphEditorWrapper.tsx"
      to: "components/exams/graph-editor/SimpleGraphEditor.tsx"
      via: "Renders SimpleGraphEditor when mode is 'simple'"
      pattern: "mode.*===.*simple.*SimpleGraphEditor"
    - from: "components/exams/graph-editor/GraphEditorWrapper.tsx"
      to: "components/exams/graph-editor/AdvancedGraphEditor.tsx"
      via: "Renders AdvancedGraphEditor when mode is 'advanced'"
      pattern: "mode.*===.*advanced.*AdvancedGraphEditor"
    - from: "components/exams/graph-editor/SimpleGraphEditor.tsx"
      to: "components/exams/graph-editor/canvas/GraphCanvas.tsx"
      via: "Renders GraphCanvas for interactive editing, passes updated graph prop after shape insertion"
      pattern: "import.*GraphCanvas.*from.*canvas/GraphCanvas"
    - from: "components/exams/graph-editor/SimpleGraphEditor.tsx"
      to: "components/exams/graph-editor/ShapePalette.tsx"
      via: "onAddShape callback merges new elements into graph and passes updated payload to GraphCanvas"
      pattern: "onAddShape.*onChange"
---

<objective>
Build the Simple mode editor (shape palette + canvas), the shape palette component, and the GraphEditorWrapper that switches between Simple and Advanced modes while sharing state.

Purpose: Delivers the core user experience -- teachers click a shape in the palette to add it, then drag and position it on the canvas (PowerPoint-style: click in toolbar, then manipulate on canvas). They can also use the form-based editor (Advanced mode), with seamless switching between modes.

Output: Complete dual-mode graph editor ready for integration into the exam builder.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-graph-editor-overhaul/09-RESEARCH.md
@.planning/phases/09-graph-editor-overhaul/09-01-SUMMARY.md
@.planning/phases/09-graph-editor-overhaul/09-02-SUMMARY.md
@types/exams.ts
@components/exams/graph-editor/types.ts
@components/exams/graph-editor/templates/predefinedShapes.ts
@components/exams/graph-editor/templates/shapeCategories.ts
@components/exams/graph-editor/canvas/GraphCanvas.tsx
@components/exams/graph-editor/AdvancedGraphEditor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ShapePalette and SimpleGraphEditor</name>
  <files>
    components/exams/graph-editor/ShapePalette.tsx
    components/exams/graph-editor/SimpleGraphEditor.tsx
  </files>
  <action>
    1. Create `components/exams/graph-editor/ShapePalette.tsx`:
       - 'use client' directive
       - Props: `{ onAddShape: (template: ShapeTemplate) => void; locale?: string }`
       - Renders SHAPES_BY_CATEGORY from shapeCategories.ts
       - Layout: vertical list grouped by category with category headers
       - Each category header: small text, bold, with French/English label from CATEGORY_LABELS
       - Each shape item: clickable card/button showing icon + label (use labelFr when locale='fr')
       - Style: compact grid (2 columns) within each category, items have border, rounded, hover:bg-gray-50, p-2
       - On click, calls onAddShape(template) -- the parent handles adding to graph
       - Use UI Kit Surface for the palette container, but keep items as simple styled divs for compactness
       - Entire palette has max-height with overflow-y-auto so it scrolls if many shapes

    2. Create `components/exams/graph-editor/SimpleGraphEditor.tsx`:
       - 'use client' directive
       - Props: GraphEditorProps (value, onChange, locale)
       - Layout: flex row with ShapePalette on left (w-48) and GraphCanvas in center (flex-1)
       - State: selectedId (string | null) for currently selected element
       - Shape insertion workflow (PowerPoint-style: click in palette to add, then drag on canvas):
         a. When ShapePalette calls onAddShape, call template.createElements(graph.axes) to get new elements
         b. Merge new elements into the current graph payload arrays (spread existing + new)
         c. Call onChange with the updated graph payload -- this updates the `value` prop
         d. Pass the updated `value` as the `graph` prop to `<GraphCanvas graph={value} .../>` so the canvas re-renders showing the new shape
         e. Auto-select the newly added element (set selectedId to its id) so the user can immediately drag/position it
         NOTE: Shapes are placed at sensible defaults from the template. Once on canvas, they are fully draggable via react-konva (drag handlers from Plan 02). This click-then-drag workflow mirrors PowerPoint (click shape in ribbon, shape appears on slide, drag to position).
       - Element deletion: when Delete key pressed and selectedId is set, remove the element from the appropriate array (find which array contains an element with that id), call onChange
       - Below the canvas: a mini properties bar showing selected element info:
         - If point selected: show x, y coordinates as editable number inputs, color picker
         - If line selected: show start/end coordinates, style options
         - If function selected: show expression input, domain min/max, color
         - If nothing selected: show "Cliquez sur un element pour le modifier" hint text
       - The properties bar should be compact (single row of inputs) -- NOT a full form like Advanced mode
       - Axes configuration: add a small collapsible "Axes" panel below the canvas with the basic axes settings (xMin, xMax, yMin, yMax, showGrid, gridStep). Use a disclosure/chevron toggle. Default collapsed.
       - Wire keyboard event: listen for Delete/Backspace key on the canvas container (not globally) to delete selected element

    IMPORTANT: Do NOT use dnd-kit for palette-to-canvas drag. Click-to-add is the insertion method. Shapes become draggable ON the canvas via react-konva drag handlers (built in Plan 02). This two-step flow (click to insert, drag to position) IS the PowerPoint-like experience.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - ShapePalette renders categorized shape items
    - SimpleGraphEditor shows palette on left, canvas on right
    - Clicking a shape template calls onChange with updated GraphPayload containing the new elements
    - The GraphCanvas receives the updated graph prop and re-renders showing the newly added shape visually on the canvas
    - Newly added shape is auto-selected and can be immediately dragged to reposition
    - Selected element shows properties bar below canvas
  </verify>
  <done>
    Simple mode editor complete: shape palette with click-to-add, interactive canvas with drag-to-position (PowerPoint-style workflow), properties bar, axes config panel. GraphCanvas correctly re-renders when new shapes are added via palette.
  </done>
</task>

<task type="auto">
  <name>Task 2: GraphEditorWrapper with mode switching</name>
  <files>
    components/exams/graph-editor/GraphEditorWrapper.tsx
  </files>
  <action>
    Create `components/exams/graph-editor/GraphEditorWrapper.tsx`:

    1. 'use client' directive
    2. Props: `{ value: GraphPayload; onChange: (payload: GraphPayload) => void; onConfirm?: () => void; onCancel?: () => void; onDelete?: () => void; locale?: string }`
       - onConfirm/onCancel/onDelete are optional -- used when wrapper is used as a popup editor (for backwards compat)
    3. State: `mode: EditorMode` (default 'simple')
    4. Header bar:
       - Title: "Editeur de graphique" / "Graph Editor" (using Text component from UI Kit if available, otherwise styled span)
       - Mode switcher: two-button toggle group (like segmented control). "Simple" and "Avance" buttons. Active button has primary style, inactive has ghost style. Use UI Kit Button if appropriate, or simple styled buttons.
       - Action buttons (if onConfirm/onCancel/onDelete provided):
         - Confirm (check icon, green)
         - Cancel (X icon, gray)
         - Delete graph (trash icon, red) -- with confirmation pattern
    5. Body:
       - When mode === 'simple': render `<SimpleGraphEditor value={value} onChange={onChange} locale={locale} />`
       - When mode === 'advanced': render `<AdvancedGraphEditor value={value} onChange={onChange} locale={locale} />`
    6. Both modes share the SAME value and onChange -- switching modes preserves all data
    7. The wrapper has a clean border, rounded corners, shadow, white background
    8. Overall sizing: wrapper takes available width, max-width ~56rem (similar to current popup but can be wider)
    9. Export `GraphEditorWrapper` as the main public API for the graph editor

    Style guidelines:
    - Clean, modern UI consistent with the rest of Correcta
    - Mode toggle should feel like Figma/Notion mode switches -- subtle, not heavy tabs
    - Good spacing, not cramped
    - Use Tailwind classes consistent with UI Kit patterns (text-sm, rounded-lg, shadow-lg, border-gray-200)
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - GraphEditorWrapper renders mode toggle and switches between SimpleGraphEditor and AdvancedGraphEditor
    - Both modes receive same value/onChange props
    - Mode switch preserves graph data (adding element in simple, switching to advanced, element still visible)
    - Action buttons (confirm/cancel/delete) work when provided
  </verify>
  <done>
    GraphEditorWrapper provides clean dual-mode interface. Mode toggle switches between Simple and Advanced editors. Shared state means no data loss on switch.
  </done>
</task>

</tasks>

<verification>
- ShapePalette shows 12 shapes across 4 categories
- Clicking a shape in Simple mode adds it to the canvas AND the shape visually appears on the GraphCanvas
- Shapes on canvas are draggable after insertion (PowerPoint-style workflow)
- Mode switcher toggles between Simple and Advanced without losing data
- Selected element shows inline properties editor
- Delete key removes selected element
- TypeScript compiles clean
</verification>

<success_criteria>
- Complete dual-mode graph editor: Simple (palette + canvas + properties) and Advanced (form-based)
- Mode switching preserves all graph data
- Shape palette click-to-add flow works end-to-end: click in palette -> shape appears on canvas -> drag to position
- Clean, modern UI matching Correcta design language
</success_criteria>

<output>
After completion, create `.planning/phases/09-graph-editor-overhaul/09-03-SUMMARY.md`
</output>
