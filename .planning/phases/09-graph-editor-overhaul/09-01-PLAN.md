---
phase: 09-graph-editor-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - components/exams/graph-editor/types.ts
  - components/exams/graph-editor/coordinate-utils.ts
  - components/exams/graph-editor/templates/predefinedShapes.ts
  - components/exams/graph-editor/templates/shapeCategories.ts
  - components/exams/graph-editor/AdvancedGraphEditor.tsx
autonomous: true

must_haves:
  truths:
    - "react-konva, konva, and @dnd-kit/core are installed and importable"
    - "Coordinate conversion between graph space and pixel space works correctly (Y-axis inverted)"
    - "Predefined shapes library contains at least 10 common math shapes across 4 categories"
    - "Advanced mode editor extracted from SegmentedMathField works identically to current InlineGraphEditor"
  artifacts:
    - path: "components/exams/graph-editor/types.ts"
      provides: "EditorMode type, GraphEditorProps, shared interfaces"
      exports: ["EditorMode", "GraphEditorProps", "GraphPayload"]
    - path: "components/exams/graph-editor/coordinate-utils.ts"
      provides: "graphToPixel, pixelToGraph coordinate conversion"
      exports: ["graphToPixel", "pixelToGraph"]
    - path: "components/exams/graph-editor/templates/predefinedShapes.ts"
      provides: "PREDEFINED_SHAPES array with shape templates"
      exports: ["PREDEFINED_SHAPES", "ShapeTemplate"]
    - path: "components/exams/graph-editor/templates/shapeCategories.ts"
      provides: "SHAPES_BY_CATEGORY grouped shapes"
      exports: ["SHAPES_BY_CATEGORY", "ShapeCategory"]
    - path: "components/exams/graph-editor/AdvancedGraphEditor.tsx"
      provides: "Extracted form-based graph editor (current InlineGraphEditor logic)"
      exports: ["AdvancedGraphEditor"]
  key_links:
    - from: "components/exams/graph-editor/coordinate-utils.ts"
      to: "types/exams.ts"
      via: "GraphAxes type import"
      pattern: "import.*GraphAxes.*from.*types/exams"
    - from: "components/exams/graph-editor/templates/predefinedShapes.ts"
      to: "types/exams.ts"
      via: "GraphSegment element types"
      pattern: "import.*Graph(Function|Point|Line).*from.*types/exams"
    - from: "components/exams/graph-editor/AdvancedGraphEditor.tsx"
      to: "components/exams/graph-utils.ts"
      via: "renderGraphInto for preview"
      pattern: "import.*renderGraphInto.*from.*graph-utils"
---

<objective>
Install canvas/DnD dependencies, create shared graph editor infrastructure (types, coordinate utilities, predefined shapes library), and extract the existing InlineGraphEditor from SegmentedMathField.tsx into a standalone AdvancedGraphEditor component.

Purpose: Establishes the foundation that both Simple and Advanced modes will share. The extraction decouples the graph editor from the 6500-line SegmentedMathField, making it maintainable and extensible.

Output: New graph-editor/ directory with types, utilities, shape templates, and working AdvancedGraphEditor.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-graph-editor-overhaul/09-RESEARCH.md
@types/exams.ts
@components/exams/graph-utils.ts
@components/exams/SegmentedMathField.tsx
@lib/content.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create shared infrastructure</name>
  <files>
    package.json
    components/exams/graph-editor/types.ts
    components/exams/graph-editor/coordinate-utils.ts
    components/exams/graph-editor/templates/predefinedShapes.ts
    components/exams/graph-editor/templates/shapeCategories.ts
  </files>
  <action>
    1. Install react-konva, konva, and @dnd-kit/core:
       `npm install react-konva konva @dnd-kit/core`

    2. Create `components/exams/graph-editor/types.ts`:
       - Export `EditorMode = 'simple' | 'advanced'` type
       - Export `GraphPayload` type (same shape as what InlineGraphEditor currently uses internally -- it's the GraphSegment minus `id` and `type` fields, so: `Omit<GraphSegment, 'id' | 'type'>`)
       - Export `GraphEditorProps` interface: `{ value: GraphPayload; onChange: (payload: GraphPayload) => void; locale?: string }`
       - Re-export relevant types from `@/types/exams` for convenience (GraphAxes, GraphPoint, GraphLine, GraphCurve, GraphFunction, GraphArea, GraphText, GraphAnchor, GraphStrokeStyle, GraphFillStyle)

    3. Create `components/exams/graph-editor/coordinate-utils.ts`:
       - `graphToPixel(point: {x: number, y: number}, axes: GraphAxes, canvasWidth: number, canvasHeight: number): {x: number, y: number}` -- converts graph coordinates to canvas pixel coordinates. Formula: pixelX = ((point.x - axes.xMin) / (axes.xMax - axes.xMin)) * canvasWidth, pixelY = canvasHeight - ((point.y - axes.yMin) / (axes.yMax - axes.yMin)) * canvasHeight (Y is inverted)
       - `pixelToGraph(pixel: {x: number, y: number}, axes: GraphAxes, canvasWidth: number, canvasHeight: number): {x: number, y: number}` -- inverse of above
       - `snapToGrid(value: number, gridStep: number): number` -- rounds to nearest grid step
       - Add unit test comments documenting expected values (e.g., graph (0,0) with axes -5..5 on 480x280 canvas = pixel (240, 140))

    4. Create `components/exams/graph-editor/templates/predefinedShapes.ts`:
       - Define `ShapeTemplate` type: `{ id: string; category: ShapeCategory; label: string; labelFr: string; icon: string; description: string; descriptionFr: string; createElements: (axes: GraphAxes) => Partial<GraphPayload> }`
       - Export `PREDEFINED_SHAPES` array with these templates:
         - Functions (4): Parabole (x^2), Sinusoide (sin(x)), Lineaire (x), Exponentielle (exp(x))
         - Lines (3): Asymptote verticale (dashed vertical at x=0), Asymptote horizontale (dashed horizontal at y=0), Segment (solid from (-2,0) to (2,0))
         - Points (2): Point simple (filled at origin), Point ouvert (unfilled at origin)
         - Geometric (3): Courbe de Bezier (curve from (-3,-1) to (3,1) with curvature 2), Surface polygone (triangle), Surface sous courbe (under x^2 function)
       - Each template uses `createId()` from the same utility used elsewhere (crypto.randomUUID or fallback)
       - Use sensible default colors: functions=#2563eb, curves=#7c3aed, points=#111827, areas with opacity 0.2

    5. Create `components/exams/graph-editor/templates/shapeCategories.ts`:
       - Define `ShapeCategory = 'functions' | 'lines' | 'points' | 'geometric'`
       - Export `CATEGORY_LABELS: Record<ShapeCategory, { label: string; labelFr: string }>` with French/English labels
       - Export `SHAPES_BY_CATEGORY` computed from PREDEFINED_SHAPES grouped by category
  </action>
  <verify>
    - `npm ls react-konva konva @dnd-kit/core` shows all three installed
    - TypeScript compiles: `npx tsc --noEmit` passes (or at minimum the new files have no red squiggles)
    - Each file exports the documented types/functions
  </verify>
  <done>
    Dependencies installed. Types, coordinate utilities, and 12 predefined shape templates created across 4 categories.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract AdvancedGraphEditor from SegmentedMathField</name>
  <files>
    components/exams/graph-editor/AdvancedGraphEditor.tsx
    components/exams/SegmentedMathField.tsx
  </files>
  <action>
    Extract the InlineGraphEditor (lines ~1332-2350 in SegmentedMathField.tsx) into a standalone component:

    1. Create `components/exams/graph-editor/AdvancedGraphEditor.tsx`:
       - Copy the entire InlineGraphEditor function body (state management, all update/add/remove handlers, renderAnchorEditor helper, the JSX render)
       - BUT change the component signature: instead of the popup-specific props (anchorRef, onConfirm, onCancel, onDelete), use the `GraphEditorProps` interface from types.ts: `{ value: GraphPayload; onChange: (payload: GraphPayload) => void; locale?: string }`
       - Remove all popup positioning logic (useLayoutEffect for position, click-outside handling) -- this component renders inline, not as a popup
       - Keep the preview panel (uses renderGraphInto from graph-utils.ts)
       - Keep ALL form sections: Axes config, Points, Lines, Curves, Functions, Areas, Texts
       - Keep the delete confirmation pattern (pendingDelete state)
       - Keep all French/English labels (locale prop)
       - Import renderGraphInto from `@/components/exams/graph-utils`
       - Import normalizeGraphPayload from `@/lib/content`
       - Import GraphPayload from `./types`
       - Use UI Kit components where easy wins exist (Surface for sections, Button for actions) but don't over-migrate -- keep form elements simple since this is a dense editor
       - The component should call `onChange(updatedPayload)` whenever any field changes (same as current onChangeDraft behavior)

    2. Update SegmentedMathField.tsx:
       - DO NOT remove InlineGraphEditor yet. The popup wrapper still needs to exist for the current integration.
       - Instead, leave InlineGraphEditor in place for now. Plan 03 will handle the full integration swap.
       - This task focuses ONLY on creating the standalone AdvancedGraphEditor that can be used by the new GraphEditorWrapper.

    IMPORTANT: The AdvancedGraphEditor must produce the exact same GraphPayload output as the current InlineGraphEditor. Do not change the data model. The existing graph-utils.ts renderer and normalizeGraphPayload must work unchanged with the output.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - AdvancedGraphEditor.tsx exports a React component that accepts GraphEditorProps
    - Component contains all 6 element type sections (Points, Lines, Curves, Functions, Areas, Texts) plus Axes config
    - Preview rendering uses renderGraphInto from graph-utils.ts
  </verify>
  <done>
    AdvancedGraphEditor is a standalone component with identical functionality to InlineGraphEditor but without popup positioning. Accepts GraphEditorProps, renders inline form-based editor with live preview.
  </done>
</task>

</tasks>

<verification>
- All new files in components/exams/graph-editor/ compile without errors
- react-konva, konva, @dnd-kit/core are in package.json dependencies
- PREDEFINED_SHAPES contains 12 templates across 4 categories
- coordinate-utils exports graphToPixel and pixelToGraph with correct Y-axis inversion
- AdvancedGraphEditor renders the same form UI as current InlineGraphEditor
</verification>

<success_criteria>
- Foundation infrastructure (types, utils, templates) ready for Simple mode to consume
- AdvancedGraphEditor works as standalone component
- No changes to existing InlineGraphEditor behavior (non-breaking)
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/09-graph-editor-overhaul/09-01-SUMMARY.md`
</output>
