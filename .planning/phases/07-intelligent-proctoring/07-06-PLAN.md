---
phase: 07-intelligent-proctoring
plan: 06
type: execute
wave: 5
depends_on: ["07-05"]
files_modified:
  - lib/antiCheat.ts
  - app/api/attempts/[id]/anti-cheat/route.ts
  - app/dashboard/exams/[examId]/grading/[attemptId]/GradingView.tsx
autonomous: false

must_haves:
  truths:
    - "Anti-cheat score includes AI-detected events in its calculation"
    - "Grading view shows proctoring summary alongside grades"
    - "Full proctoring flow works end-to-end: config -> consent -> capture -> analysis -> review"
    - "Human verifies the complete flow with a test exam"
  artifacts:
    - path: "lib/antiCheat.ts"
      provides: "Updated score calculation including AI event weights"
      contains: "LOOKING_AWAY"
    - path: "app/api/attempts/[id]/anti-cheat/route.ts"
      provides: "Updated anti-cheat API with AI event counts"
      contains: "aiFlags"
  key_links:
    - from: "lib/antiCheat.ts"
      to: "ProctorEventType"
      via: "AI event type weights in score formula"
      pattern: "LOOKING_AWAY|MULTIPLE_FACES|ABSENCE"
    - from: "app/dashboard/exams/[examId]/grading/[attemptId]/GradingView.tsx"
      to: "/api/attempts/[id]/anti-cheat"
      via: "fetch for proctoring summary in grading context"
      pattern: "anti-cheat"
---

<objective>
Complete the proctoring integration: update the anti-cheat scoring to include AI events, add proctoring context to the grading view, and verify the full end-to-end flow.

Purpose: Final wiring and verification. Ensures all proctoring components work together and teachers see proctoring data where it matters most — while grading.
Output: Updated anti-cheat scoring, proctoring context in grading, verified end-to-end flow.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-intelligent-proctoring/07-01-SUMMARY.md
@.planning/phases/07-intelligent-proctoring/07-02-SUMMARY.md
@.planning/phases/07-intelligent-proctoring/07-03-SUMMARY.md
@.planning/phases/07-intelligent-proctoring/07-04-SUMMARY.md
@.planning/phases/07-intelligent-proctoring/07-05-SUMMARY.md
@lib/antiCheat.ts
@app/api/attempts/[id]/anti-cheat/route.ts
@app/dashboard/exams/[examId]/grading/[attemptId]/GradingView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update anti-cheat scoring and add proctoring context to grading</name>
  <files>
    lib/antiCheat.ts
    app/api/attempts/[id]/anti-cheat/route.ts
    app/dashboard/exams/[examId]/grading/[attemptId]/GradingView.tsx
  </files>
  <action>
1. Update `lib/antiCheat.ts`:
   - Add AI event weights to `computeAntiCheatScore`:
     - ABSENCE: weight 5 (student not present is highly suspicious)
     - MULTIPLE_FACES: weight 8 (strongest indicator)
     - LOOKING_AWAY: weight 2 (common, many false positives)
     - SUSPICIOUS_BEHAVIOR: weight 4
     - RIGHT_CLICK: weight 1 (minor)
     - DEVTOOLS_OPEN: weight 3
     - SCREEN_SHARE_ATTEMPT: weight 6
     - WEBCAM_SNAPSHOT: weight 0 (not suspicious, just a capture)
   - Update the score formula doc comment to include the new weights
   - Ensure backward compatibility: existing events (FOCUS_LOST, TAB_SWITCH) keep same weights

2. Update `app/api/attempts/[id]/anti-cheat/route.ts`:
   - Add AI-specific summary to response:
     - `aiFlags`: count of events with metadata.aiGenerated === true
     - `flaggedSnapshots`: array of { type, snapshotUrl, confidence, description, timestamp } for events with snapshotUrl
     - Cap flaggedSnapshots to last 10 (most recent) to keep response size manageable
   - Keep existing response fields (antiCheatScore, eventCounts, totalEvents, copyPasteAnalysis) for backward compatibility

3. Update `app/dashboard/exams/[examId]/grading/[attemptId]/GradingView.tsx`:
   - Read the full file first to understand the grading view layout
   - Add a collapsible "Proctoring" section to the grading view (near the top, after student info):
     a. Fetch anti-cheat data from `/api/attempts/${attemptId}/anti-cheat`
     b. Show suspicion score with color badge (reuse getSuspicionColor pattern from ProctoringSummary)
     c. Show AI flag count with brief summary: "2 flags IA detectes" with link to full proctoring detail
     d. Show up to 3 flagged snapshot thumbnails (if any) with confidence scores
     e. Link "Voir le detail complet" -> `/dashboard/exams/${examId}/proctoring/${attemptId}`
   - This section should be collapsed by default (teacher can expand to see)
   - If no proctoring events exist, show "Aucun evenement de proctoring" in muted text
   - Use UI Kit components consistent with the rest of the grading view

IMPORTANT: The grading view is a critical page. Do NOT break existing functionality. The proctoring section is purely additive — an optional collapsible panel. Keep it lightweight (single API call, no heavy images loading by default).
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npm run build` — builds successfully.
    Grep for "LOOKING_AWAY" in antiCheat.ts (new weight).
    Grep for "aiFlags" in anti-cheat/route.ts.
    Grep for "proctoring" in GradingView.tsx (case-insensitive).
  </verify>
  <done>
    Anti-cheat score includes AI event weights. Anti-cheat API returns AI flag summary. Grading view has collapsible proctoring section with score, AI flags, and snapshot thumbnails.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete proctoring suite across 6 plans:
    - Plan 01: Schema extension, proctoring queue, config types, ProctoringConfigPanel
    - Plan 02: Browser lockdown (tab switch, copy/paste, right-click, DevTools detection)
    - Plan 03: Webcam capture with periodic snapshots, camera permission check, consent flow
    - Plan 04: GPT-4 Vision snapshot analysis BullMQ worker
    - Plan 05: Teacher review dashboard with AI flags, snapshot thumbnails, confidence scores
    - Plan 06: Anti-cheat score update, proctoring in grading view
  </what-built>
  <how-to-verify>
    1. Create a test exam with proctoring enabled:
       - Go to teacher exam editor
       - Expand "Proctoring / Anti-triche" section
       - Enable proctoring, enable webcam, enable lockdown
       - Set sensitivity to "Moyen" and interval to 60s
       - Save the exam

    2. Start the exam as a student:
       - Open the exam start page
       - Verify camera permission check appears
       - Verify consent checkbox is required
       - Allow camera and check consent
       - Start the exam

    3. During the exam:
       - Verify webcam preview in bottom-right corner
       - Switch to another tab — verify warning banner appears
       - Right-click — verify context menu is prevented
       - Verify no errors in browser console

    4. After submitting:
       - Start the proctoring worker: `npm run worker:proctoring`
       - Check that snapshot analysis jobs are processed (check worker logs)
       - Go to teacher dashboard -> exam proctoring page
       - Verify summary table shows student with event counts and AI flags
       - Click "Details" to see timeline
       - Verify snapshot thumbnails appear for AI events
       - Verify confidence scores displayed

    5. In the grading view:
       - Navigate to a student's grading page
       - Verify "Proctoring" collapsible section appears
       - Expand it and verify score + AI flags shown
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Anti-cheat score weights updated for AI events
2. Anti-cheat API returns aiFlags and flaggedSnapshots
3. Grading view shows proctoring section
4. Full end-to-end flow: config -> consent -> capture -> analysis -> review
5. No regression in grading view or exam-taking flow
</verification>

<success_criteria>
- Anti-cheat scoring includes AI event weights (ABSENCE: 5, MULTIPLE_FACES: 8, etc.)
- Anti-cheat API response includes aiFlags count and flaggedSnapshots array
- Grading view has collapsible proctoring section with score and AI summary
- Human verifies complete flow works end-to-end
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligent-proctoring/07-06-SUMMARY.md`
</output>
