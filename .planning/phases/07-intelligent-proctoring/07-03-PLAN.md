---
phase: 07-intelligent-proctoring
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - components/exams/WebcamCapture.tsx
  - components/exams/CameraPermissionCheck.tsx
  - app/api/attempts/[id]/proctor-snapshots/route.ts
  - app/student/exams/[examId]/take/ExamStartPage.tsx
  - app/student/attempts/[attemptId]/ExamRoomClient.tsx
autonomous: true

must_haves:
  truths:
    - "Webcam preview is visible to student during proctored exam"
    - "Snapshots are captured at configurable intervals and uploaded to MinIO"
    - "Pre-exam camera permission check verifies camera works before exam starts"
    - "Snapshot upload API stores image in MinIO and enqueues analysis job"
    - "Camera indicator is visible but non-intrusive during exam"
    - "Each snapshot capture logs a WEBCAM_SNAPSHOT event to the proctor-events API"
  artifacts:
    - path: "components/exams/WebcamCapture.tsx"
      provides: "Webcam preview with periodic snapshot capture"
      min_lines: 60
    - path: "components/exams/CameraPermissionCheck.tsx"
      provides: "Pre-exam camera permission verification UI"
      min_lines: 40
    - path: "app/api/attempts/[id]/proctor-snapshots/route.ts"
      provides: "POST endpoint for snapshot upload to MinIO + queue"
      min_lines: 40
  key_links:
    - from: "components/exams/WebcamCapture.tsx"
      to: "/api/attempts/[id]/proctor-snapshots"
      via: "fetch POST with FormData"
      pattern: "proctor-snapshots"
    - from: "components/exams/WebcamCapture.tsx"
      to: "/api/attempts/[id]/proctor-events"
      via: "fetch POST with WEBCAM_SNAPSHOT type after each capture"
      pattern: "proctor-events.*WEBCAM_SNAPSHOT"
    - from: "app/api/attempts/[id]/proctor-snapshots/route.ts"
      to: "lib/queue.ts"
      via: "proctoringQueue.add()"
      pattern: "proctoringQueue"
    - from: "app/api/attempts/[id]/proctor-snapshots/route.ts"
      to: "MinIO"
      via: "S3 client upload"
      pattern: "putObject|upload"
---

<objective>
Build webcam capture during proctored exams with periodic snapshots uploaded to MinIO, a pre-exam camera permission check, and a snapshot upload API that enqueues jobs for AI analysis.

Purpose: PROCT-01 webcam capture. Captures periodic snapshots for later AI analysis without continuous recording (privacy-conscious, cost-effective).
Output: WebcamCapture component, CameraPermissionCheck component, and snapshot upload API endpoint.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-intelligent-proctoring/07-RESEARCH.md
@.planning/phases/07-intelligent-proctoring/07-01-SUMMARY.md
@app/api/attempts/[id]/proctor-events/route.ts
@app/student/attempts/[attemptId]/ExamRoomClient.tsx
@app/student/exams/[examId]/take/ExamStartPage.tsx
@lib/queue.ts
@lib/proctoring/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-webcam, create WebcamCapture and CameraPermissionCheck</name>
  <files>
    components/exams/WebcamCapture.tsx
    components/exams/CameraPermissionCheck.tsx
  </files>
  <action>
1. Run `npm install react-webcam` to add the dependency.

2. Create `components/exams/CameraPermissionCheck.tsx`:
   - "use client" component
   - Props: `{ onPermissionGranted: () => void, onSkip?: () => void }`
   - Uses navigator.mediaDevices.getUserMedia({ video: true }) to test camera access
   - Three states: 'checking' | 'granted' | 'denied' | 'prompt'
   - On mount: check permission using Permissions API if available, then try getUserMedia
   - Stop all tracks after test (we're just verifying)
   - When 'granted': show green checkmark, "Camera autorisee", call onPermissionGranted
   - When 'denied': show red X, "Acces camera refuse", instructions to click lock icon in address bar to allow
   - When 'prompt': show camera icon, "Autoriser l'acces a la camera", with a "Verifier la camera" button that triggers getUserMedia
   - Use UI Kit components (Card, CardBody, Stack, Text, Button, Badge)
   - Include a small webcam preview (200x150) when permission is granted so student can verify
   - Stop the preview stream after 3 seconds (don't keep camera open)

3. Create `components/exams/WebcamCapture.tsx`:
   - "use client" component
   - Import Webcam from 'react-webcam'
   - Props: `{ attemptId: string, intervalSeconds: number, csrfToken: string, nonce: string }`
   - Render a small webcam preview in the corner (fixed position, bottom-right, 120x90px, rounded, z-40)
   - Include a small red dot indicator (recording active) and "Camera active" tooltip
   - Use useRef for Webcam component
   - useEffect with setInterval at `intervalSeconds * 1000`:
     a. Call webcamRef.current.getScreenshot() to get base64 JPEG
     b. Convert base64 to Blob via fetch(base64).then(r => r.blob())
     c. Create FormData with blob as 'snapshot' field
     d. POST to `/api/attempts/${attemptId}/proctor-snapshots` with headers: x-csrf-token, x-attempt-nonce, x-request-id (crypto.randomUUID())
     e. After successful snapshot upload, POST a WEBCAM_SNAPSHOT event to `/api/attempts/${attemptId}/proctor-events` with body: `{ type: 'WEBCAM_SNAPSHOT', timestamp: new Date().toISOString(), metadata: {} }` — this ensures the snapshot appears in the proctor event timeline. Use the same CSRF and nonce headers.
     f. Both requests are fire-and-forget (catch errors silently, don't block exam)
   - videoConstraints: { width: 640, height: 480, facingMode: "user" } — lower res to reduce upload size
   - screenshotFormat: "image/jpeg" with screenshotQuality: 0.6 (balance quality vs size)
   - On unmount: clear interval
   - Include a "reduce" button (small icon) that hides the preview but keeps capturing (student can toggle)
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Grep for "react-webcam" in package.json.
    Grep for "getScreenshot" in WebcamCapture.tsx.
    Grep for "WEBCAM_SNAPSHOT" in WebcamCapture.tsx to confirm event logging wiring.
    Grep for "proctor-events" in WebcamCapture.tsx to confirm POST to events API.
  </verify>
  <done>
    CameraPermissionCheck tests and verifies camera access with clear UX. WebcamCapture shows small preview, captures periodic snapshots uploading to the snapshot API, and logs WEBCAM_SNAPSHOT events to the proctor-events API for timeline tracking.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create snapshot upload API and integrate into exam flow</name>
  <files>
    app/api/attempts/[id]/proctor-snapshots/route.ts
    app/student/exams/[examId]/take/ExamStartPage.tsx
    app/student/attempts/[attemptId]/ExamRoomClient.tsx
  </files>
  <action>
1. Create `app/api/attempts/[id]/proctor-snapshots/route.ts`:
   - Follow the EXACT same auth pattern as proctor-events/route.ts (session check, CSRF, rate limit, attempt auth, nonce verification, idempotency)
   - Rate limit: 30 requests per 60 seconds per user:attempt (snapshots are less frequent than events)
   - Accept multipart FormData with a 'snapshot' field (Blob)
   - Validate file: must be image/jpeg, max 500KB
   - Upload to MinIO using the existing upload pattern in the project:
     a. Find how images are uploaded (look at the image upload API from Phase 2, likely in app/api/upload or similar)
     b. Use the same MinIO client and bucket pattern
     c. Store in path: `proctoring/${attemptId}/${timestamp}.jpg`
     d. Get the public URL for the uploaded image
   - After upload, enqueue a job on proctoringQueue:
     ```typescript
     await proctoringQueue.add('analyze-snapshot', {
       attemptId,
       snapshotUrl: publicUrl,
       timestamp: Date.now(),
       sensitivity: 'medium' // TODO: read from exam config in worker
     })
     ```
   - Return { success: true, snapshotUrl }

   IMPORTANT: Read the existing image upload code first (grep for "MinIO" or "minio" or "putObject" in the codebase) to find the existing upload pattern. Reuse the same client configuration.

2. Integrate CameraPermissionCheck into ExamStartPage.tsx:
   - Read the full ExamStartPage.tsx to understand the layout
   - Import CameraPermissionCheck
   - Parse exam.antiCheatConfig as ProctoringConfig
   - When `proctoringConfig.enabled && proctoringConfig.webcamEnabled`:
     a. Show a proctoring notice section before the Start button: "Cet examen utilise le proctoring avec surveillance webcam. Vous devrez autoriser l'acces a votre camera."
     b. Show CameraPermissionCheck component
     c. Disable the "Start Exam" button until camera permission is granted
     d. Show a consent checkbox: "J'accepte la surveillance webcam pendant cet examen" (must be checked to proceed)
   - When proctoring is not enabled, no change to existing flow

3. Integrate WebcamCapture into ExamRoomClient.tsx:
   - Import WebcamCapture
   - When `proctoringConfig.enabled && proctoringConfig.webcamEnabled`:
     a. Render WebcamCapture with attemptId, intervalSeconds from config, csrfToken, nonce
   - The webcam preview appears in bottom-right corner during exam
   - If BrowserLockdown was already added by Plan 02, both components coexist

CRITICAL: Do not break existing exam start or exam room flow. All proctoring additions are conditional on config.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npm run build` — builds successfully.
    Grep for "proctor-snapshots" in the API directory.
    Grep for "WebcamCapture" in ExamRoomClient.tsx.
    Grep for "CameraPermissionCheck" in ExamStartPage.tsx.
    Grep for "minio\|MinIO\|putObject\|upload" in app/api/attempts/[id]/proctor-snapshots/route.ts to confirm MinIO upload pattern was found and used.
  </verify>
  <done>
    Snapshot upload API stores to MinIO (verified by grep) and enqueues analysis job. ExamStartPage shows camera check and consent when webcam proctoring enabled. ExamRoomClient shows webcam preview and captures snapshots during exam.
  </done>
</task>

</tasks>

<verification>
1. `npm install react-webcam` succeeds
2. `npx tsc --noEmit` passes
3. `npm run build` succeeds
4. Snapshot upload API validates image, stores to MinIO, enqueues job
5. MinIO client usage confirmed in proctor-snapshots/route.ts (grep for putObject/upload)
6. Camera permission check works before exam start
7. Webcam preview visible during proctored exam
8. Snapshots captured at configured interval
9. WEBCAM_SNAPSHOT events logged to proctor-events API after each capture
10. No impact when proctoring disabled
</verification>

<success_criteria>
- react-webcam installed and working
- Camera permission verified before exam starts
- Student sees webcam preview during exam
- Snapshots uploaded to MinIO at configured intervals
- MinIO upload follows existing codebase pattern (not hand-rolled)
- Jobs enqueued on proctoring-analysis queue
- WEBCAM_SNAPSHOT events posted to proctor-events API for timeline
- Consent required before starting webcam-proctored exam
- No regression when proctoring is off
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligent-proctoring/07-03-SUMMARY.md`
</output>
