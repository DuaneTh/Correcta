---
phase: 07-intelligent-proctoring
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - components/proctoring/ProctoringProvider.tsx
  - components/proctoring/WebcamDeterrent.tsx
  - components/proctoring/BrowserLockdownMonitor.tsx
  - app/student/attempts/[attemptId]/ExamRoomClient.tsx
  - app/student/attempts/[attemptId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Student opening a proctored exam sees camera permission prompt"
    - "Active camera indicator visible during exam when webcam deterrent enabled"
    - "Tab switch triggers a FOCUS_LOST or TAB_SWITCH event sent to API"
    - "Pasting text from external source includes isExternal: true in metadata"
    - "No webcam prompt shown when webcamDeterrent is disabled"
    - "No lockdown events logged when browserLockdown is disabled"
  artifacts:
    - path: "components/proctoring/ProctoringProvider.tsx"
      provides: "Context provider orchestrating proctoring features"
      min_lines: 30
    - path: "components/proctoring/WebcamDeterrent.tsx"
      provides: "Camera permission prompt and active indicator"
      min_lines: 30
    - path: "components/proctoring/BrowserLockdownMonitor.tsx"
      provides: "Tab switch, focus loss, and paste origin detection"
      min_lines: 50
  key_links:
    - from: "components/proctoring/BrowserLockdownMonitor.tsx"
      to: "/api/attempts/[id]/proctor-events"
      via: "fetch POST to log events"
      pattern: "proctor-events"
    - from: "app/student/attempts/[attemptId]/ExamRoomClient.tsx"
      to: "components/proctoring/ProctoringProvider.tsx"
      via: "wraps exam content"
      pattern: "ProctoringProvider"
---

<objective>
Build the client-side proctoring monitor that runs during exam taking: webcam deterrent (camera permission + green indicator, NO recording), browser lockdown (tab switches, focus loss, paste origin detection), all sending events to the existing proctor-events API.

Purpose: This is the student-facing proctoring experience. Webcam deterrent intimidates without recording. Browser lockdown detects and logs suspicious browser behavior.
Output: ProctoringProvider wrapping the exam room, with WebcamDeterrent and BrowserLockdownMonitor components.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-intelligent-proctoring/07-01-SUMMARY.md
@lib/proctoring/types.ts
@app/student/attempts/[attemptId]/ExamRoomClient.tsx
@app/student/attempts/[attemptId]/page.tsx
@app/api/attempts/[id]/proctor-events/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProctoringProvider, WebcamDeterrent, and BrowserLockdownMonitor</name>
  <files>
    components/proctoring/ProctoringProvider.tsx
    components/proctoring/WebcamDeterrent.tsx
    components/proctoring/BrowserLockdownMonitor.tsx
  </files>
  <action>
    1. **WebcamDeterrent.tsx** ("use client"):
    - On mount, call `navigator.mediaDevices.getUserMedia({ video: true })` to trigger camera permission prompt
    - If granted: store the MediaStream in a ref, show a small green dot indicator (position: fixed, top-right corner) with text "Camera active" (or a camera icon)
    - If denied: show an orange indicator "Camera refused" - still log it but do not block the exam
    - On unmount: stop all tracks on the MediaStream (stream.getTracks().forEach(t => t.stop()))
    - Do NOT use react-webcam library. Just native getUserMedia.
    - Do NOT record, capture frames, or send any video data anywhere. The camera stream is ONLY used to keep the permission active and show the indicator.
    - Small floating indicator using Tailwind: `fixed top-4 right-4 z-50 flex items-center gap-2 px-3 py-1.5 rounded-full bg-green-100 text-green-800 text-xs font-medium shadow-sm`

    2. **BrowserLockdownMonitor.tsx** ("use client"):
    - Props: `attemptId: string`, `nonce: string`, `enabled: boolean`
    - If not enabled, render nothing and attach no listeners
    - Uses a `sendEvent(type, metadata)` helper that POSTs to `/api/attempts/${attemptId}/proctor-events` with the same integrity headers pattern used in ExamRoomClient (CSRF token, attempt nonce, request ID)
    - Event detection:
      a) **Tab switch / visibility change**: Listen to `document.addEventListener('visibilitychange', ...)`. When `document.visibilityState === 'hidden'`, send TAB_SWITCH event with metadata `{ originalEvent: 'visibilitychange', visibility: 'hidden' }`. When visible again, send FOCUS_GAINED with metadata `{ originalEvent: 'visibilitychange', visibility: 'visible' }`.
      b) **Window blur/focus**: Listen to `window.addEventListener('blur', ...)` and `window.addEventListener('focus', ...)`. On blur, send FOCUS_LOST with metadata `{ originalEvent: 'blur' }`. On focus, send FOCUS_GAINED with metadata `{ originalEvent: 'focus' }`.
      c) **Paste origin detection**: Listen to `document.addEventListener('paste', ...)`. On paste:
         - Get pasted text from `event.clipboardData.getData('text/plain')`
         - Track the last COPY event: listen to `document.addEventListener('copy', ...)` and store the selected text (`window.getSelection()?.toString()`) and timestamp
         - If a PASTE occurs and the pasted text matches the last copied text (from within the page), it is an internal paste: send PASTE event with metadata `{ pasteLength: text.length, isExternal: false }`
         - If pasted text does NOT match last copied text, it is an external paste: send PASTE event with metadata `{ pasteLength: text.length, isExternal: true }`
         - Also send COPY events with metadata `{ selectionLength: selectedText.length }` (matching existing pattern)
    - Debounce rapid events: If multiple blur/focus events fire within 500ms, only send the last one. Use a simple timeout-based debounce.
    - Clean up all listeners on unmount.

    3. **ProctoringProvider.tsx** ("use client"):
    - Props: `antiCheatConfig: { webcamDeterrent: boolean, browserLockdown: boolean } | null`, `attemptId: string`, `nonce: string`, `children: React.ReactNode`
    - If antiCheatConfig is null or both flags are false, just render children (no proctoring)
    - If webcamDeterrent is true, render WebcamDeterrent
    - If browserLockdown is true, render BrowserLockdownMonitor with attemptId and nonce
    - Always render children

    IMPORTANT:
    - Reuse the same `buildIntegrityHeaders` pattern from ExamRoomClient for CSRF/nonce/requestId headers
    - Extract the integrity headers logic into a shared utility if it makes sense, or duplicate the pattern (it is small: getCsrfToken + randomUUID + nonce)
    - Do NOT block the exam if camera is denied. It is a deterrent only.
    - Do NOT record any video/audio data.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors. Components should compile cleanly.
  </verify>
  <done>
    Three components created: ProctoringProvider orchestrates, WebcamDeterrent handles camera permission + indicator, BrowserLockdownMonitor detects and logs events. All use native browser APIs only.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire ProctoringProvider into ExamRoomClient</name>
  <files>
    app/student/attempts/[attemptId]/page.tsx
    app/student/attempts/[attemptId]/ExamRoomClient.tsx
  </files>
  <action>
    1. **Modify `page.tsx`** (server component):
    - The page already fetches the attempt and exam data
    - Add `antiCheatConfig` to the exam query select (it is already a field on the Exam model)
    - Pass `antiCheatConfig` to ExamRoomClient as a prop

    2. **Modify `ExamRoomClient.tsx`**:
    - Add `antiCheatConfig?: { webcamDeterrent?: boolean, browserLockdown?: boolean } | null` to ExamData type
    - Import ProctoringProvider from @/components/proctoring/ProctoringProvider
    - Wrap the main exam content (everything inside the return statement) with ProctoringProvider
    - Pass antiCheatConfig from exam data, attemptId from attempt.id, and nonce from attempt.nonce
    - The provider handles all conditional rendering internally based on config flags

    Example wiring:
    ```tsx
    return (
      <ProctoringProvider
        antiCheatConfig={exam.antiCheatConfig}
        attemptId={attempt.id}
        nonce={attempt.nonce || ''}
      >
        {/* existing exam room content */}
      </ProctoringProvider>
    )
    ```

    IMPORTANT: Do NOT modify the existing answer saving, timer, or submission logic. Only wrap with ProctoringProvider. The proctoring is an overlay, not a modification of exam flow.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors. Start dev server, navigate to an exam attempt. If antiCheatConfig has webcamDeterrent: true on the exam, browser should prompt for camera permission. If browserLockdown: true, switching tabs should trigger a network request to proctor-events API.
  </verify>
  <done>
    ExamRoomClient wraps content in ProctoringProvider. Camera permission prompt appears when webcamDeterrent enabled. Tab switches and paste events logged when browserLockdown enabled. Exam flow unchanged.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. With webcamDeterrent: true, student sees camera permission prompt and green indicator after granting
3. With browserLockdown: true, switching tabs creates TAB_SWITCH event in ProctorEvent table
4. Pasting external text creates PASTE event with metadata.isExternal: true
5. Pasting text copied from within the exam creates PASTE event with metadata.isExternal: false
6. With both flags false, no camera prompt and no event listeners attached
7. Exam taking flow (answer saving, timer, submit) works identically with and without proctoring
</verification>

<success_criteria>
- Webcam deterrent shows camera prompt + indicator without recording
- Browser lockdown detects tab switches, focus loss, and paste origin
- Events sent to existing proctor-events API with proper integrity headers
- No new npm dependencies
- Exam flow unaffected by proctoring
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligent-proctoring/07-03-SUMMARY.md`
</output>
