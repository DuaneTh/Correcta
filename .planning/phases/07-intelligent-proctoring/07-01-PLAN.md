---
phase: 07-intelligent-proctoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/proctoring/types.ts
  - components/exam-editor/ExamSettingsPanel.tsx
  - components/exam-editor/ExamHeader.tsx
  - components/exam-editor/store.ts
autonomous: true

must_haves:
  truths:
    - "Teacher can toggle webcam deterrent on/off per exam"
    - "Teacher can toggle browser lockdown on/off per exam"
    - "Settings persist to antiCheatConfig JSON field in database"
  artifacts:
    - path: "lib/proctoring/types.ts"
      provides: "AntiCheatConfig type definition"
      contains: "AntiCheatConfig"
    - path: "components/exam-editor/ExamSettingsPanel.tsx"
      provides: "Settings panel with webcam and lockdown toggles"
      min_lines: 40
  key_links:
    - from: "components/exam-editor/ExamSettingsPanel.tsx"
      to: "components/exam-editor/store.ts"
      via: "useExamStore for reading/updating config"
      pattern: "useExamStore"
    - from: "components/exam-editor/ExamHeader.tsx"
      to: "components/exam-editor/ExamSettingsPanel.tsx"
      via: "Settings button opens panel"
      pattern: "ExamSettingsPanel"
---

<objective>
Create the proctoring configuration types and exam settings UI that lets teachers toggle webcam deterrent and browser lockdown independently per exam.

Purpose: Teachers need per-exam control over proctoring features. The webcam is a deterrent only (camera permission prompt + indicator, NO recording). Browser lockdown detects tab switches and focus loss.
Output: AntiCheatConfig type, ExamSettingsPanel component, wired into exam editor via Settings button.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@components/exam-editor/store.ts
@components/exam-editor/ExamHeader.tsx
@app/api/exams/[examId]/route.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create proctoring types and extend exam editor store</name>
  <files>
    lib/proctoring/types.ts
    components/exam-editor/store.ts
  </files>
  <action>
    1. Create `lib/proctoring/types.ts` with the AntiCheatConfig interface:
    ```typescript
    export interface AntiCheatConfig {
      webcamDeterrent: boolean  // Show camera permission prompt + indicator (no recording)
      browserLockdown: boolean  // Detect tab switches, focus loss, external paste
    }

    export const DEFAULT_ANTI_CHEAT_CONFIG: AntiCheatConfig = {
      webcamDeterrent: false,
      browserLockdown: false,
    }
    ```

    2. Extend `components/exam-editor/store.ts`:
    - Import AntiCheatConfig from lib/proctoring/types
    - Add `antiCheatConfig: AntiCheatConfig` to the EditorExam interface (with default { webcamDeterrent: false, browserLockdown: false })
    - Add `updateAntiCheatConfig: (config: Partial<AntiCheatConfig>) => void` action to the store
    - The action should merge partial config into existing, then persist via PATCH to `/api/exams/${examId}` with body `{ antiCheatConfig: mergedConfig }` (the existing API already handles antiCheatConfig updates)
    - Follow the same debounced-save pattern used by updateMetadata (if one exists) or save immediately

    IMPORTANT: The existing Prisma schema already has `antiCheatConfig Json?` on Exam model and the PUT/PATCH endpoint already handles `body.antiCheatConfig`. No API changes needed. The old shape was `{ webcam: boolean, screen: boolean }` - the new shape replaces it with `{ webcamDeterrent: boolean, browserLockdown: boolean }`. This is safe because the field is Json? and no code currently reads the old shape in any meaningful way.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify types compile. Check that store.ts has no type errors.
  </verify>
  <done>
    AntiCheatConfig type exported from lib/proctoring/types.ts. EditorExam includes antiCheatConfig. Store has updateAntiCheatConfig action that persists to API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ExamSettingsPanel and wire into ExamHeader</name>
  <files>
    components/exam-editor/ExamSettingsPanel.tsx
    components/exam-editor/ExamHeader.tsx
  </files>
  <action>
    1. Create `components/exam-editor/ExamSettingsPanel.tsx`:
    - A slide-out panel or dropdown triggered from ExamHeader's Settings button
    - Use the project's UI Kit components (Surface, Stack, Text, Button from @/components/ui/*)
    - Show two toggle sections:
      a) "Webcam deterrent" (webcamDeterrent toggle)
         - Description: "Demande l'autorisation camera a l'etudiant. La camera est activee comme moyen de dissuasion uniquement (aucun enregistrement, aucune capture)."
      b) "Verrouillage navigateur" (browserLockdown toggle)
         - Description: "Detecte les changements d'onglet, les pertes de focus et les collages depuis des sources externes."
    - Each toggle should be a simple checkbox or switch input
    - On toggle change, call store's updateAntiCheatConfig with the changed field
    - Read current config from useExamStore(s => s.exam?.antiCheatConfig)

    2. Modify `components/exam-editor/ExamHeader.tsx`:
    - Import ExamSettingsPanel
    - Add state for showing/hiding the settings panel (useState<boolean>)
    - Wire the existing Settings button (the one with the Settings icon that currently does nothing) to toggle the panel open/close
    - Render ExamSettingsPanel conditionally when open
    - Use a simple dropdown/popover approach: position the panel below or beside the settings button

    IMPORTANT: Use existing UI Kit components. Do NOT install any new libraries. Use simple HTML checkbox inputs styled with Tailwind for the toggles (or the project's existing toggle pattern if one exists).
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors. Open the exam builder page in browser, click Settings button, verify panel appears with two toggles. Toggle each and verify network request fires to update antiCheatConfig.
  </verify>
  <done>
    Settings button in ExamHeader opens a panel with two independent toggles (webcam deterrent, browser lockdown). Toggling saves to database via existing API. Panel uses UI Kit components.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. ExamSettingsPanel renders with two toggles
3. Toggling webcamDeterrent sends PATCH with `{ antiCheatConfig: { webcamDeterrent: true, browserLockdown: false } }`
4. Toggling browserLockdown sends PATCH with `{ antiCheatConfig: { webcamDeterrent: false, browserLockdown: true } }`
5. Settings persist on page reload (re-opening builder shows saved state)
</verification>

<success_criteria>
- Teacher can open exam settings and toggle webcam deterrent and browser lockdown independently
- Config persists to antiCheatConfig JSON field
- No new npm dependencies
- Uses existing UI Kit components
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligent-proctoring/07-01-SUMMARY.md`
</output>
