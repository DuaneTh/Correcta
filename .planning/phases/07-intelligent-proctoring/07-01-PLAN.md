---
phase: 07-intelligent-proctoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - lib/queue.ts
  - app/teacher/exams/[examId]/edit/page.tsx
  - components/exams/ProctoringConfigPanel.tsx
  - lib/proctoring/types.ts
autonomous: true

must_haves:
  truths:
    - "ProctorEventType enum includes webcam and lockdown event types"
    - "BullMQ proctoring-analysis queue is defined and exported"
    - "Teacher can toggle webcam monitoring and browser lockdown per exam"
    - "Proctoring config is saved to exam.antiCheatConfig JSON field"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Extended ProctorEventType enum with WEBCAM_SNAPSHOT, LOOKING_AWAY, SUSPICIOUS_BEHAVIOR, RIGHT_CLICK, DEVTOOLS_OPEN, SCREEN_SHARE_ATTEMPT"
      contains: "WEBCAM_SNAPSHOT"
    - path: "lib/queue.ts"
      provides: "proctoringQueue export for async snapshot analysis"
      contains: "proctoring-analysis"
    - path: "components/exams/ProctoringConfigPanel.tsx"
      provides: "Proctoring settings UI panel for exam editor"
      min_lines: 60
    - path: "lib/proctoring/types.ts"
      provides: "TypeScript types for proctoring config and events"
      min_lines: 20
  key_links:
    - from: "components/exams/ProctoringConfigPanel.tsx"
      to: "lib/proctoring/types.ts"
      via: "import ProctoringConfig type"
      pattern: "import.*ProctoringConfig"
    - from: "lib/queue.ts"
      to: "bullmq"
      via: "Queue constructor"
      pattern: "new Queue.*proctoring"
---

<objective>
Extend the Prisma schema with new proctoring event types, create the BullMQ proctoring queue, define TypeScript types for proctoring configuration, and build the teacher-facing proctoring config panel for the exam editor.

Purpose: Foundation for all proctoring features — schema, queue, types, and config UI must exist before webcam capture, browser lockdown, and AI analysis can be built.
Output: Extended schema, proctoring queue, config types, and ProctoringConfigPanel component integrated into exam editor.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-intelligent-proctoring/07-RESEARCH.md
@prisma/schema.prisma
@lib/queue.ts
@lib/antiCheat.ts
@app/teacher/exams/[examId]/edit/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema, create proctoring queue, and define types</name>
  <files>
    prisma/schema.prisma
    lib/queue.ts
    lib/proctoring/types.ts
  </files>
  <action>
1. In `prisma/schema.prisma`, add these values to the `ProctorEventType` enum (after PASTE):
   - WEBCAM_SNAPSHOT    // Periodic webcam capture taken
   - LOOKING_AWAY       // AI detected student looking away from screen
   - SUSPICIOUS_BEHAVIOR // AI detected general suspicious behavior
   - RIGHT_CLICK        // Right-click context menu attempt
   - DEVTOOLS_OPEN      // DevTools open detected
   - SCREEN_SHARE_ATTEMPT // Screen sharing detected

2. Run `npx prisma db push` to apply the schema change (do NOT use migrate — this project uses db push).

3. In `lib/queue.ts`, add a `proctoringQueue` export following the exact same pattern as `aiGradingQueue` and `exportQueue`:
   - Queue name: 'proctoring-analysis'
   - Same Redis connection variable
   - defaultJobOptions: attempts: 3, exponential backoff delay 3000ms
   - removeOnComplete: age 3600, count 200
   - removeOnFail: age 7 * 24 * 3600, count 500
   - Add null check with console.warn like existing queues
   - Add proctoringQueue to the `closeQueue()` function

4. Create `lib/proctoring/types.ts` with:
   ```typescript
   export interface ProctoringConfig {
     enabled: boolean           // Master toggle
     webcamEnabled: boolean     // Webcam monitoring on/off
     lockdownEnabled: boolean   // Browser lockdown detection on/off
     snapshotIntervalSeconds: number  // Default 60
     sensitivity: 'low' | 'medium' | 'high'  // AI analysis sensitivity
     // low = only flag ABSENCE and MULTIPLE_FACES
     // medium = also flag LOOKING_AWAY (>5s)
     // high = also flag SUSPICIOUS_BEHAVIOR
   }

   export const DEFAULT_PROCTORING_CONFIG: ProctoringConfig = {
     enabled: false,
     webcamEnabled: false,
     lockdownEnabled: true,
     snapshotIntervalSeconds: 60,
     sensitivity: 'medium',
   }

   export interface SnapshotAnalysisResult {
     faces: number
     lookingAway: boolean
     suspicious: boolean
     description: string
     confidence: number
   }

   export interface ProctoringJobData {
     attemptId: string
     snapshotUrl: string
     timestamp: number
     sensitivity: ProctoringConfig['sensitivity']
   }
   ```
  </action>
  <verify>
    Run `npx prisma db push` successfully (no errors).
    Run `npx tsc --noEmit` to verify types compile.
    Grep for "WEBCAM_SNAPSHOT" in schema.prisma.
    Grep for "proctoringQueue" in lib/queue.ts.
  </verify>
  <done>
    Schema has 6 new ProctorEventType values. proctoringQueue exported from lib/queue.ts. ProctoringConfig type and defaults defined in lib/proctoring/types.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build ProctoringConfigPanel and integrate into exam editor</name>
  <files>
    components/exams/ProctoringConfigPanel.tsx
    app/teacher/exams/[examId]/edit/page.tsx
  </files>
  <action>
1. Create `components/exams/ProctoringConfigPanel.tsx`:
   - Import ProctoringConfig, DEFAULT_PROCTORING_CONFIG from lib/proctoring/types
   - Use UI Kit components (Card, CardBody, Stack, Text, Badge, Button) from @/components/ui/*
   - Props: `{ config: ProctoringConfig, onChange: (config: ProctoringConfig) => void }`
   - Master toggle: "Activer le proctoring" / "Enable proctoring" — controls `enabled`
   - When enabled, show sub-options:
     a. Webcam monitoring toggle (webcamEnabled) — with description "Capture periodique de la webcam"
     b. Browser lockdown toggle (lockdownEnabled) — with description "Detection des changements d'onglet, copier/coller"
     c. Snapshot interval dropdown: 30s, 60s (default), 120s — only visible when webcamEnabled
     d. Sensitivity select: Faible/Moyen/Eleve (low/medium/high) — only visible when webcamEnabled
   - Use simple toggle switches (styled checkboxes with Tailwind) for boolean options
   - Use native select elements styled with Tailwind for dropdowns
   - Show a warning badge when webcamEnabled: "Les etudiants devront autoriser l'acces camera"
   - All labels in French (this is the app's primary language based on existing code)

2. Integrate into exam editor page:
   - Read the existing exam editor page to understand the form structure
   - The exam already has `antiCheatConfig Json?` field
   - Add ProctoringConfigPanel to the exam edit form
   - Parse `exam.antiCheatConfig` as ProctoringConfig on load (fallback to DEFAULT_PROCTORING_CONFIG)
   - Save the ProctoringConfig to `antiCheatConfig` when the exam is saved
   - Place the panel after the existing exam settings (duration, dates, etc.) but before the submit button
   - The panel should be collapsible (start collapsed) with a header like "Proctoring / Anti-triche"

IMPORTANT: Read the full exam editor page first to understand how the form saves data. Follow the existing pattern for adding new fields. The exam editor likely uses a Zustand store or form state — integrate with whatever pattern exists.
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify no type errors.
    Run `npm run build` to verify the page compiles.
    Visually: The exam editor should show a collapsible "Proctoring" section with toggles.
  </verify>
  <done>
    ProctoringConfigPanel renders toggles for webcam, lockdown, interval, sensitivity. It is integrated into the exam editor and saves to antiCheatConfig JSON field. Teacher can configure proctoring per exam.
  </done>
</task>

</tasks>

<verification>
1. `npx prisma db push` runs without errors
2. `npx tsc --noEmit` passes
3. ProctorEventType enum has WEBCAM_SNAPSHOT, LOOKING_AWAY, SUSPICIOUS_BEHAVIOR, RIGHT_CLICK, DEVTOOLS_OPEN, SCREEN_SHARE_ATTEMPT
4. lib/queue.ts exports proctoringQueue
5. lib/proctoring/types.ts exports ProctoringConfig with defaults
6. ProctoringConfigPanel appears in exam editor
</verification>

<success_criteria>
- Schema extended with 6 new event types
- BullMQ proctoring queue created
- TypeScript types for proctoring config defined
- Teacher can toggle proctoring on/off per exam with webcam/lockdown/sensitivity options
- Config persists to antiCheatConfig JSON field
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligent-proctoring/07-01-SUMMARY.md`
</output>
