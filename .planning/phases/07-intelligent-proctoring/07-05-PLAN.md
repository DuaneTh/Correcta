---
phase: 07-intelligent-proctoring
plan: 05
type: execute
wave: 4
depends_on: ["07-02", "07-03", "07-04"]
files_modified:
  - app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx
  - app/dashboard/exams/[examId]/proctoring/[attemptId]/ProctoringDetail.tsx
  - app/api/exams/[examId]/proctoring/route.ts
autonomous: true

must_haves:
  truths:
    - "Teacher sees AI flag count and webcam flag count per student in summary table"
    - "Teacher sees snapshot thumbnails in the detail timeline for AI-flagged events"
    - "Confidence scores displayed next to AI-generated flags"
    - "AI-generated events visually distinct from browser events (badge/color)"
    - "Teacher can filter events by type (all, browser only, AI only)"
  artifacts:
    - path: "app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx"
      provides: "Enhanced summary with AI flag counts and webcam indicators"
      min_lines: 100
    - path: "app/dashboard/exams/[examId]/proctoring/[attemptId]/ProctoringDetail.tsx"
      provides: "Enhanced timeline with snapshot thumbnails and confidence scores"
      min_lines: 100
  key_links:
    - from: "app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx"
      to: "/api/exams/[examId]/proctoring"
      via: "fetch GET"
      pattern: "api/exams.*proctoring"
    - from: "app/dashboard/exams/[examId]/proctoring/[attemptId]/ProctoringDetail.tsx"
      to: "metadata.snapshotUrl"
      via: "img src for snapshot thumbnails"
      pattern: "snapshotUrl"
---

<objective>
Upgrade the existing teacher proctoring review dashboard to display AI-generated flags with confidence scores, snapshot thumbnails, and filtering by event source (browser vs AI).

Purpose: PROCT-05 teacher review dashboard. Teachers need to validate AI flags, view snapshots, and distinguish between browser events and AI detections to make fair decisions.
Output: Enhanced ProctoringSummary with AI flag counts and ProctoringDetail with snapshot thumbnails + confidence scores.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-intelligent-proctoring/07-RESEARCH.md
@.planning/phases/07-intelligent-proctoring/07-01-SUMMARY.md
@app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx
@app/dashboard/exams/[examId]/proctoring/[attemptId]/ProctoringDetail.tsx
@app/api/exams/[examId]/proctoring/route.ts
@components/ui/Badge.tsx
@components/ui/Card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade API and ProctoringSummary with AI flag awareness</name>
  <files>
    app/api/exams/[examId]/proctoring/route.ts
    app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx
  </files>
  <action>
1. Update `app/api/exams/[examId]/proctoring/route.ts`:
   - Add AI flag counts to the summary response for each attempt:
     - `aiFlags`: count of events where metadata.aiGenerated === true
     - `browserFlags`: count of events where metadata.aiGenerated is not true
     - `snapshotCount`: count of WEBCAM_SNAPSHOT events
     - `flaggedSnapshots`: count of AI events that have snapshotUrl in metadata
   - Include these in the per-attempt summary object alongside existing eventCounts and antiCheatScore

2. Update `app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx`:
   - Read the full existing component first (it already has a table with student rows)
   - Migrate from raw HTML to UI Kit components (Card, Badge, Text, etc.) — follow Phase 6 migration pattern
   - Add new columns to the table:
     a. "Flags IA" column showing aiFlags count with a blue Badge when > 0
     b. "Webcam" column showing a camera icon (green = active/captured, gray = no webcam) based on snapshotCount
   - Update the suspicion score column to show both heuristic score AND AI flag count
   - Add a filter bar at the top: "Tous" | "Avec flags IA" | "Score > 5" | "Sans events"
   - Add a legend/key explaining colors: Vert = Aucun probleme, Jaune = Faible suspicion, Orange = Moyen, Rouge = Eleve
   - Keep the existing sort functionality (by name, status, score)
   - Add sort option: "Flags IA" to sort by AI flag count
   - Ensure the "Details" link still navigates to the per-attempt view
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Grep for "aiFlags" in ProctoringSummary.tsx.
    Grep for "Badge" in ProctoringSummary.tsx (UI Kit usage).
  </verify>
  <done>
    Proctoring API returns AI flag counts. Summary table shows AI flags, webcam status, and filter options. UI uses UI Kit components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade ProctoringDetail with snapshot thumbnails and confidence</name>
  <files>
    app/dashboard/exams/[examId]/proctoring/[attemptId]/ProctoringDetail.tsx
    app/dashboard/exams/[examId]/proctoring/[attemptId]/page.tsx
  </files>
  <action>
1. Read the full existing ProctoringDetail.tsx first — it already has a timeline of events.

2. Update `ProctoringDetail.tsx`:
   - Migrate to UI Kit components (Card, CardBody, Badge, Text, Stack, Grid)
   - For events with metadata.snapshotUrl:
     a. Show a thumbnail image (96x72px, rounded, object-cover) next to the event
     b. On click, open a larger modal/overlay showing the full snapshot (400x300)
     c. Show "IA" badge in blue next to AI-generated events (where metadata.aiGenerated === true)
   - For AI-generated events:
     a. Show confidence as a percentage badge: e.g., "85% confiance" in a subtle gray Badge
     b. Show the AI description from metadata.description
     c. Show faces count from metadata.faces
   - Add distinct color coding for AI events vs browser events:
     - AI events: blue-tinted background (bg-blue-50 border-blue-200)
     - Browser events: keep existing colors (red for FOCUS_LOST, orange for TAB_SWITCH, etc.)
     - Add new colors: RIGHT_CLICK = purple, DEVTOOLS_OPEN = gray, WEBCAM_SNAPSHOT = sky
   - Add event type filter buttons at the top of the timeline:
     - "Tous" | "Navigateur" | "IA" | "Captures"
     - Filter the displayed events based on selection
   - Add event labels for new types:
     - WEBCAM_SNAPSHOT: "Capture webcam"
     - LOOKING_AWAY: "Regard detourne"
     - SUSPICIOUS_BEHAVIOR: "Comportement suspect"
     - RIGHT_CLICK: "Clic droit"
     - DEVTOOLS_OPEN: "Outils developpeur"
     - SCREEN_SHARE_ATTEMPT: "Tentative de partage d'ecran"
   - Add a summary card at the top showing:
     - Total events / AI flags / Browser flags
     - Average confidence of AI flags
     - Time range (first event to last event)

3. Check page.tsx to ensure all event data (including metadata with snapshotUrl, confidence, etc.) is being passed through. Update the Prisma query if metadata isn't being included.

IMPORTANT: Never auto-fail or auto-penalize based on AI flags. The dashboard is purely informational for teacher review. Show a notice: "Les flags IA sont indicatifs. Verifiez manuellement avant toute decision."
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npm run build` — builds successfully.
    Grep for "snapshotUrl" in ProctoringDetail.tsx.
    Grep for "confiance" in ProctoringDetail.tsx.
    Grep for "aiGenerated" in ProctoringDetail.tsx.
  </verify>
  <done>
    ProctoringDetail shows snapshot thumbnails for AI events with confidence scores. Events color-coded by source (AI vs browser). Filter by event type. Summary card with aggregated stats. Teacher notice about manual review requirement.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. ProctoringSummary shows AI flag count, webcam status, filter bar
4. ProctoringDetail shows snapshot thumbnails, confidence scores
5. AI events visually distinct from browser events
6. Event type filter works (All/Browser/AI/Captures)
7. Teacher notice about manual review displayed
8. UI Kit components used throughout
</verification>

<success_criteria>
- Summary table has AI flags column with Badge counts
- Detail timeline shows snapshot images for AI events
- Confidence scores visible as percentage badges
- Blue-tinted background for AI events, existing colors for browser events
- Filter events by type (all, browser, AI, captures)
- Labels for all new event types in French
- "Flags indicatifs" notice present
- UI Kit components consistently used
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligent-proctoring/07-05-SUMMARY.md`
</output>
