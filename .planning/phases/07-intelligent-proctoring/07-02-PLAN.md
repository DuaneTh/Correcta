---
phase: 07-intelligent-proctoring
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - lib/proctoring/browserDetection.ts
  - components/exams/BrowserLockdown.tsx
  - app/student/attempts/[attemptId]/ExamRoomClient.tsx
autonomous: true

must_haves:
  truths:
    - "Tab switch triggers a TAB_SWITCH event logged to the API"
    - "Copy action triggers a COPY event with selection length"
    - "Paste action triggers a PASTE event with paste length"
    - "Right-click triggers a RIGHT_CLICK event and context menu is prevented"
    - "Student sees a visual warning when they switch tabs"
    - "Browser lockdown only activates when exam has lockdownEnabled in config"
  artifacts:
    - path: "lib/proctoring/browserDetection.ts"
      provides: "Event handler setup functions for browser detection"
      min_lines: 40
    - path: "components/exams/BrowserLockdown.tsx"
      provides: "React component that attaches/detaches browser event listeners"
      min_lines: 50
  key_links:
    - from: "components/exams/BrowserLockdown.tsx"
      to: "/api/attempts/[id]/proctor-events"
      via: "fetch POST for each detected event"
      pattern: "proctor-events"
    - from: "app/student/attempts/[attemptId]/ExamRoomClient.tsx"
      to: "components/exams/BrowserLockdown.tsx"
      via: "conditional render when lockdown enabled"
      pattern: "BrowserLockdown"
---

<objective>
Build browser lockdown detection that monitors tab switches, copy/paste, right-click, and DevTools usage during proctored exams. Integrate into the exam room so it only activates when the exam has lockdown enabled.

Purpose: PROCT-03 browser lockdown detection. Logs events for teacher review without blocking students from continuing the exam.
Output: BrowserLockdown component integrated into ExamRoomClient, logging events to the proctor-events API.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-intelligent-proctoring/07-RESEARCH.md
@.planning/phases/07-intelligent-proctoring/07-01-SUMMARY.md
@app/api/attempts/[id]/proctor-events/route.ts
@app/student/attempts/[attemptId]/ExamRoomClient.tsx
@lib/proctoring/types.ts
@lib/csrfClient.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create browser detection utilities and BrowserLockdown component</name>
  <files>
    lib/proctoring/browserDetection.ts
    components/exams/BrowserLockdown.tsx
  </files>
  <action>
1. Create `lib/proctoring/browserDetection.ts`:
   - Export a function `createEventLogger(attemptId: string, csrfToken: string, nonce: string)` that returns an async function for posting events to `/api/attempts/${attemptId}/proctor-events`
   - The logger should: generate a unique x-request-id (crypto.randomUUID()), include x-csrf-token header, include x-attempt-nonce header, POST { type, metadata } as JSON
   - Use fire-and-forget pattern (no await in event handlers — queue events, don't block UI)
   - Export helper: `setupVisibilityDetection(logger)` — attaches visibilitychange listener, fires TAB_SWITCH when document.hidden becomes true, fires FOCUS_GAINED when it becomes false
   - Export helper: `setupClipboardDetection(logger)` — attaches copy/paste listeners, COPY with { selectionLength }, PASTE with { pasteLength }
   - Export helper: `setupContextMenuDetection(logger)` — attaches contextmenu listener, calls e.preventDefault(), fires RIGHT_CLICK event
   - Export helper: `setupDevToolsDetection(logger)` — uses window.outerWidth - window.innerWidth > 160 heuristic on resize events (debounced 1s). Fires DEVTOOLS_OPEN. NOTE: This is easily bypassable and is just for logging, not security. Only fire once per session to avoid spam.
   - Each setup function returns a cleanup function that removes event listeners.

2. Create `components/exams/BrowserLockdown.tsx`:
   - "use client" component
   - Props: `{ attemptId: string, nonce: string, onTabSwitch?: () => void }`
   - On mount: get CSRF token via getCsrfToken() from @/lib/csrfClient
   - Call all setup* functions from browserDetection.ts, passing the event logger
   - Maintain state: `tabSwitchCount` (number) and `showWarning` (boolean)
   - When TAB_SWITCH fires, increment tabSwitchCount and show a warning toast/banner for 5 seconds: "Attention: changement d'onglet detecte ({count} fois)" with a warning icon
   - The warning should be a fixed-position banner at the top of the screen (z-50) with amber background
   - On unmount: call all cleanup functions
   - This component renders nothing visible except the warning banner (when active)

IMPORTANT: Follow the existing CSRF/nonce pattern from ExamRoomClient.tsx. The proctor-events API requires x-csrf-token, x-attempt-nonce, and x-request-id headers. Read the existing ExamRoomClient to see how CSRF tokens and nonces are handled.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Grep for "visibilitychange" in browserDetection.ts.
    Grep for "BrowserLockdown" in the components directory.
  </verify>
  <done>
    BrowserLockdown component attaches listeners for visibility, clipboard, context menu, and DevTools. Events are posted to the proctor-events API with proper auth headers. Warning banner shows on tab switch.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate BrowserLockdown into ExamRoomClient</name>
  <files>
    app/student/attempts/[attemptId]/ExamRoomClient.tsx
  </files>
  <action>
1. Read the FULL ExamRoomClient.tsx first to understand the component structure, props, and how attempt data (including nonce) is passed.

2. Modify ExamRoomClient.tsx:
   - Import BrowserLockdown from @/components/exams/BrowserLockdown
   - Import ProctoringConfig, DEFAULT_PROCTORING_CONFIG from @/lib/proctoring/types
   - The exam data needs to include antiCheatConfig. Check how the page.tsx fetches exam data and ensure antiCheatConfig is included in the query. If not, add it.
   - Parse `exam.antiCheatConfig` as ProctoringConfig (with fallback to DEFAULT_PROCTORING_CONFIG)
   - Conditionally render `<BrowserLockdown>` when `proctoringConfig.enabled && proctoringConfig.lockdownEnabled`
   - Pass attemptId and nonce props from the existing attempt data
   - Do NOT modify the existing exam-taking flow — BrowserLockdown is an invisible overlay that only logs events

3. Update the page.tsx (app/student/attempts/[attemptId]/page.tsx) if needed to include antiCheatConfig in the exam data passed to ExamRoomClient.

CRITICAL: Do not break the existing exam-taking flow. BrowserLockdown is additive only. If antiCheatConfig is null or proctoring is disabled, nothing changes.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Run `npm run build` — builds successfully.
    Grep for "BrowserLockdown" in ExamRoomClient.tsx.
  </verify>
  <done>
    ExamRoomClient conditionally renders BrowserLockdown when proctoring lockdown is enabled. Tab switches, copy/paste, right-click logged to API. Warning banner appears on tab switch. No change to exam flow when proctoring is disabled.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. BrowserLockdown renders when lockdownEnabled is true in exam config
4. Tab switch events posted to proctor-events API
5. Warning banner visible on tab switch
6. No impact on exams without proctoring enabled
</verification>

<success_criteria>
- Browser lockdown detects tab switches, copy/paste, right-click, DevTools
- Events logged to proctor-events API with correct headers
- Visual warning on tab switch
- Only active when exam has lockdown enabled
- No regression in existing exam-taking flow
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligent-proctoring/07-02-SUMMARY.md`
</output>
