---
phase: 07-intelligent-proctoring
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/proctoring/patternAnalysis.ts
  - lib/proctoring/__tests__/patternAnalysis.test.ts
  - lib/antiCheat.ts
autonomous: true

must_haves:
  truths:
    - "Focus loss events correlated with answer timing produce a suspicion flag"
    - "External paste detected from metadata is scored higher than internal paste"
    - "Anti-cheat score reflects focus-loss-before-answer pattern"
  artifacts:
    - path: "lib/proctoring/patternAnalysis.ts"
      provides: "Focus loss pattern analysis and suspicion scoring"
      exports: ["analyzeFocusLossPatterns", "computeEnhancedAntiCheatScore"]
    - path: "lib/proctoring/__tests__/patternAnalysis.test.ts"
      provides: "Tests for pattern analysis logic"
      min_lines: 50
  key_links:
    - from: "lib/proctoring/patternAnalysis.ts"
      to: "lib/antiCheat.ts"
      via: "imports base scoring functions"
      pattern: "import.*antiCheat"
---

<objective>
Build the focus loss pattern analysis engine that correlates focus loss events with answer submission timing to detect suspicious patterns, and enhance the anti-cheat scoring to account for external paste and focus-before-answer patterns.

Purpose: The core intelligence of the proctoring system. If a student loses focus before every answer submission, that is highly suspicious. External pastes (from outside the exam page) should score higher than internal clipboard operations.
Output: Tested pattern analysis functions ready for use by the teacher dashboard.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@lib/antiCheat.ts
</context>

<feature>
  <name>Focus Loss Pattern Analysis</name>
  <files>
    lib/proctoring/patternAnalysis.ts
    lib/proctoring/__tests__/patternAnalysis.test.ts
  </files>
  <behavior>
    **analyzeFocusLossPatterns(events, answerTimestamps)**

    Input:
    - events: Array of { type: string, timestamp: Date, metadata: any }
    - answerTimestamps: Array of { questionId: string, savedAt: Date } (answer save timestamps)

    Logic:
    - For each answer save, check if there was a FOCUS_LOST event within a configurable window BEFORE the save (default: 30 seconds before save, up to 5 seconds after focus regained)
    - A "suspicious pair" = FOCUS_LOST -> FOCUS_GAINED -> answer saved (within window)
    - Calculate ratio: suspiciousPairs / totalAnswerSaves
    - If ratio > 0.5 (more than half of answers preceded by focus loss), flag as SUSPICIOUS
    - If ratio > 0.75, flag as HIGHLY_SUSPICIOUS

    Cases:
    - 0 answer timestamps -> { suspiciousPairs: 0, totalAnswers: 0, ratio: 0, flag: "NONE" }
    - 5 answers, 0 focus losses -> { suspiciousPairs: 0, totalAnswers: 5, ratio: 0, flag: "NONE" }
    - 5 answers, 4 preceded by focus loss -> { suspiciousPairs: 4, totalAnswers: 5, ratio: 0.8, flag: "HIGHLY_SUSPICIOUS" }
    - 5 answers, 3 preceded by focus loss -> { suspiciousPairs: 3, totalAnswers: 5, ratio: 0.6, flag: "SUSPICIOUS" }
    - 5 answers, 2 preceded by focus loss -> { suspiciousPairs: 2, totalAnswers: 5, ratio: 0.4, flag: "NONE" }

    **analyzeExternalPastes(events)**

    Input: events array
    Logic:
    - Count PASTE events where metadata.isExternal === true
    - Count PASTE events where metadata.isExternal === false or undefined

    Cases:
    - No paste events -> { externalPastes: 0, internalPastes: 0 }
    - 3 paste events, 2 external -> { externalPastes: 2, internalPastes: 1 }

    **computeEnhancedAntiCheatScore(params)**

    Extends existing computeAntiCheatScore with additional factors:
    - Base score from existing function (FOCUS_LOST * 2 + TAB_SWITCH * 3 + copy/paste pairs)
    - Focus pattern bonus: +15 if SUSPICIOUS, +30 if HIGHLY_SUSPICIOUS
    - External paste bonus: +5 per external paste event

    Cases:
    - No events -> score 0
    - 3 FOCUS_LOST + SUSPICIOUS pattern -> base(6) + 15 = 21
    - 3 FOCUS_LOST + HIGHLY_SUSPICIOUS pattern + 2 external pastes -> base(6) + 30 + 10 = 46
  </behavior>
  <implementation>
    1. RED: Write tests for all three functions covering the cases above
    2. GREEN: Implement the functions in lib/proctoring/patternAnalysis.ts
    3. REFACTOR: Clean up if needed

    The functions should be pure (no DB access, no side effects) - they receive event arrays and return analysis results. This makes them testable and reusable.

    Import and reuse computeAntiCheatScore and analyzeCopyPasteEvents from lib/antiCheat.ts for the base scoring in computeEnhancedAntiCheatScore.
  </implementation>
</feature>

<verification>
1. `npx vitest run lib/proctoring/__tests__/patternAnalysis.test.ts` passes all tests
2. `npx tsc --noEmit` passes
3. All edge cases covered (empty arrays, no focus losses, all suspicious, mixed)
</verification>

<success_criteria>
- analyzeFocusLossPatterns correctly identifies focus-before-answer patterns
- analyzeExternalPastes correctly separates external vs internal paste events
- computeEnhancedAntiCheatScore produces higher scores for suspicious patterns
- All functions are pure and well-tested
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligent-proctoring/07-02-SUMMARY.md`
</output>
