---
phase: 07-intelligent-proctoring
plan: 04
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - app/api/exams/[examId]/proctoring/route.ts
  - app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx
  - app/dashboard/exams/[examId]/proctoring/[attemptId]/ProctoringDetail.tsx
  - app/dashboard/exams/[examId]/proctoring/[attemptId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher sees suspicion flag (NONE/SUSPICIOUS/HIGHLY_SUSPICIOUS) per student"
    - "Teacher sees external paste count distinguished from internal paste"
    - "Teacher can identify focus-before-answer pattern in student timeline"
    - "Teacher sees enhanced anti-cheat score reflecting all pattern factors"
  artifacts:
    - path: "app/api/exams/[examId]/proctoring/route.ts"
      provides: "Enhanced proctoring API with pattern analysis"
      min_lines: 80
    - path: "app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx"
      provides: "Summary table with suspicion flags and external paste indicators"
      min_lines: 100
    - path: "app/dashboard/exams/[examId]/proctoring/[attemptId]/ProctoringDetail.tsx"
      provides: "Enhanced timeline with paste origin and focus pattern indicators"
      min_lines: 100
  key_links:
    - from: "app/api/exams/[examId]/proctoring/route.ts"
      to: "lib/proctoring/patternAnalysis.ts"
      via: "imports pattern analysis functions"
      pattern: "import.*patternAnalysis"
    - from: "app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx"
      to: "/api/exams/[examId]/proctoring"
      via: "fetch for summary data"
      pattern: "fetch.*proctoring"
---

<objective>
Enhance the teacher proctoring dashboard with focus loss pattern analysis indicators, external paste detection badges, and the enhanced anti-cheat score. The existing dashboard already has a summary table and timeline - this plan adds intelligence to the display.

Purpose: Teachers need to see not just raw event counts but meaningful patterns: "This student lost focus before 80% of their answers" and "This student pasted 5 times from external sources."
Output: Enhanced proctoring API returning pattern analysis, upgraded summary table with suspicion flags, and enhanced timeline with paste origin indicators.
</objective>

<execution_context>
@C:\Users\hugol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\hugol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-intelligent-proctoring/07-02-SUMMARY.md
@lib/proctoring/patternAnalysis.ts
@app/api/exams/[examId]/proctoring/route.ts
@app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx
@app/dashboard/exams/[examId]/proctoring/[attemptId]/ProctoringDetail.tsx
@app/dashboard/exams/[examId]/proctoring/[attemptId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance proctoring API with pattern analysis</name>
  <files>
    app/api/exams/[examId]/proctoring/route.ts
    app/dashboard/exams/[examId]/proctoring/[attemptId]/page.tsx
  </files>
  <action>
    1. **Modify `app/api/exams/[examId]/proctoring/route.ts`**:
    - Import `analyzeFocusLossPatterns`, `analyzeExternalPastes`, `computeEnhancedAntiCheatScore` from `@/lib/proctoring/patternAnalysis`
    - Extend the existing query to also fetch each attempt's answer save timestamps:
      ```
      include: {
        ...existing includes...,
        answers: {
          select: {
            questionId: true,
            segments: {
              select: {
                autosavedAt: true
              }
            }
          }
        }
      }
      ```
    - For each attempt, compute:
      a) answerTimestamps: flatten answer.segments to get { questionId, savedAt: segment.autosavedAt } entries (filter out null autosavedAt)
      b) focusLossAnalysis: call analyzeFocusLossPatterns(proctorEvents, answerTimestamps)
      c) externalPasteAnalysis: call analyzeExternalPastes(proctorEvents)
      d) enhancedScore: call computeEnhancedAntiCheatScore({ eventCounts, copyPasteAnalysis, focusLossFlag: focusLossAnalysis.flag, externalPasteCount: externalPasteAnalysis.externalPastes })
    - Add to the response per attempt:
      ```json
      {
        ...existing fields...,
        "antiCheatScore": enhancedScore,
        "focusLossPattern": {
          "flag": "SUSPICIOUS",
          "ratio": 0.6,
          "suspiciousPairs": 3,
          "totalAnswers": 5
        },
        "externalPastes": 2,
        "internalPastes": 1
      }
      ```

    2. **Modify `app/dashboard/exams/[examId]/proctoring/[attemptId]/page.tsx`**:
    - Ensure the attempt detail page also fetches answers with autosavedAt timestamps so it can pass them to ProctoringDetail (or fetch the enhanced data from the API)
    - If the detail page fetches data server-side, compute the analysis there. If it passes raw data to ProctoringDetail, include answer timestamps in the props.

    IMPORTANT: The existing API already computes the base score. Replace it with the enhanced score. Keep backward compatibility - all existing fields remain, new fields are additions.
  </action>
  <verify>
    Call `GET /api/exams/{examId}/proctoring` and verify response includes focusLossPattern and externalPastes fields per attempt. Run `npx tsc --noEmit`.
  </verify>
  <done>
    Proctoring API returns enhanced data including focus loss pattern flag, external paste count, and enhanced anti-cheat score for each attempt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance ProctoringSummary and ProctoringDetail UI</name>
  <files>
    app/dashboard/exams/[examId]/proctoring/ProctoringSummary.tsx
    app/dashboard/exams/[examId]/proctoring/[attemptId]/ProctoringDetail.tsx
  </files>
  <action>
    1. **Enhance ProctoringSummary.tsx**:
    - Update StudentSummary interface to include `focusLossPattern: { flag: string, ratio: number, suspiciousPairs: number, totalAnswers: number }` and `externalPastes: number`
    - Add a new column "Pattern" between "Evenements" and "Score de suspicion" showing:
      a) Focus loss pattern flag as a colored badge:
         - NONE: no badge
         - SUSPICIOUS: orange Badge "Focus suspect" (using UI Kit Badge component)
         - HIGHLY_SUSPICIOUS: red Badge "Focus tres suspect"
      b) External paste count: if > 0, show a small badge "N collages externes" in purple
    - Update the suspicion score display to use the enhanced score
    - Add tooltip or small text showing the focus pattern ratio (e.g., "3/5 reponses apres perte de focus")
    - Migrate raw HTML elements to UI Kit components where not already done:
      - Use Surface for the table container
      - Use Badge for status and suspicion indicators
      - Use Button for the "Details" link and CSV download
      - Use Text for headers and labels

    2. **Enhance ProctoringDetail.tsx**:
    - Add a "Pattern Analysis" section (Surface card) above the timeline showing:
      a) Focus loss pattern: ratio, flag, description "X reponses sur Y precedees d'une perte de focus"
      b) External pastes: count and percentage of total pastes
      c) Enhanced anti-cheat score with breakdown
    - In the timeline, enhance PASTE events to show an indicator:
      - If metadata.isExternal === true: red border + "Collage externe" label
      - If metadata.isExternal === false: green border + "Collage interne" label (normal)
    - Add visual connectors in timeline between FOCUS_LOST events and subsequent answer saves that were flagged as suspicious pairs (if this data is available in the response)
    - Use UI Kit components: Surface for cards, Stack for layout, Badge for indicators, Text for labels

    IMPORTANT: Keep the existing functionality intact. These are enhancements, not replacements. The existing event counts, timeline, and sorting all remain. Use existing UI Kit components from @/components/ui/*.
  </action>
  <verify>
    Run `npx tsc --noEmit`. Open proctoring summary page - verify new Pattern column appears with badges. Open detail page - verify pattern analysis card and enhanced paste indicators in timeline.
  </verify>
  <done>
    ProctoringSummary shows focus loss pattern badges and external paste counts per student. ProctoringDetail shows pattern analysis card and paste origin indicators in timeline. Enhanced anti-cheat score displayed throughout. All using UI Kit components.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Proctoring summary table shows focus loss pattern flag badges
3. Students with many external pastes show purple badge
4. Detail view shows pattern analysis breakdown
5. Timeline events for PASTE show external/internal indicator
6. Enhanced anti-cheat score reflects all pattern factors
7. Existing functionality (sorting, filtering, CSV download) still works
</verification>

<success_criteria>
- Teacher can identify suspicious focus-before-answer patterns at a glance
- External vs internal paste clearly distinguished in UI
- Enhanced scoring provides meaningful suspicion levels
- Dashboard uses UI Kit components consistently
</success_criteria>

<output>
After completion, create `.planning/phases/07-intelligent-proctoring/07-04-SUMMARY.md`
</output>
