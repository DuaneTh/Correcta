---
phase: 03-organization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - components/ui/CsvUploader.tsx
  - app/admin/school/users/SchoolUsersClient.tsx
  - lib/i18n/dictionaries.ts
autonomous: true

must_haves:
  truths:
    - "School admin can select a CSV file with user data"
    - "School admin sees a preview of parsed users before confirming import"
    - "School admin can upload CSV with 100 users and see them created with correct roles"
    - "Invalid rows are flagged with clear error messages"
    - "Duplicate emails are skipped without failing the entire import"
  artifacts:
    - path: "components/ui/CsvUploader.tsx"
      provides: "Reusable CSV upload component with preview"
      min_lines: 100
    - path: "app/admin/school/users/SchoolUsersClient.tsx"
      provides: "CSV import integration in users page"
      min_lines: 500
    - path: "package.json"
      provides: "papaparse dependency"
      contains: "papaparse"
  key_links:
    - from: "CsvUploader.tsx"
      to: "papaparse"
      via: "Papa.parse for client-side parsing"
      pattern: "Papa\\.parse"
    - from: "SchoolUsersClient.tsx"
      to: "/api/admin/school/users"
      via: "fetchJsonWithCsrf with users array"
      pattern: "users.*fetchJsonWithCsrf"
---

<objective>
Add CSV upload UI for bulk user creation.

Purpose: Enable school admins to quickly import large numbers of students/teachers from a CSV file instead of creating them one by one.

Output: CsvUploader component with preview, integrated into SchoolUsersClient, connects to existing bulk user creation API.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-organization/03-RESEARCH.md

# Existing bulk API (already supports users[] array)
@app/api/admin/school/users/route.ts (lines 80-127 handle bulk creation)

# UI to extend
@app/admin/school/users/SchoolUsersClient.tsx
@lib/i18n/dictionaries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install papaparse and create CsvUploader component</name>
  <files>package.json, components/ui/CsvUploader.tsx</files>
  <action>
Install papaparse for CSV parsing:
```bash
npm install papaparse
npm install -D @types/papaparse
```

Create a reusable CsvUploader component at `components/ui/CsvUploader.tsx`:

```typescript
'use client'

import { useState, useCallback } from 'react'
import Papa from 'papaparse'

type CsvUploaderProps = {
  onParsed: (data: Record<string, string>[], errors: string[]) => void
  requiredColumns: string[]
  optionalColumns?: string[]
  accept?: string
  maxRows?: number
  labels: {
    dropzone: string
    selectFile: string
    parsing: string
    invalidFormat: string
    missingColumns: string
    tooManyRows: string
  }
}

export default function CsvUploader({
  onParsed,
  requiredColumns,
  optionalColumns = [],
  accept = '.csv',
  maxRows = 500,
  labels,
}: CsvUploaderProps) {
  const [parsing, setParsing] = useState(false)
  const [dragOver, setDragOver] = useState(false)

  const handleFile = useCallback((file: File | null) => {
    if (!file) return

    setParsing(true)

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        setParsing(false)

        const errors: string[] = []
        const headers = results.meta.fields || []

        // Check required columns
        const missingCols = requiredColumns.filter(col => !headers.includes(col))
        if (missingCols.length > 0) {
          onParsed([], [`${labels.missingColumns}: ${missingCols.join(', ')}`])
          return
        }

        // Check row limit
        if (results.data.length > maxRows) {
          onParsed([], [`${labels.tooManyRows}: ${results.data.length} (max: ${maxRows})`])
          return
        }

        // Collect parse errors
        results.errors.forEach(err => {
          errors.push(`Row ${err.row}: ${err.message}`)
        })

        onParsed(results.data as Record<string, string>[], errors)
      },
      error: (error) => {
        setParsing(false)
        onParsed([], [labels.invalidFormat])
      }
    })
  }, [onParsed, requiredColumns, maxRows, labels])

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault()
    setDragOver(false)
    handleFile(e.dataTransfer.files[0])
  }, [handleFile])

  const handleChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    handleFile(e.target.files?.[0] || null)
  }, [handleFile])

  return (
    <div
      onDragOver={(e) => { e.preventDefault(); setDragOver(true) }}
      onDragLeave={() => setDragOver(false)}
      onDrop={handleDrop}
      className={`border-2 border-dashed rounded-lg p-8 text-center transition ${
        dragOver ? 'border-brand-900 bg-brand-50' : 'border-gray-300'
      }`}
    >
      {parsing ? (
        <p className="text-sm text-gray-500">{labels.parsing}</p>
      ) : (
        <>
          <p className="text-sm text-gray-600 mb-2">{labels.dropzone}</p>
          <label className="inline-flex items-center rounded-md bg-brand-900 px-4 py-2 text-sm font-medium text-white hover:bg-brand-800 cursor-pointer">
            {labels.selectFile}
            <input
              type="file"
              accept={accept}
              onChange={handleChange}
              className="hidden"
            />
          </label>
          <p className="text-xs text-gray-400 mt-2">
            {requiredColumns.length > 0 && `Required: ${requiredColumns.join(', ')}`}
            {optionalColumns.length > 0 && ` | Optional: ${optionalColumns.join(', ')}`}
          </p>
        </>
      )}
    </div>
  )
}
```

This component:
- Supports drag-and-drop and click-to-select
- Parses CSV client-side for preview before submit
- Validates required columns
- Enforces row limit (default 500)
- Returns parsed data and errors to parent
  </action>
  <verify>
1. Check package.json has papaparse and @types/papaparse
2. File exists at components/ui/CsvUploader.tsx
3. Component exports default function
  </verify>
  <done>papaparse installed, CsvUploader component created with drag-drop support and validation.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate CSV import into SchoolUsersClient</name>
  <files>app/admin/school/users/SchoolUsersClient.tsx, lib/i18n/dictionaries.ts</files>
  <action>
Add CSV import drawer to SchoolUsersClient:

**Dictionary additions (lib/i18n/dictionaries.ts):**
Add to `admin.school`:
```typescript
csvImport: {
  button: 'Importer CSV',
  title: 'Importer des utilisateurs',
  dropzone: 'Glissez un fichier CSV ici ou',
  selectFile: 'Parcourir',
  parsing: 'Analyse en cours...',
  invalidFormat: 'Format de fichier invalide',
  missingColumns: 'Colonnes manquantes',
  tooManyRows: 'Trop de lignes',
  previewTitle: 'Apercu ({{count}} utilisateurs)',
  previewColumnName: 'Nom',
  previewColumnEmail: 'Email',
  previewColumnStatus: 'Statut',
  statusValid: 'Valide',
  statusInvalidEmail: 'Email invalide',
  statusDuplicate: 'Doublon',
  importButton: 'Importer {{count}} utilisateurs',
  importing: 'Import en cours...',
  resultSuccess: '{{created}} utilisateurs crees, {{skipped}} ignores',
  resultErrors: 'Erreurs:',
  cancelButton: 'Annuler',
  closeButton: 'Fermer',
},
```

**SchoolUsersClient changes:**

1. Add import drawer state:
```typescript
const [csvDrawerOpen, setCsvDrawerOpen] = useState(false)
const [csvData, setCsvData] = useState<Array<{email: string; name: string}>>([])
const [csvErrors, setCsvErrors] = useState<string[]>([])
const [csvImporting, setCsvImporting] = useState(false)
const [csvResult, setCsvResult] = useState<{created: number; skipped: number; errors: string[]} | null>(null)
```

2. Add "Import CSV" button next to create user button in header

3. Add CSV import drawer with:
   - CsvUploader component for file selection
   - Preview table showing parsed users with validation status
   - Each row shows: name, email, status (valid/invalid email/duplicate)
   - Import button (disabled if no valid rows)
   - Result display after import

4. Handle CSV parsed callback:
```typescript
const handleCsvParsed = (data: Record<string, string>[], errors: string[]) => {
  const users = data.map(row => ({
    email: row.email?.trim().toLowerCase() || '',
    name: row.name?.trim() || '',
  }))
  setCsvData(users)
  setCsvErrors(errors)
  setCsvResult(null)
}
```

5. Handle import submit:
```typescript
const handleCsvImport = async () => {
  const validUsers = csvData.filter(u => u.email && u.email.includes('@'))
  if (validUsers.length === 0) return

  setCsvImporting(true)
  try {
    const role = activeRole === 'teacher' ? 'TEACHER' : 'STUDENT'
    const result = await fetchJsonWithCsrf<{createdCount: number; skippedCount: number; errors: string[]}>(
      '/api/admin/school/users',
      { method: 'POST', body: { role, users: validUsers } }
    )
    setCsvResult({
      created: result.createdCount,
      skipped: result.skippedCount,
      errors: result.errors || []
    })
    router.refresh()
  } catch (err) {
    setCsvResult({ created: 0, skipped: 0, errors: ['Import failed'] })
  } finally {
    setCsvImporting(false)
  }
}
```

6. Preview table implementation:
   - Show first 50 rows with scroll
   - Highlight invalid emails in red
   - Show duplicate detection (same email appears twice)
   - Summary at bottom: X valid, Y invalid, Z duplicates
  </action>
  <verify>
1. Navigate to /admin/school/users
2. Click "Import CSV" button
3. Upload a CSV with columns: email, name
4. See preview table with validation status
5. Click Import, verify users are created
6. Check result summary shows created/skipped counts
  </verify>
  <done>CSV import drawer integrated, preview works, connects to bulk API, shows results.</done>
</task>

</tasks>

<verification>
1. papaparse in package.json
2. CsvUploader component exists and exports correctly
3. Import button visible on /admin/school/users page
4. CSV upload shows preview before import
5. Invalid emails highlighted, duplicates detected
6. Import creates users via existing bulk API
7. Result shows created/skipped counts
8. Existing user creation flow still works
</verification>

<success_criteria>
- School admin clicks "Import CSV" button
- School admin drops CSV file with 100 users (email, name columns)
- Preview shows parsed data with validation status
- School admin clicks Import
- 100 users created (or fewer if duplicates skipped)
- Result summary shows: "95 users created, 5 skipped"
- New users appear in user list
</success_criteria>

<output>
After completion, create `.planning/phases/03-organization/03-02-SUMMARY.md`
</output>
