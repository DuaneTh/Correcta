---
phase: 03-organization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - app/api/admin/school/sections/route.ts
  - app/admin/school/classes/SchoolClassesClient.tsx
  - lib/school-admin-data.ts
autonomous: true

must_haves:
  truths:
    - "School admin can create a subgroup (TD1) within an existing class (Finance 2026)"
    - "Subgroups appear indented under their parent class in the sections list"
    - "Students can be enrolled in subgroups independently of parent class"
    - "Existing section functionality continues to work (no regressions)"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Class model with parentId self-reference"
      contains: "parentId"
    - path: "app/api/admin/school/sections/route.ts"
      provides: "Subgroup creation and retrieval"
      exports: ["GET", "POST", "PATCH"]
    - path: "app/admin/school/classes/SchoolClassesClient.tsx"
      provides: "Hierarchical section display and subgroup creation UI"
      min_lines: 1050
  key_links:
    - from: "SchoolClassesClient.tsx"
      to: "/api/admin/school/sections"
      via: "fetchJsonWithCsrf POST with parentId"
      pattern: "parentId.*sectionForm"
    - from: "sections/route.ts"
      to: "prisma.class"
      via: "create with parentId"
      pattern: "parentId.*prisma\\.class\\.create"
---

<objective>
Add hierarchical subgroup support to the existing Class model.

Purpose: Enable school admins to create subgroups (TD1, TD2, TP1) within a parent class (Finance 2026) to organize students into smaller groups for exams and tracking.

Output: Extended schema with parentId, API support for subgroup CRUD, UI showing hierarchical structure with indented subgroups.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-organization/03-RESEARCH.md

# Existing code to extend (NOT replace)
@prisma/schema.prisma (Class model at line 130-139)
@app/api/admin/school/sections/route.ts (CRUD already implemented)
@app/admin/school/classes/SchoolClassesClient.tsx (1000+ lines of working UI)
@lib/school-admin-data.ts (data loading utilities)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parentId to Class schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add self-referencing parentId to the Class model for subgroup hierarchy:

```prisma
model Class {
  id        String       @id @default(uuid())
  name      String       // e.g. "Group A", "TD 1"
  courseId  String
  course    Course       @relation(fields: [courseId], references: [id])
  parentId  String?      // NEW: Reference to parent class for subgroups
  parent    Class?       @relation("ClassHierarchy", fields: [parentId], references: [id])
  children  Class[]      @relation("ClassHierarchy")  // Subgroups
  archivedAt DateTime?

  enrollments Enrollment[]
  exams       Exam[]
}
```

After schema change, run:
1. `npx prisma db push` to update the database
2. `npx prisma generate` to regenerate the client

This is a non-breaking change - parentId is nullable so existing sections remain valid.
  </action>
  <verify>
Run `npx prisma validate` - should pass without errors.
Run `npx prisma db push` - should apply migration successfully.
  </verify>
  <done>Class model has parentId field, self-referencing relation works, existing data intact.</done>
</task>

<task type="auto">
  <name>Task 2: Extend sections API for subgroups</name>
  <files>app/api/admin/school/sections/route.ts, lib/school-admin-data.ts</files>
  <action>
Update the sections API route to support subgroups:

**GET endpoint:**
- Include `parentId` and `children` in the select query
- Include `parent` relation with name for display
- Order results to group children under parents

**POST endpoint:**
- Accept optional `parentId` in request body
- Validate that parentId references a valid section in the same course
- Prevent creating subgroups of subgroups (only 1 level deep)
- When creating with parentId, verify parent section exists and is not archived

**PATCH endpoint:**
- Allow updating parentId (to move section between parents or make it a root section)

**lib/school-admin-data.ts:**
- Update `SectionRow` type to include `parentId`, `parent`, and `children`
- Update `loadSchoolAdminData` to include these fields in the query

Example POST body for subgroup:
```json
{
  "courseId": "course-uuid",
  "name": "TD1",
  "parentId": "parent-section-uuid"
}
```

Validation rules:
1. parentId must be a valid section ID in the same course
2. parent section must not have a parentId itself (max 1 level)
3. parent section must not be archived
  </action>
  <verify>
Test via curl:
1. Create a parent section: `curl -X POST /api/admin/school/sections -d '{"courseId":"...", "name":"Finance 2026"}'`
2. Create a subgroup: `curl -X POST /api/admin/school/sections -d '{"courseId":"...", "name":"TD1", "parentId":"..."}'`
3. GET sections and verify hierarchy is returned
  </verify>
  <done>API supports subgroup creation, returns hierarchy in GET, validates parent constraints.</done>
</task>

<task type="auto">
  <name>Task 3: Update UI for hierarchical section display</name>
  <files>app/admin/school/classes/SchoolClassesClient.tsx, lib/i18n/dictionaries.ts</files>
  <action>
Extend the SchoolClassesClient to display and create subgroups:

**Display changes (sections tab):**
1. Group sections by parentId - show root sections first, then their children indented
2. Add visual hierarchy: indent subgroups with padding-left or a tree connector
3. Show subgroup count badge on parent sections
4. Filter should search both parent and child names

**Form changes (section drawer):**
1. Add optional "Parent Section" dropdown in the section creation form
2. Only show sections without parentId as parent options
3. When parentId is selected, auto-select the same courseId
4. Add "(Subgroup)" label to make it clear this creates a nested section

**Dictionary additions:**
Add to `lib/i18n/dictionaries.ts` under `admin.school`:
```typescript
parentSectionLabel: 'Groupe parent (optionnel)',
parentSectionPlaceholder: 'Aucun (section racine)',
subgroupBadge: '{{count}} sous-groupe(s)',
createSubgroupHint: 'Creer comme sous-groupe de la section selectionnee',
```

**State changes:**
1. Add `parentId` to `sectionForm` state
2. When editing a section, load its parentId
3. Filter parent dropdown to exclude current section and its children (prevent cycles)

**Visual design:**
- Root sections: normal display
- Subgroups: 24px left padding, lighter border, smaller font for parent reference
- Parent with children: show expand/collapse or always expanded
  </action>
  <verify>
1. Navigate to /admin/school/classes?tab=sections
2. Create a root section "Finance 2026"
3. Open drawer, create subgroup "TD1" with parent "Finance 2026"
4. Verify TD1 appears indented under Finance 2026
5. Create TD2, TD3 as siblings
6. Verify all three appear under Finance 2026
  </verify>
  <done>UI displays hierarchical sections, allows creating subgroups via parent dropdown, visually distinguishes subgroups from root sections.</done>
</task>

</tasks>

<verification>
1. Schema: `npx prisma validate` passes
2. API: Subgroup CRUD works via API testing
3. UI: Can create "Finance 2026" with subgroups TD1, TD2, TD3
4. Hierarchy: Subgroups appear nested under parent in sections tab
5. Enrollment: Existing enrollment to subgroups works (no changes needed)
6. Regression: Existing section functionality unchanged
</verification>

<success_criteria>
- School admin creates class "Finance 2026" as root section
- School admin creates TD1, TD2, TD3 as subgroups under Finance 2026
- Sections tab shows hierarchical structure (Finance 2026 > TD1, TD2, TD3)
- Students can be assigned to specific subgroups
- Existing sections without parentId continue working
</success_criteria>

<output>
After completion, create `.planning/phases/03-organization/03-01-SUMMARY.md`
</output>
