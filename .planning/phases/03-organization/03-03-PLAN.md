---
phase: 03-organization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/actions/organization.ts
  - app/admin/school/users/SchoolUsersClient.tsx
  - lib/i18n/dictionaries.ts
autonomous: true

must_haves:
  truths:
    - "School admin can see 'Promote to Admin' button on teacher rows"
    - "School admin can promote a teacher to school admin role"
    - "Promoted user immediately has SCHOOL_ADMIN role"
    - "Cannot promote students (button not shown)"
    - "Cannot promote users from other institutions"
  artifacts:
    - path: "lib/actions/organization.ts"
      provides: "Server action for role promotion"
      exports: ["promoteToSchoolAdmin"]
      min_lines: 40
    - path: "app/admin/school/users/SchoolUsersClient.tsx"
      provides: "Promote button in teacher rows"
      min_lines: 500
  key_links:
    - from: "SchoolUsersClient.tsx"
      to: "lib/actions/organization.ts"
      via: "promoteToSchoolAdmin server action call"
      pattern: "promoteToSchoolAdmin"
    - from: "lib/actions/organization.ts"
      to: "prisma.user.update"
      via: "role update with institutionId check"
      pattern: "prisma\\.user\\.update.*role.*SCHOOL_ADMIN"
---

<objective>
Add role promotion functionality for school admins.

Purpose: Enable school admins to promote teachers to school admin role without platform admin intervention.

Output: Server action for role promotion with security checks, UI button in teacher list with confirmation.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-organization/03-RESEARCH.md

# Pattern reference for server actions
@lib/actions/exam-editor.ts (server action pattern with session/permission checks)

# UI to extend
@app/admin/school/users/SchoolUsersClient.tsx
@lib/i18n/dictionaries.ts

# Auth utilities
@lib/api-auth.ts (isSchoolAdmin helper)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create promoteToSchoolAdmin server action</name>
  <files>lib/actions/organization.ts</files>
  <action>
Create new server actions file for organization-related mutations:

```typescript
'use server'

import { getServerSession } from 'next-auth'
import { buildAuthOptions } from '@/lib/auth'
import { prisma } from '@/lib/prisma'
import { cookies } from 'next/headers'
import { revalidatePath } from 'next/cache'

/**
 * Promote a teacher to school admin role.
 * Only school admins can promote users in their own institution.
 * Only teachers can be promoted (not students).
 */
export async function promoteToSchoolAdmin(userId: string): Promise<{ success: boolean; error?: string }> {
  const cookieStore = await cookies()
  const institutionId = cookieStore.get('correcta-institution')?.value

  const authOptions = await buildAuthOptions(institutionId)
  const session = await getServerSession(authOptions)

  // Verify caller is school admin
  if (!session?.user || session.user.role !== 'SCHOOL_ADMIN') {
    return { success: false, error: 'Unauthorized' }
  }

  // Find target user
  const targetUser = await prisma.user.findUnique({
    where: { id: userId },
    select: { id: true, role: true, institutionId: true, name: true, email: true }
  })

  // Verify target user exists and is in same institution
  if (!targetUser) {
    return { success: false, error: 'User not found' }
  }

  if (targetUser.institutionId !== session.user.institutionId) {
    return { success: false, error: 'User not in your institution' }
  }

  // Only teachers can be promoted
  if (targetUser.role !== 'TEACHER') {
    return { success: false, error: 'Can only promote teachers' }
  }

  // Perform the promotion
  await prisma.user.update({
    where: { id: userId },
    data: { role: 'SCHOOL_ADMIN' }
  })

  // Revalidate the users page to reflect the change
  revalidatePath('/admin/school/users')

  return { success: true }
}

/**
 * Demote a school admin back to teacher role.
 * Reserved for future use - currently not exposed in UI.
 * Requires platform admin or special permissions.
 */
export async function demoteToTeacher(userId: string): Promise<{ success: boolean; error?: string }> {
  // Placeholder for future implementation
  // Research recommends: "Allow promotion only; demotion requires platform admin"
  return { success: false, error: 'Demotion not available - contact platform admin' }
}
```

Security checks:
1. Caller must be SCHOOL_ADMIN
2. Target user must exist
3. Target user must be in same institution as caller
4. Target user must currently be TEACHER
5. Uses revalidatePath to refresh UI after mutation
  </action>
  <verify>
File exists at lib/actions/organization.ts with promoteToSchoolAdmin export.
TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>Server action created with proper permission checks and institution scoping.</done>
</task>

<task type="auto">
  <name>Task 2: Add promote button to teacher list UI</name>
  <files>app/admin/school/users/SchoolUsersClient.tsx, lib/i18n/dictionaries.ts</files>
  <action>
Add role promotion UI to SchoolUsersClient:

**Dictionary additions (lib/i18n/dictionaries.ts):**
Add to `admin.school`:
```typescript
rolePromotion: {
  promoteButton: 'Promouvoir Admin',
  promoteConfirmTitle: 'Promouvoir en administrateur',
  promoteConfirmDescription: 'Vous allez promouvoir {{name}} au role d\'administrateur ecole. Cette action lui donnera acces a la gestion des utilisateurs et des classes.',
  promoteConfirmLabel: 'Promouvoir',
  promoteCancelLabel: 'Annuler',
  promoteSuccess: 'Utilisateur promu avec succes',
  promoteError: 'Erreur lors de la promotion',
},
```

**SchoolUsersClient changes:**

1. Import the server action:
```typescript
import { promoteToSchoolAdmin } from '@/lib/actions/organization'
```

2. Add state for promotion flow:
```typescript
const [promoteConfirmOpen, setPromoteConfirmOpen] = useState(false)
const [pendingPromoteUser, setPendingPromoteUser] = useState<{id: string; name: string | null} | null>(null)
const [promoting, setPromoting] = useState(false)
```

3. Add promote button in teacher table rows (only when `activeRole === 'teacher'`):
```tsx
{activeRole === 'teacher' && !archived && (
  <button
    type="button"
    onClick={() => {
      setPendingPromoteUser({ id: user.id, name: user.name })
      setPromoteConfirmOpen(true)
    }}
    className="rounded-md border border-brand-900 px-3 py-1 text-xs font-medium text-brand-900 hover:bg-brand-50"
  >
    {dict.rolePromotion.promoteButton}
  </button>
)}
```

4. Add confirmation modal for promotion:
```tsx
<ConfirmModal
  open={promoteConfirmOpen}
  title={dict.rolePromotion.promoteConfirmTitle}
  description={dict.rolePromotion.promoteConfirmDescription.replace('{{name}}', pendingPromoteUser?.name || dict.unknownName)}
  confirmLabel={dict.rolePromotion.promoteConfirmLabel}
  cancelLabel={dict.rolePromotion.promoteCancelLabel}
  onConfirm={handlePromote}
  onCancel={() => {
    setPromoteConfirmOpen(false)
    setPendingPromoteUser(null)
  }}
/>
```

5. Handle promotion:
```typescript
const handlePromote = async () => {
  if (!pendingPromoteUser) return

  setPromoting(true)
  try {
    const result = await promoteToSchoolAdmin(pendingPromoteUser.id)
    if (result.success) {
      // Remove user from teachers list (they're now a school admin, not shown in this UI)
      setTeachers(prev => prev.filter(t => t.id !== pendingPromoteUser.id))
      router.refresh()
    } else {
      setError(result.error || dict.rolePromotion.promoteError)
    }
  } catch (err) {
    console.error('[Users] Promote failed', err)
    setError(dict.rolePromotion.promoteError)
  } finally {
    setPromoting(false)
    setPromoteConfirmOpen(false)
    setPendingPromoteUser(null)
  }
}
```

**Visual design:**
- Promote button: brand-900 border, appears after Edit and before Archive
- Only visible on non-archived teachers
- Not shown in students tab
- Confirmation modal explains the implications of promotion
  </action>
  <verify>
1. Navigate to /admin/school/users?role=teacher
2. See "Promote Admin" button on teacher rows
3. Click button, see confirmation modal
4. Confirm, verify user is promoted (removed from teacher list)
5. Switch to students tab - no promote button visible
6. Verify promoted user can now access admin functions
  </verify>
  <done>Promote button visible on teachers, confirmation modal works, server action executes, user role updated.</done>
</task>

</tasks>

<verification>
1. Server action exists with security checks
2. Promote button visible only on teacher rows
3. Confirmation modal appears before promotion
4. Promotion updates user role to SCHOOL_ADMIN
5. Promoted user removed from teacher list
6. Cannot promote students (button not shown)
7. Cannot promote users from other institutions (server-side check)
8. Existing edit/archive functionality unchanged
</verification>

<success_criteria>
- School admin sees "Promote Admin" button on teacher "Marie Dupont"
- School admin clicks button, sees confirmation modal
- School admin confirms, Marie is promoted to SCHOOL_ADMIN
- Marie disappears from teacher list (she's now an admin)
- Marie can now access school admin features
- Students don't have promote button
- Teachers from other institutions cannot be promoted (API rejects)
</success_criteria>

<output>
After completion, create `.planning/phases/03-organization/03-03-SUMMARY.md`
</output>
