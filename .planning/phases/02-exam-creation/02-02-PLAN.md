---
phase: 02-exam-creation
plan: 02
type: execute
depends_on:
  - 02-01-PLAN.md
files_modified:
  - components/exam-editor/question-types/QuestionEditorFactory.tsx
  - components/exam-editor/question-types/OpenQuestionEditor.tsx
  - components/exam-editor/question-types/MultipleChoiceEditor.tsx
  - components/exam-editor/store.ts
autonomous: true

must_haves:
  truths:
    - "Teacher can select a question type and see the appropriate editor"
    - "Open questions allow editing text content"
    - "Open questions have a correction guidelines field for AI grading"
    - "MCQ questions allow adding/removing options and marking correct answers"
    - "Validation prevents saving if MCQ has no correct answer"
  artifacts:
    - path: "components/exam-editor/question-types/QuestionEditorFactory.tsx"
      provides: "Switch component to render the correct editor based on type"
    - path: "components/exam-editor/question-types/OpenQuestionEditor.tsx"
      provides: "Editor for open questions with correction guidelines"
    - path: "components/exam-editor/question-types/MultipleChoiceEditor.tsx"
      provides: "Editor for MCQ options and correct answer selection"

key_links:
  - from: "components/exam-editor/ExamEditor.tsx"
    to: "components/exam-editor/question-types/QuestionEditorFactory.tsx"
    via: "renders for active question"
  - from: "components/exam-editor/question-types/OpenQuestionEditor.tsx"
    to: "components/exam-editor/store.ts"
    via: "updates question content and correctionGuidelines"
---

<objective>
Implement the specific editor components for Open and MCQ questions, integrating them into the QuestionEditorFactory.

Purpose: The generic editor shell needs specific components to handle the data structure of different question types (text content vs options list). Open questions also need correction guidelines to enable AI-assisted grading in Phase 4.

Output: Functional editors for Text and MCQ questions that update the global exam store, with correction guidelines for open questions.
</objective>

<execution_context>
@.planning/phases/02-exam-creation/02-02-PLAN.md
@prisma/schema.prisma
</execution_context>

<tasks>

<task type="auto">
  <name>Task 1: Create Question Editor Factory</name>
  <files>components/exam-editor/question-types/QuestionEditorFactory.tsx</files>
  <action>
Create a component that takes a `questionId` (or question object) and renders the specific editor:

1. Props: `question: Question`
2. Logic: Switch on `question.type`
   - `TEXT` -> `<OpenQuestionEditor />`
   - `MCQ` -> `<MultipleChoiceEditor />`
   - `CODE` -> `<div>Not implemented</div>` (Placeholder)
3. Connect to store:
   - Should likely accept `questionId` and pull data from `useExamStore` to ensure it's always in sync.
  </action>
  <verify>
Manual: Create a dummy exam with one Text and one MCQ question. Verify correct component renders for each.
  </verify>
  <done>
Factory correctly routes to sub-editors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Open Question Editor with Correction Guidelines</name>
  <files>components/exam-editor/question-types/OpenQuestionEditor.tsx</files>
  <action>
Create the editor for Open (Text) questions with support for AI grading guidelines:

1. Fields:
   - Question Body (Textarea or Rich Text)
   - Points (Number input)
   - **Correction Guidelines** (Textarea) - NEW for Phase 4 AI grading
     - Label: "Correction Guidelines (for AI grading)"
     - Placeholder: "Describe what a correct answer should include, key points to look for, partial credit criteria..."
     - This field will be used by the AI grader in Phase 4 to evaluate student answers

2. State:
   - Use `useExamStore` actions to update `content`, `points`, and `correctionGuidelines`.
   - Store correctionGuidelines in the question's metadata/content JSON:
     ```typescript
     // Question content structure for TEXT type:
     {
       body: string,           // The question text
       correctionGuidelines: string  // Guidelines for AI grading
     }
     ```
   - Debounce updates to avoid store thrashing if using a heavy rich text editor (though simple textarea is fine for V1).

3. Validation:
   - Show warning if content is empty.
   - Correction guidelines are optional but show a hint: "Adding guidelines improves AI grading accuracy"
  </action>
  <verify>
Manual:
1. Type in the body, switch questions, switch back. Text should persist.
2. Add correction guidelines like "Answer should mention X, Y, Z. Partial credit for mentioning only X."
3. Save and reload - guidelines should persist.
  </verify>
  <done>
Open text questions can be edited with correction guidelines for future AI grading. State is preserved.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement MCQ Editor</name>
  <files>
    components/exam-editor/question-types/MultipleChoiceEditor.tsx
    components/exam-editor/store.ts
  </files>
  <action>
Create the editor for Multiple Choice questions:

1. Schema handling:
   - MCQ options are stored in `JSON` or a specific structure.
   - **Decision**: Store options in `content` as JSON or add a transient `options` field in the store if the DB schema `Question` model doesn't explicitly have `options`.
   - *Check schema*: `Question` has `content`. Convention: For MCQ, `content` is JSON string of `{ text: string, options: { id, text, isCorrect }[] }`.
   - Update `store.ts` to handle parsing/serializing this transparently or handle it in the component.

2. UI:
   - List of options.
   - "Add Option" button.
   - Remove Option button.
   - Checkbox/Radio to mark `isCorrect`.
   - Input for Option Text.

3. Actions:
   - `addOption(questionId)`
   - `removeOption(questionId, index)`
   - `toggleCorrect(questionId, index)`
   - `updateOptionText(questionId, index, text)`
  </action>
  <verify>
Create MCQ. Add 3 options. Mark 2 as correct. Save. Reload. Verify options are preserved.
  </verify>
  <done>
MCQ Editor fully functional with add/remove/edit options logic.
  </done>
</task>

</tasks>

<verification>
1. Create new Exam.
2. Add "Question 1" (Type: TEXT).
3. Type "Explain Quantum Entanglement" in the body.
4. Add correction guidelines: "Should mention superposition, measurement, and non-locality."
5. Add "Question 2" (Type: MCQ).
6. Add options "Yes", "No", "Maybe".
7. Mark "Maybe" as correct.
8. Save Exam.
9. Refresh page.
10. Verify Question 1 has text AND correction guidelines preserved.
11. Verify Question 2 has 3 options and "Maybe" is checked.
</verification>

<success_criteria>
1. Open Question Editor persists text content.
2. Open Question Editor has correction guidelines textarea for AI grading.
3. MCQ Editor allows managing a dynamic list of options.
4. Correct answer selection for MCQ is saved.
</success_criteria>
