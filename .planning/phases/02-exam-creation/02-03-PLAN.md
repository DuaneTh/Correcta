---
phase: 02-exam-creation
plan: 03
type: execute
depends_on: 
  - 02-02-PLAN.md
files_modified:
  - components/ui/ImageUpload.tsx
  - components/exam-editor/RichTextEditor.tsx
  - lib/storage/minio.ts
  - app/api/upload/route.ts
autonomous: true

must_haves:
  truths:
    - "Teacher can upload an image and see it in the question"
    - "Math formulas can be inserted into question text via toolbar"
    - "Images are securely stored in MinIO"
  artifacts:
    - path: "lib/storage/minio.ts"
      provides: "MinIO client configuration and helper functions"
    - path: "components/ui/ImageUpload.tsx"
      provides: "Reusable upload component with drag-and-drop"

key_links:
  - from: "components/exam-editor/question-types/OpenQuestionEditor.tsx"
    to: "components/ui/ImageUpload.tsx"
    via: "embeds upload component"
---

<objective>
Enable rich content creation by integrating Image Upload (MinIO) and the Math Toolbar (Phase 1) into the question editors.

Purpose: Math and Physics exams require diagrams and complex formulas. Text-only is insufficient.

Output: Upgraded editors that support image drag-and-drop and math formula insertion.
</objective>

<execution_context>
@.planning/phases/02-exam-creation/02-03-PLAN.md
@.planning/phases/01-math-foundation/01-01-PLAN.md hiding
</execution_context>

<tasks>

<task type="auto">
  <name>Task 1: Setup MinIO Storage</name>
  <files>
    lib/storage/minio.ts
    app/api/upload/route.ts
  </files>
  <action>
Configure object storage for exam assets:

1. `lib/storage/minio.ts`:
   - Initialize `minio` client using env vars.
   - Function `getPresignedUrl(bucket, key, expiry)` for uploads.
   - Function `deleteObject(bucket, key)`.

2. `app/api/upload/route.ts`:
   - POST endpoint.
   - Authenticated (Teacher usually).
   - Generates and returns a presigned PUT URL for the client to upload directly to MinIO (or proxies the upload if preferred to keep MinIO private).
   - *Decision*: Proxy upload via Next.js API route is simpler for local/docker setups than handling CORS/presigned URLs correctly on localhost sometimes. Let's do **Proxy Upload** for robustness in dev.
   - Logic: Receive FormData -> Buffer -> `minioClient.putObject`.
   - Return public URL of the uploaded file.
  </action>
  <verify>
Use Postman or Curl to POST a file to `/api/upload`. Check MinIO Console to see the file.
  </verify>
  <done>
File upload API is functional.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Image Upload Component</name>
  <files>components/ui/ImageUpload.tsx</files>
  <action>
Create a reusable React component:

1. UI:
   - Drop zone (dashed border).
   - "Click or Drag to Upload" text.
   - Loader during upload.
   - Preview of uploaded image.
   
2. Logic:
   - `onDrop` -> `FormData` -> POST `/api/upload`.
   - On success, call `onChange(url)`.
   
3. Props: `value: string | null`, `onChange: (url: string) => void`.
  </action>
  <verify>
Rent component in a test page. Drag image. Verify it finishes and displays the image.
  </verify>
  <done>
ImageUpload component works.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Math & Media into Editors</name>
  <files>
    components/exam-editor/RichTextEditor.tsx
    components/exam-editor/question-types/OpenQuestionEditor.tsx
  </files>
  <action>
Upgrade the OpenQuestionEditor (and potentially MCQ options) to support rich input:

1. **Math Integration**:
   - Use `MathToolbar` from Phase 1.
   - When symbol clicked -> insert LaTeX at cursor in the text area.
   - *Challenge*: Inserting at cursor in a plain textarea vs a Rich Text Editor.
   - *Approach*: If using markdown/plain text, standard cursor manipulation. If using a library, use its insert method.
   - **Decision**: Stick to **Markdown + Preview** for V1 to keep it robust. Textarea for input, Live Preview below with `react-markdown` + `KaTeX`.
   
2. **Image Integration**:
   - Add "Add Image" button or section in `OpenQuestionEditor`.
   - When image uploaded, append Markdown `![image](url)` to the text.
   
3. **Preview**:
   - Create `components/exam-editor/QuestionPreview.tsx`.
   - Renders Markdown and Math (KaTeX).
  </action>
  <verify>
Open Editor. Click "Fraction" in toolbar -> `\frac{#@}{#0}` inserted. Upload Image -> `![img](...)` inserted. Check Preview -> Math and Image render.
  </verify>
  <done>
Editors support mixed content (Text, Math, Images).
  </done>
</task>

</tasks>

<verification>
1. Edit a Question.
2. Upload a PNG diagram using the new component.
3. Verify the image appears in the preview.
4. Click the "Integral" button on the Math Toolbar.
5. Verify `\int` codes appear in the text area.
6. Verify the integral symbol renders correctly in the preview.
7. Save and reload. Content persists.
</verification>

<success_criteria>
1. Images can be uploaded and displayed.
2. Math symbols can be inserted via toolbar and render correctly.
3. Content is saved as Markdown mixed with LaTeX.
</success_criteria>
