---
phase: 02-exam-creation
plan: 04
type: execute
depends_on:
  - 02-01-PLAN.md
files_modified:
  - app/student/exams/[examId]/take/page.tsx
  - components/exam-taking/ExamPlayer.tsx
  - components/exam-taking/QuestionRenderer.tsx
  - lib/actions/exam-taking.ts
autonomous: true

must_haves:
  truths:
    - "Student can access the exam via a unique URL (or dashboard)"
    - "Exam timer counts down properly"
    - "Answers are autosaved to the server"
    - "Submission locks the attempt"
    - "MCQ questions are auto-scored immediately on submission"
  artifacts:
    - path: "components/exam-taking/ExamPlayer.tsx"
      provides: "Main logic for the student taking the exam (navigation, timer, state)"
    - path: "lib/actions/exam-taking.ts"
      provides: "Secure server actions for storing answers and auto-scoring MCQ"

key_links:
  - from: "components/exam-taking/ExamPlayer.tsx"
    to: "lib/actions/exam-taking.ts"
    via: "calls autosave and submitAttempt"
  - from: "lib/actions/exam-taking.ts submitAttempt"
    to: "MCQ auto-scoring logic"
    via: "scores MCQ answers on submission"
---

<objective>
Build the student-facing "Take Exam" experience with automatic MCQ scoring on submission.

Purpose: Students need a distraction-free, robust interface to answer questions. It must handle network flakiness (autosave) and enforce exam constraints (timer). MCQ questions should be scored immediately to provide instant feedback where possible.

Output: A fully functional exam taking interface with auto-scoring for MCQ questions.
</objective>

<execution_context>
@.planning/phases/02-exam-creation/02-04-PLAN.md
@prisma/schema.prisma
</execution_context>

<tasks>

<task type="auto">
  <name>Task 1: Create Attempt Management Actions with MCQ Auto-Scoring</name>
  <files>lib/actions/exam-taking.ts</files>
  <action>
Backend logic for the exam lifecycle with auto-scoring:

1. `startAttempt(examId: string)`:
   - Check if user already has an active attempt.
   - If not, create new `Attempt` with `startedAt: now()`.
   - Return attempt ID and initialized status.

2. `saveAnswer(attemptId: string, questionId: string, content: any)`:
   - Verify attempt is `IN_PROGRESS`.
   - Upsert `Answer` record.
   - Update `autosavedAt`.
   - Update `Attempt` last activity timestamp.

3. `submitAttempt(attemptId: string)`:
   - Set status to `SUBMITTED`.
   - Set `submittedAt: now()`.
   - **AUTO-SCORE MCQ QUESTIONS**:
     - Fetch all answers for this attempt
     - For each answer where question.type === 'MCQ':
       - Parse the question's content JSON to get correct options (isCorrect: true)
       - Parse the student's answer to get selected options
       - Compare: if selected options match correct options exactly:
         - Set answer.score = question.points
         - Set answer.isAutoScored = true
       - Else:
         - Set answer.score = 0
         - Set answer.isAutoScored = true
     - Update attempt's autoScoredPoints = sum of auto-scored answers
   - For TEXT questions: leave score as null (requires manual/AI grading in Phase 4)
   - Trigger async grading job for TEXT questions (placeholder for Phase 4).

4. Helper function `scoreMultipleChoiceAnswer(question: Question, studentAnswer: any)`:
   - Returns { score: number, isCorrect: boolean }
   - Handles edge cases: no answer, partial selection, etc.
  </action>
  <verify>
Script `scripts/test-attempt-flow.ts`:
1. Start attempt
2. Save answer for MCQ question (select correct option)
3. Save answer for TEXT question
4. Submit attempt
5. Check DB: MCQ answer has score = points, TEXT answer has score = null
6. Check attempt has autoScoredPoints populated
  </verify>
  <done>
Server actions securely handle exam lifecycle with automatic MCQ scoring on submission.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Question Renderer</name>
  <files>components/exam-taking/QuestionRenderer.tsx</files>
  <action>
ReadOnly version of the question components:

1. Props: `question: Question`, `value: any`, `onChange: (val) => void`.
2. Logic:
   - `TEXT`: Render content (Markdown/Math). Render Textarea for student answer.
   - `MCQ`: Render content. Render Radio/Checkbox group for options.
3. Styling:
   - Clear distinction between Question content and Answer area.
  </action>
  <verify>
Manual check with dummy data.
  </verify>
  <done>
Questions render correctly for students.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build Exam Player Shell</name>
  <files>
    app/student/exams/[examId]/take/page.tsx
    components/exam-taking/ExamPlayer.tsx
    components/exam-taking/ExamTimer.tsx
  </files>
  <action>
The main student UI:

1. `page.tsx`:
   - Server Component.
   - Checks permissions.
   - Loads Exam and existing Attempt (if any).
   - If no attempt, shows "Start Exam" cover page.
   - If attempt active, renders `ExamPlayer`.

2. `ExamPlayer.tsx` (Client):
   - Local state for all answers (initialized from server).
   - `useInterval` for Timer (based on `exam.durationMinutes` and `attempt.startedAt`).
   - Sidebar navigation (Question 1, 2, 3...).
   - Main area renders `QuestionRenderer` for current question.
   - **Autosave Logic**: `useEffect` listening to answers changes -> debounce 2s -> call `saveAnswer`.

3. `ExamTimer.tsx`:
   - Visual countdown.
   - Warns when low.
   - Auto-submits when 0.
  </action>
  <verify>
Start exam. Answer Q1. Wait 2s. Reload page. Answer Q1 should be preserved. Wait for timer to expire. Should auto-submit.
  </verify>
  <done>
Exam Player is robust, saves data, and respects time limits.
  </done>
</task>

</tasks>

<verification>
1. Log in as Student.
2. Click "Take Exam" for an exam with 1 TEXT and 1 MCQ question.
3. Verify Timer starts correctly based on settings.
4. Input text for Q1 (TEXT). Check network tab for "saveAnswer" call after delay.
5. Select correct option for Q2 (MCQ).
6. Refresh page.
7. Verify Q1 and Q2 answers are restored.
8. Click "Submit".
9. Verify redirected to "Submission Confirmed" page or summary.
10. Check DB:
    - Attempt status is SUBMITTED
    - MCQ answer (Q2) has score = question.points (auto-scored)
    - TEXT answer (Q1) has score = null (pending manual/AI grading)
    - Attempt has autoScoredPoints reflecting MCQ score
</verification>

<success_criteria>
1. Student can complete a full exam flow (Start -> Answer -> Submit).
2. Data is preserved across page reloads (Autosave).
3. Timer enforces exam duration.
4. MCQ questions are automatically scored on submission with correct/incorrect determined by comparing to correct options.
</success_criteria>
