---
phase: 05-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/exams/[examId]/export/csv/route.ts
  - app/dashboard/exams/[examId]/grading/GradingDashboard.tsx
  - lib/export/csv-generator.ts
autonomous: true

must_haves:
  truths:
    - "Teacher can download CSV with grades for an exam"
    - "CSV contains columns: Etudiant, Email, Q1, Q2, ..., Total, Maximum"
    - "CSV download completes in under 5 seconds for typical exam"
    - "CSV uses semicolon delimiter (French locale)"
  artifacts:
    - path: "lib/export/csv-generator.ts"
      provides: "CSV generation utility using Papaparse"
      exports: ["generateGradesCSV"]
    - path: "app/api/exams/[examId]/export/csv/route.ts"
      provides: "GET endpoint for CSV download"
      exports: ["GET"]
  key_links:
    - from: "app/api/exams/[examId]/export/csv/route.ts"
      to: "lib/export/csv-generator.ts"
      via: "import generateGradesCSV"
      pattern: "generateGradesCSV"
    - from: "GradingDashboard.tsx"
      to: "/api/exams/[examId]/export/csv"
      via: "fetch download"
      pattern: "export/csv"
---

<objective>
Implement CSV export of grades for teachers.

Purpose: Teachers need to download grades in a format compatible with institutional systems (Excel, LMS imports). CSV with semicolon delimiter is standard for French locale.

Output: Working CSV export with one row per student, columns for each question score, and totals.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-export/05-RESEARCH.md

Key existing patterns:
- Papaparse already installed (v5.5.3) - use Papa.unparse for CSV generation
- Grading API pattern in app/api/exams/[examId]/grading/route.ts
- Class hierarchy with parentId for subgroups (Phase 3)
- GradingDashboard.tsx already has disabled export buttons in Actions dropdown
</context>

<tasks>

<task type="auto">
  <name>Task 1: CSV Generator Utility</name>
  <files>lib/export/csv-generator.ts</files>
  <action>
Create CSV generation utility:

1. Create `lib/export/csv-generator.ts`:
```typescript
import Papa from 'papaparse'
import { prisma } from '@/lib/prisma'

interface CSVExportOptions {
  examId: string
  classIds?: string[]  // Optional filter by class/subgroup
}

export async function generateGradesCSV(options: CSVExportOptions): Promise<string> {
  const { examId, classIds } = options

  // Build where clause with optional class filter
  const whereClause: any = {
    examId,
    status: { in: ['GRADED', 'SUBMITTED'] }  // Include submitted for completeness
  }

  if (classIds && classIds.length > 0) {
    // Get all class IDs including subgroups (children)
    const allClassIds = await getClassIdsWithChildren(classIds)
    whereClause.student = {
      enrollments: {
        some: { classId: { in: allClassIds } }
      }
    }
  }

  // Fetch attempts with grades
  const attempts = await prisma.attempt.findMany({
    where: whereClause,
    include: {
      student: { select: { name: true, email: true } },
      answers: {
        include: {
          grades: { select: { score: true } },
          question: {
            select: { id: true, order: true },
            include: {
              section: { select: { order: true } }
            }
          }
        },
        orderBy: [
          { question: { section: { order: 'asc' } } },
          { question: { order: 'asc' } }
        ]
      }
    },
    orderBy: { student: { name: 'asc' } }
  })

  // Get exam max points for header
  const exam = await prisma.exam.findUnique({
    where: { id: examId },
    include: {
      sections: {
        include: {
          questions: {
            select: {
              id: true,
              segments: { select: { maxPoints: true } }
            },
            orderBy: { order: 'asc' }
          }
        },
        orderBy: { order: 'asc' }
      }
    }
  })

  if (!exam) throw new Error('Exam not found')

  // Build question order map and calculate max points
  const questions = exam.sections.flatMap(s => s.questions)
  const questionMaxPoints: Record<string, number> = {}
  let totalMaxPoints = 0

  questions.forEach(q => {
    const maxPts = q.segments.reduce((sum, seg) => sum + (seg.maxPoints ?? 0), 0)
    questionMaxPoints[q.id] = maxPts
    totalMaxPoints += maxPts
  })

  // Transform to CSV rows
  const rows = attempts.map(attempt => {
    const row: Record<string, string | number> = {
      'Etudiant': attempt.student.name || '',
      'Email': attempt.student.email || ''
    }

    let total = 0

    // Add question scores in order
    questions.forEach((q, idx) => {
      const answer = attempt.answers.find(a => a.questionId === q.id)
      const score = answer?.grades[0]?.score
      const colName = `Q${idx + 1}`

      if (score !== undefined && score !== null) {
        row[colName] = score
        total += score
      } else {
        row[colName] = ''  // Not graded yet
      }
    })

    row['Total'] = total
    row['Maximum'] = totalMaxPoints

    return row
  })

  // Generate CSV with semicolon delimiter (French locale)
  return Papa.unparse(rows, {
    header: true,
    delimiter: ';'
  })
}

async function getClassIdsWithChildren(classIds: string[]): Promise<string[]> {
  const classes = await prisma.class.findMany({
    where: {
      OR: [
        { id: { in: classIds } },
        { parentId: { in: classIds } }
      ]
    },
    select: { id: true }
  })
  return classes.map(c => c.id)
}
```

Key decisions:
- Use semicolon delimiter (standard for French Excel)
- Include both GRADED and SUBMITTED attempts (some may be partially graded)
- Order questions by section order then question order
- Empty string for ungraded answers (not 0)
  </action>
  <verify>TypeScript compilation: `npx tsc --noEmit lib/export/csv-generator.ts`</verify>
  <done>CSV generator utility exists and compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: CSV Export API Endpoint</name>
  <files>app/api/exams/[examId]/export/csv/route.ts</files>
  <action>
Create CSV export endpoint:

1. Create `app/api/exams/[examId]/export/csv/route.ts`:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getAuthSession, isTeacher } from '@/lib/api-auth'
import { prisma } from '@/lib/prisma'
import { generateGradesCSV } from '@/lib/export/csv-generator'

// GET /api/exams/[examId]/export/csv - Download grades as CSV
export async function GET(
  req: NextRequest,
  { params }: { params: Promise<{ examId: string }> }
) {
  try {
    const { examId } = await params
    const session = await getAuthSession(req)

    // Auth check: Teacher only
    if (!session || !session.user || !isTeacher(session)) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Verify teacher has access to exam (same institution)
    const exam = await prisma.exam.findUnique({
      where: { id: examId },
      include: {
        course: { select: { institutionId: true } }
      }
    })

    if (!exam) {
      return NextResponse.json({ error: 'Exam not found' }, { status: 404 })
    }

    if (exam.course.institutionId !== session.user.institutionId) {
      return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
    }

    // Optional class filter from query params
    const classId = req.nextUrl.searchParams.get('classId')
    const classIds = classId ? [classId] : undefined

    // Generate CSV
    const csv = await generateGradesCSV({ examId, classIds })

    // Return as downloadable file
    const filename = `notes-${exam.title.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.csv`

    return new Response(csv, {
      headers: {
        'Content-Type': 'text/csv; charset=utf-8',
        'Content-Disposition': `attachment; filename="${filename}"`
      }
    })

  } catch (error) {
    console.error('[API] CSV Export Error:', error)
    return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 })
  }
}
```

Key decisions:
- GET request (no body needed, idempotent download)
- Optional classId query param for filtering
- Filename includes exam title and date
- UTF-8 charset for French characters
  </action>
  <verify>
Start dev server and test:
```bash
curl -v "http://localhost:3000/api/exams/[EXAM_ID]/export/csv" -H "Cookie: ..."
```
Should return CSV content with correct headers
  </verify>
  <done>API endpoint returns CSV file with correct Content-Type and Content-Disposition headers</done>
</task>

<task type="auto">
  <name>Task 3: Wire Export Button in GradingDashboard</name>
  <files>app/dashboard/exams/[examId]/grading/GradingDashboard.tsx</files>
  <action>
Update GradingDashboard to enable CSV export button:

1. In `GradingDashboard.tsx`, find the disabled "Exporter les notes" button in the Actions dropdown (around line 265-272)

2. Replace the disabled button with a working one:
```tsx
<button
  onClick={() => {
    // Trigger CSV download
    const url = `/api/exams/${examId}/export/csv`
    const link = document.createElement('a')
    link.href = url
    link.download = '' // Let server set filename
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    setShowActionsDropdown(false)
  }}
  className="w-full px-4 py-2 text-left text-gray-700 flex items-center gap-2 hover:bg-gray-50"
>
  <FileDown className="w-4 h-4" />
  Exporter les notes (CSV)
</button>
```

3. Keep the "Telecharger rapport" button disabled for now (PDF export in Plan 03)

Note: The download uses a link click approach rather than fetch to properly trigger browser download behavior with Content-Disposition header.
  </action>
  <verify>
1. Visit grading dashboard for an exam with graded submissions
2. Click Actions dropdown
3. Click "Exporter les notes (CSV)"
4. Verify CSV file downloads with correct content (semicolon separated, French headers)
  </verify>
  <done>"Exporter les notes (CSV)" button triggers download of valid CSV file</done>
</task>

</tasks>

<verification>
1. CSV generator compiles: `npx tsc --noEmit lib/export/csv-generator.ts`
2. API endpoint exists and returns 401 for unauthenticated requests
3. Authenticated teacher can download CSV from grading dashboard
4. CSV has correct structure: Etudiant;Email;Q1;Q2;...;Total;Maximum
5. Scores match what's shown in grading UI
</verification>

<success_criteria>
1. Teacher can click "Exporter les notes (CSV)" in grading dashboard Actions menu
2. CSV downloads within 5 seconds for exam with <100 submissions
3. CSV opens correctly in Excel (semicolon delimiter, UTF-8 French characters)
4. Scores in CSV match grades shown in grading interface
</success_criteria>

<output>
After completion, create `.planning/phases/05-export/05-01-SUMMARY.md`
</output>
